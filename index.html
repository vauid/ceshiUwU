<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>章鱼喷墨机</title>
    <meta name="theme-color" content="#FFFFFF"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/nzP9sgxr/chan-125.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link rel="manifest" href="manifest.json">

    <style>
        /* --- 全局与主题样式 --- */
        :root {
            --bg-color: #fce4ec;
            --primary-color: #ff80ab;
            --secondary-color: #f48fb1;
            --accent-color: #90caf9;
            --text-color: #444;
            --white-color: #fff;
            --border-radius: 18px;
            --phone-corner-radius: 0px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --top-pinned-bg: #fff0f5;
            --online-status-color: #4CAF50;
        }

        html {
            height: 100%;
            overflow: hidden;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #fce4ec, #f8bbd0);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            overflow: hidden;
        }

        .phone-screen {
            width: 100%;
            max-width: 420px;
            height: 100%;
            max-height: 850px;
            background-color: var(--white-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: var(--phone-corner-radius);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        .app-header .back-btn,
        .app-header .action-btn {
            background: none;
            border: none;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #cancel-multi-select-btn {
            font-size: 14px !important;
            font-weight: 500 !important;
            color: var(--white-color) !important;
            background-color: var(--primary-color) !important;
            border-radius: 10px !important;
            padding: 5px 10px !important;
            width: auto !important;
            height: auto !important;
        }

        .app-header .action-btn-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-header .action-btn-group .action-btn {
            font-size: 16px;
            font-weight: 600;
            width: auto;
            padding: 6px 12px;
            border-radius: 10px;
        }

        .app-header .action-btn-group #create-group-btn {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .app-header .action-btn-group #add-chat-btn {
            font-size: 28px;
            padding: 0;
            width: 40px;
            height: 40px;
            background-color: transparent;
            color: var(--primary-color);
            border-radius: 50%;
        }

        .app-header .action-btn img {
            width: 28px;
            height: 28px;
        }

        .app-header .title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .app-header .title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }

        .app-header .subtitle {
            font-size: 12px;
            color: #888;
            display: flex;
            align-items: center;
            margin-top: 2px;
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--online-status-color);
            margin-right: 5px;
        }

        .app-header .placeholder {
            width: 40px;
        }

        #home-screen {
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
            padding: 50px 0;
            /* New styles for swipe functionality */
           flex-direction: column;
           overflow: hidden; /* Hide overflow for the swiper */
        }
       .home-screen-swiper {
           display: flex;
           width: 200%; /* Two pages */
           flex: 1;
           overflow: hidden;
           transition: transform 0.4s ease-in-out;
       }
       .home-screen-page {
           width: 50%;
           display: flex;
           flex-direction: column;
           justify-content: flex-start;
           align-items: center;
       }
       .page-indicator {
           position: absolute;
           bottom: 160px; /* Adjust based on dock height */
           left: 50%;
           transform: translateX(-50%);
           display: flex;
           gap: 8px;
       }
       .page-indicator .dot {
           width: 8px;
           height: 8px;
           border-radius: 50%;
           background-color: rgba(0, 0, 0, 0.25); /* 浅灰色 */
           transition: background-color 0.3s;
       }
       .page-indicator .dot.active {
           background-color: rgba(0, 0, 0, 0.374); /* 深灰色 */
       }


        #home-screen.day-mode .satellite-oval,
        #home-screen.day-mode .widget-time,
        #home-screen.day-mode .widget-date,
        #home-screen.day-mode .widget-battery,
        #home-screen.day-mode .widget-signature,
        #home-screen.day-mode .app-icon .app-name {
            color: var(--white-color);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        .app-grid {
            width: 100%;
            padding: 20px 40px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            justify-content: center;
            align-content: center;
            margin-top: 70px;
        }

        #peek-screen .time-widget,
        #peek-screen .time-widget .date,
        #peek-screen .app-icon .app-name {
            color: var(--white-color);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        #peek-screen .time-widget {
            text-align: center;
            margin-bottom: 40px;
        }

        #peek-screen .time-widget .time {
            font-size: 72px;
            font-weight: 200;
            letter-spacing: 2px;
            line-height: 1;
        }

        #peek-screen .time-widget .date {
            font-size: 18px;
            font-weight: 400;
            opacity: 0.8;
            margin-top: 8px;
        }

        #peek-screen .app-grid {
            margin-top: 20px;
        }

        .dock {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background-color: transparent;
            backdrop-filter: none;
            border-radius: var(--border-radius);
            margin: 0 20px;
            min-height: 80px;
            gap: 15px;
            flex-shrink: 0;
        }

        .app-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            text-decoration: none;
        }

        .icon-img {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            margin-bottom: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
            object-fit: cover;
        }

        .app-icon:hover .icon-img {
            transform: translateY(-5px);
        }

        .app-icon .app-name {
            font-size: 12px;
            color: var(--text-color);
            font-weight: 500;
        }


        .content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        .placeholder-text {
            text-align: center;
            color: #aaa;
            margin-top: 50px;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-window {
            background: var(--white-color);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            width: 85%;
            max-width: 340px;
            animation: slideUp 0.4s ease-out;
        }

        .modal-window h3 {
            margin-top: 0;
            text-align: center;
            color: var(--primary-color);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #edit-group-member-modal,
        #create-member-for-group-modal {
            z-index: 102;
        }

        #edit-group-member-modal .avatar-preview,
        #create-member-for-group-modal .avatar-preview {
            width: 80px;
            height: 80px;
        }

        .context-menu {
            position: fixed;
            z-index: 1000;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            padding: 5px 0;
            animation: fadeIn 0.1s ease;
        }

        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
        }

        .context-menu-item:hover {
            background-color: #f5f5f5;
        }

        .context-menu-item.danger {
            color: #e53935;
        }

        .action-sheet-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 200;
            display: none;
            align-items: flex-end;
            animation: fadeIn 0.3s ease;
        }

        .action-sheet-overlay.visible {
            display: flex;
        }

        .action-sheet {
            background: #f7f7f7;
            width: 100%;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease-out;
        }

        .action-sheet-button {
            width: 100%;
            background: white;
            border: none;
            padding: 15px;
            font-size: 16px;
            color: var(--primary-color);
            font-weight: 500;
            cursor: pointer;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .action-sheet-button.danger {
            color: #e53935;
        }

        .action-sheet-button:last-child {
            margin-bottom: 0;
        }

        #chat-list-screen .content,
        #world-book-screen .content {
            padding: 10px 0 0 0;
        }

        .list-container {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .list-item:hover {
            background-color: #fdf6f8;
        }

        .chat-item.pinned {
            background-color: var(--top-pinned-bg);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            flex-shrink: 0;
            background-color: #eee;
        }

        .group-avatar {
            border-radius: 10px;
        }

        .item-details {
            flex-grow: 1;
            overflow: hidden;
        }

        .item-details-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-name {
            font-weight: 600;
            color: var(--text-color);
            font-size: 16px;
        }

        .item-preview-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .item-preview {
            font-size: 14px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }

        .pin-badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        #chat-room-screen {
            background-size: cover;
            background-position: center;
        }

        #chat-room-screen .content {
            display: flex;
            flex-direction: column;
            padding: 10px;
            padding-bottom: 10px;
            transition: padding-bottom 0.3s ease;
        }

        #chat-room-screen.multi-select-active .content {
            padding-bottom: 70px;
        }

        .message-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 10px;
            scroll-behavior: smooth;
        }

        .message-wrapper {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
            transition: background-color 0.2s;
            flex-direction: column;
        }

        .message-wrapper.group-message {
            margin-bottom: 18px;
        }

        .message-wrapper.sent {
            align-items: flex-end;
        }

        .message-wrapper.received {
            align-items: flex-start;
        }

        .message-wrapper.system-notification {
            align-items: center;
        }

        .message-bubble-row {
            display: flex;
            width: 100%;
            align-items: flex-start;
        }

        .message-wrapper.sent .message-bubble-row {
            flex-direction: row-reverse;
        }

        .message-wrapper.multi-select-selected {
            background-color: rgba(144, 202, 249, 0.2);
            border-radius: var(--border-radius);
        }

        .message-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .group-nickname {
            position: absolute;
            top: -15px;
            font-size: 11px;
            color: #888;
            white-space: nowrap;
            width: 70px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-time {
            font-size: 9px;
            color: #aaa;
            margin-top: 3px;
        }

        .message-bubble {
            max-width: 260px;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            line-height: 1.4;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            margin: 0 8px;
            cursor: pointer;
            font-size: 15px;
        }

        .message-bubble.sent {
            border-bottom-right-radius: 5px;
        }

        .message-bubble.received {
            border-bottom-left-radius: 5px;
        }

        .system-notification-bubble {
            background-color: rgba(200, 200, 200, 0.5);
            color: #666;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 10px;
            text-align: center;
        }

        .image-bubble {
            max-width: 120px;
            border-radius: var(--border-radius);
            margin: 0 8px;
            padding: 4px;
            background-color: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .image-bubble img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: calc(var(--border-radius) - 4px);
        }

        .message-wrapper.sent .image-bubble {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .image-bubble {
            border-bottom-left-radius: 5px;
        }

        .voice-bubble {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            margin: 0 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 90px;
            max-width: 200px;
        }

        .message-wrapper.sent .voice-bubble {
            border-bottom-right-radius: 5px;
            flex-direction: row-reverse;
        }

        .message-wrapper.received .voice-bubble {
            border-bottom-left-radius: 5px;
        }

        .voice-bubble .play-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .voice-bubble .duration {
            font-size: 13px;
            margin: 0 8px;
            white-space: nowrap;
        }

        .message-wrapper.sent .play-icon {
            transform: scaleX(-1);
        }

        .voice-transcript {
            font-size: 14px;
            color: #555;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 8px 12px;
            margin-top: 5px;
            margin-left: 54px;
            margin-right: 54px;
            border-radius: 10px;
            line-height: 1.6;
            max-width: calc(100% - 108px);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .voice-transcript.active {
            display: block;
        }

        .message-wrapper.sent .voice-transcript {
            align-self: flex-end;
            margin-right: 54px;
            margin-left: auto;
        }

        .message-wrapper.received .voice-transcript {
            align-self: flex-start;
            margin-left: 54px;
            margin-right: auto;
        }

        .pv-card {
            width: 230px;
            aspect-ratio: 1 / 1;
            background-color: #f0f0f0;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            cursor: pointer;
            margin: 0 8px;
        }

        .message-wrapper.sent .pv-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .pv-card {
            border-bottom-left-radius: 5px;
        }

        .pv-card-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            transition: opacity 0.5s ease-in-out;
            z-index: 2;
        }

        .pv-card-image-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .pv-card-content {
            padding: 15px;
            height: 100%;
            overflow-y: auto;
            color: var(--text-color);
            line-height: 1.6;
            font-size: 15px;
            background-color: white;
            position: relative;
            z-index: 1;
        }

        .pv-card-footer {
            background: linear-gradient(to top, rgba(0, 0, 0, 0.6), transparent);
            color: white;
            padding: 20px 10px 8px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 3;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }

        .pv-card-footer.hidden {
            opacity: 0;
        }

        .pv-card-footer svg {
            width: 14px;
            height: 14px;
            fill: white;
            flex-shrink: 0;
        }

        .transfer-card {
            width: 240px;
            height: auto;
            border-radius: var(--border-radius);
            margin: 0 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
        }

        .message-wrapper.sent .transfer-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .transfer-card {
            border-bottom-left-radius: 5px;
            cursor: pointer;
        }

        .transfer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            filter: blur(4px);
            transform: scale(1.1);
            z-index: 1;
        }

        .transfer-card.sent-transfer::before {
            background-image: url('https://i.postimg.cc/sxN893WF/IMG-20250712.png');
        }

        .transfer-card.received-transfer::before {
            background-image: url('https://i.postimg.cc/FzR8LY7g/IMG-20250712-170703.png');
        }

        .transfer-card .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 2;
            transition: background-color 0.5s ease;
        }

        .transfer-card.received .overlay {
            background-color: rgba(255, 182, 193, 0.4);
        }

        .transfer-card.returned .overlay {
            background-color: rgba(100, 100, 100, 0.5);
        }

        .transfer-content {
            position: relative;
            z-index: 3;
            padding: 20px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .transfer-title {
            font-size: 14px;
            margin: 0 0 5px 0;
            opacity: 0.9;
        }

        .transfer-amount {
            font-size: 28px;
            font-weight: bold;
            margin: 0;
        }

        .transfer-remark {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .transfer-status {
            font-size: 12px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            opacity: 0.8;
        }

        .gift-card {
            width: 230px;
            background-color: #fff;
            border: 2px solid #333;
            border-radius: var(--border-radius);
            box-shadow: 4px 4px 0px #ddd;
            padding: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            margin: 0 8px;
            position: relative;
            overflow: hidden;
        }

        .message-wrapper.sent .gift-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .gift-card {
            border-bottom-left-radius: 5px;
        }

        .gift-card-icon {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .gift-card-text {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;
        }

        .gift-card-description {
            font-size: 14px;
            color: #555;
            background-color: rgba(240, 240, 240, 0.9);
            padding: 8px 12px;
            margin-top: 5px;
            margin-left: 54px;
            margin-right: 54px;
            border-radius: 10px;
            line-height: 1.6;
            max-width: calc(100% - 108px);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .gift-card-description.active {
            display: block;
        }

        .message-wrapper.sent .gift-card-description {
            align-self: flex-end;
            margin-right: 54px;
            margin-left: auto;
        }

        .message-wrapper.received .gift-card-description {
            align-self: flex-start;
            margin-left: 54px;
            margin-right: auto;
        }

        .gift-card-received-stamp {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 2px 6px;
            transform: rotate(15deg);
            opacity: 0;
            transition: opacity 0.3s ease;
            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;
        }

        .gift-card.received .gift-card-received-stamp {
            opacity: 1;
        }

        .load-more-btn {
            background-color: #e0e0e0;
            color: #757575;
            border: none;
            padding: 8px 16px;
            margin: 10px auto;
            border-radius: 15px;
            cursor: pointer;
            display: block;
            font-size: 13px;
            font-weight: 500;
        }

        .load-more-btn:hover {
            background-color: #d1d1d1;
        }

        .typing-indicator {
            text-align: center;
            color: #aaa;
            font-style: italic;
            font-size: 14px;
            padding: 10px 0;
            display: none;
        }

        #sticker-bar {
            flex-shrink: 0;
            padding: 0 10px 5px;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            gap: 2px; /* 修改：将间距从 5px 缩小到 2px */
            overflow-x: auto; /* 新增：允许内容超出时横向滚动 */
            flex-wrap: nowrap; /* 新增：确保所有按钮在同一行，不换行 */
}

/* (可选) 新增：为了在某些浏览器上获得更好的视觉效果，可以隐藏滚动条 */
#sticker-bar::-webkit-scrollbar {
    display: none; /* 隐藏滚动条本身 */
}


        .sticker-bar-btn {
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
        }

        .sticker-bar-btn svg {
            width: 28px;
            height: 28px;
            fill: #888;
        }

        #sticker-modal, #chat-expansion-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 35%;
            max-height: 250px;
            background: #f7f7f7;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            z-index: 25;
            display: none;
            flex-direction: column;
        }

        #sticker-modal.visible, #chat-expansion-panel.visible {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        #sticker-modal .header {
            padding: 10px 15px;
            font-weight: bold;
            color: var(--text-color);
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sticker-grid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px;
        }

        .sticker-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        .sticker-item.is-managing {
            cursor: pointer;
        }

        .sticker-item.is-selected::after {
            content: '✓';
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: var(--primary-color);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .sticker-item.is-managing:not(.is-selected)::before {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #ccc;
            background-color: rgba(255, 255, 255, 0.8);
        }
        .sticker-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .sticker-item span {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        #add-sticker-modal .modal-window {
            max-width: 360px;
        }

        #sticker-preview {
            width: 100px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            background-color: #f9f9f9;
        }

        #sticker-preview img {
            max-width: 100%;
            max-height: 100%;
        }

        .chat-input-wrapper {
            flex-shrink: 0;
        }

        .message-input-area {
            display: flex;
            align-items: center;
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            border-top: 1px solid #eee;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            gap: 10px;
            border-bottom-left-radius: var(--phone-corner-radius);
            border-bottom-right-radius: var(--phone-corner-radius);
            overflow: hidden;
        }

        .message-input-area input {
            flex-grow: 1;
            border: none;
            padding: 12px;
            border-radius: 18px;
            background-color: #f0f0f0;
        }

        .message-input-area input:focus {
            outline: none;
        }

        .message-input-area .icon-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .message-input-area .icon-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .message-input-area .icon-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .message-input-area .icon-btn.send-btn {
            font-size: 18px;
        }

        #multi-select-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: transparent;
            backdrop-filter: none;
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            border-top: 1px solid #eee;
            z-index: 20;
            border-bottom-left-radius: var(--phone-corner-radius);
            border-bottom-right-radius: var(--phone-corner-radius);
            animation: slideUp 0.3s ease-out;
        }

        #multi-select-bar.visible {
            display: flex;
        }

        .settings-sidebar {
            position: absolute;
            top: 0;
            right: -100%;
            width: 80%;
            height: 100%;
            background: #fff;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            transition: right 0.4s ease-in-out;
            z-index: 101;
            display: flex;
            flex-direction: column;
        }

        .settings-sidebar.open {
            right: 0;
        }

        .settings-sidebar .header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            text-align: center;
            color: var(--primary-color);
        }

        .settings-sidebar .content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .settings-sidebar .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .settings-sidebar .avatar-setting {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .settings-sidebar .avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #fce4ec;
            border-radius: 10px;
            background-color: #fff;
            transition: border-color 0.3s;
            font-family: var(--font-family);
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group.radio-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .form-group.radio-group label {
            margin-bottom: 0;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 4px 15px rgba(255, 128, 171, 0.5);
        }

        label.btn-primary {
            color: var(--white-color) !important;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .btn-secondary {
            background-color: var(--accent-color);
            color: var(--white-color);
            margin-bottom: 15px;
        }

        .btn-secondary:hover {
            background-color: #64b5f6;
            box-shadow: 0 4px 15px rgba(144, 202, 249, 0.5);
        }

        .btn-neutral {
            background-color: #bdbdbd;
            color: var(--white-color);
        }

        .btn-neutral:hover {
            background-color: #9e9e9e;
        }

        .btn-danger {
            background-color: #ef5350;
            color: white;
        }

        .btn .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: var(--white-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .btn.loading .spinner {
            display: block;
        }

        .btn.loading .btn-text {
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .wallpaper-preview {
            width: 100%;
            aspect-ratio: 9 / 16;
            max-height: 400px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            background-size: cover;
            background-position: center;
            border: 3px dashed var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            font-style: italic;
            background-color: #fff8fa;
        }

        .toast {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 14px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            visibility: visible;
        }

        #world-book-selection-modal,
        #invite-member-modal,
        #group-recipient-selection-modal {
            z-index: 102;
        }

        #world-book-selection-modal .modal-window,
        #invite-member-modal .modal-window,
        #group-recipient-selection-modal .modal-window {
            width: 90%;
            max-width: 380px;
        }

        #world-book-selection-list,
        #invite-member-selection-list,
        #group-recipient-selection-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 40vh;
            overflow-y: auto;
        }

        .world-book-select-item,
        .invite-member-select-item,
        .group-recipient-select-item {
            display: flex;
            align-items: center;
            padding: 12px 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        .world-book-select-item:last-child,
        .invite-member-select-item:last-child,
        .group-recipient-select-item:last-child {
            border-bottom: none;
        }

        .world-book-select-item input[type="checkbox"],
        .invite-member-select-item input[type="checkbox"],
        .group-recipient-select-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
        }

        .world-book-select-item label,
        .invite-member-select-item label,
        .group-recipient-select-item label {
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .invite-member-select-item img,
        .group-recipient-select-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* --- Group Chat Specific Styles --- */
        .member-selection-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
            max-height: 40vh;
            overflow-y: auto;
        }

        .member-selection-item {
            display: flex;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        .member-selection-item:last-child {
            border-bottom: none;
        }

        .member-selection-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .member-selection-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

        .member-selection-item label {
            font-weight: 500;
            color: var(--text-color);
        }

        #group-settings-sidebar .group-avatar-setting {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        #group-settings-sidebar .group-avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            cursor: pointer;
        }

        #group-settings-sidebar .group-members-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        #group-settings-sidebar .group-member,
        #group-settings-sidebar .add-member-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        #group-settings-sidebar .group-member img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 5px;
            border: 2px solid #eee;
        }

        #group-settings-sidebar .add-member-btn .add-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #ccc;
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }

        #group-settings-sidebar .add-member-btn:hover .add-icon {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        #group-settings-sidebar .group-member span,
        #group-settings-sidebar .add-member-btn span {
            font-size: 12px;
            text-align: center;
            color: var(--text-color);
        }

        #customize-screen .icon-custom-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        #customize-screen .icon-custom-item:last-child {
            border-bottom: none;
        }

        #customize-screen .icon-preview {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
        }

        #customize-screen .icon-details {
            flex-grow: 1;
        }

        #customize-screen .icon-details p {
            margin: 0 0 8px 0;
            font-weight: 600;
        }

        #customize-screen .icon-details input {
            width: calc(100% - 70px);
        }

        #customize-screen .reset-icon-btn {
            background: #e0e0e0;
            color: #555;
            border: none;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }

        #peek-app-icons-settings .icon-preview {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
        }

        /* 主页自定义小部件样式 (*/
.home-widget-container {
    position: relative;
    width: 230px; /* 增加了容器宽度，给加宽后的小椭圆留出空间 */
    height: 150px;
    margin: 10px auto 30px; /* 稍微增加顶部距离 */
    display: flex;
    justify-content: center;
    align-items: center;
}

.central-circle {
    width: 95px;
    height: 95px;
    border-radius: 50%;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    background-size: cover;
    background-position: center;
    transition: transform 0.3s ease;
}
.central-circle:hover {
    transform: scale(1.05);
}

/* 这是旁边4个小椭圆的通用样式 (美化版) */
.satellite-oval {
    position: absolute;
    width: 135px; /* 宽度 */
    height: 45px; /* 高度 */
    background-color: rgba(255, 255, 255, 0.2); /* 背景 */
    backdrop-filter: blur(8px);
    border-radius: 18px; /* 边缘圆角 */
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08); /* 阴影 */
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: flex-start;
    padding: 0 8px; /* 内边距 */
    gap: 10px; /* 图片和文字之间的空隙 */
    font-size: 11px; /* 字体大小 */
    color: var(--text-color);
    font-weight: 405; /* 字体粗细 */
    transition: all 0.3s ease;
    overflow: hidden;
}
.satellite-oval:hover {
    transform: scale(1.08);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.satellite-oval img {
    width: 32px; /* 图片也稍微大一点 */
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 0; /* 去掉之前的下边距 */
    flex-shrink: 0; /* 防止图片被文字挤压变形 */
}

/* 新增对文字的样式控制 */
.satellite-oval span {
    flex-grow: 1; /* 让文字占据所有剩余空间 */
    text-align: left; /* 文字左对齐 */
    line-height: 1.4; /* 调整行高，让多行文字更好看 */
    white-space: normal; /* 允许文字换行 */
}

/* 分别定义4个小椭圆的位置 (调整了位置以适应新宽度) */
.oval-top-left {
    top: 20px; /* 向上移一点 */
    left: -62px; /* 向左移更多 */
}
.oval-top-right {
    top: 20px;
    right: -62px;
}
.oval-bottom-left {
    bottom: 20px; /* 向下移一点 */
    left: -62px;
}
.oval-bottom-right {
    bottom: 20px;
    right: -62px;
}

/* --- 电池小部件的样式 --- */
.widget-battery {
    color: #666; /* 字体颜色，和日期保持一致 */
    font-family: var(--font-family);
    text-shadow: 0 5px 3px rgba(0,0,0,0.1);
    font-size: 17px; /* 字体大小，和日期保持一致 */

    position: absolute; /* 绝对定位 */
    display: flex; /* 使用flex布局让图标和文字对齐 */
    align-items: center; /* 垂直居中对齐 */

    /* 电池的位置 */
    /* 我们把它放在右下角椭圆的下面，和日期对称 */
    bottom: -15px; /* 高低 */
    right: -45px; /* 左右 */
}

/* 电池图标和文字之间的间距 */
.widget-battery svg {
    margin-right: 5px;
}


/* --- 时间和日期的样式 --- */

.widget-time {
    color: var(--text-color); /* 字体颜色 */
    font-family: var(--font-family);
    text-shadow: 0 1px 2px rgba(0,0,0,0.1); /* 加一点点阴影，更有质感 */

    position: absolute;
    left: 50%; /* 先把它推到容器中间 */
    transform: translateX(-50%);
    bottom: -20px; /* 数字越大越往上，越小越往下，甚至可以是负数哦 */

    /* 时间的字体大小 */
    font-size: 25px;
    font-weight: 600; /* 字体粗细 */
}

.widget-signature {
    color: var(--text-color);
    font-family: var(--font-family);
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: -50px; /* Position it below the time widget */
    font-size: 14px;
    font-weight: 500;
    width: 90%;
    max-width: 300px;
    background-color: transparent;
    border: none;
    outline: none;
    text-align: center;
    padding: 5px;
    border-radius: 8px;
    transition: background-color 0.3s;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.widget-signature:focus {
    background-color: rgba(0, 0, 0, 0.05);
    white-space: normal;
    overflow: visible;
}

.widget-signature:empty::before {
    content: attr(placeholder);
    color: #999;
    pointer-events: none;
}

#home-screen.day-mode .widget-signature:focus {
     background-color: rgba(255, 255, 255, 0.1);
}

#home-screen.day-mode .widget-signature:empty::before {
    color: rgba(255, 255, 255, 0.7);
}

.widget-date {
    color: #666; /* 日期的颜色，淡一点 */
    font-family: var(--font-family);
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);

    position: absolute; /* 同样用绝对定位 */
    width: 130px; /*
    text-align: center; /* 文字居中对齐 */

    /* 日期的位置 */
    /* 我们把它放在左下角椭圆的下面 */
    bottom: -15px; /* 高低 */
    left: -45px; /*左右 */

    /* 这个是日期的字体大小 */
    font-size: 15px;
}
        /* --- Tutorial Screen Styles --- */
        .tutorial-item {
            margin-bottom: 15px;
            border: 1px solid #fce4ec;
            border-radius: 12px;
            overflow: hidden;
            background-color: #fff8fa;
        }

        .tutorial-header {
            padding: 12px 18px;
            font-weight: 600;
            color: var(--secondary-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tutorial-header::after {
            content: '▼';
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .tutorial-item.open .tutorial-header::after {
            transform: rotate(180deg);
        }

        .tutorial-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease;
            padding: 0 10px;
        }

        .tutorial-item.open .tutorial-content {
            padding: 10px 10px;
            /* A large value to ensure it expands to fit the content */
            max-height: 5000px;
        }

        .tutorial-content img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

    /* --- Peek Unlock Screen (Social Media) --- */
    #peek-unlock-screen {
        background-color: #fff;
        color: #262626;
    }

    #peek-unlock-screen .app-header .title,
    #peek-unlock-screen .app-header .back-btn,
    #peek-unlock-screen .app-header .action-btn {
        color: #262626;
    }

    #peek-unlock-screen .content {
        padding: 0;
    }

    .unlock-profile-header {
        display: flex;
        align-items: center;
        padding: 16px;
    }

    .unlock-profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin-right: 28px;
        object-fit: cover;
    }

    .unlock-profile-info {
        flex-grow: 1;
    }

    .unlock-profile-username {
        font-size: 22px;
        font-weight: 300;
        margin: 0 0 4px 0;
    }

    .unlock-profile-handle {
        font-size: 14px;
        color: #8e8e8e;
        margin: 0;
    }

    .unlock-profile-bio {
        padding: 0 16px 16px;
        font-size: 14px;
        line-height: 1.4;
    }

    .unlock-profile-stats {
        display: flex;
        justify-content: space-around;
        text-align: center;
        padding: 12px 0;
        border-top: 1px solid #efefef;
        border-bottom: 1px solid #efefef;
    }

    .unlock-profile-stat {
        font-size: 14px;
    }

    .unlock-profile-stat .count {
        font-weight: 600;
        display: block;
    }

    .unlock-profile-stat .label {
        color: #8e8e8e;
    }

    .unlock-post-feed {
        padding: 0;
        background-color: #f9f9f9;
    }

    .unlock-post-card {
        background-color: #fff;
        border-bottom: 1px solid #efefef;
        padding: 16px;
    }

    .unlock-post-card-header {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }

    .unlock-post-card-header img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
    }

    .unlock-post-card-author-info {
        display: flex;
        flex-direction: column;
    }

    .unlock-post-card-author-info .username {
        font-weight: 600;
        font-size: 15px;
    }

    .unlock-post-card-author-info .timestamp {
        font-size: 12px;
        color: #8e8e8e;
    }

    .unlock-post-card-content {
        font-size: 15px;
        line-height: 1.6;
        margin-bottom: 12px;
    }


    .unlock-post-card-actions {
        display: flex;
        justify-content: space-around;
        color: #8e8e8e;
        font-size: 13px;
        padding-top: 12px;
        border-top: 1px solid #f5f5f5;
    }

    .unlock-post-card-actions .action {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .unlock-post-card-actions .action svg {
        width: 20px;
        height: 20px;
        fill: #8e8e8e;
    }

    /* --- Peek Album Styles (偷看相册样式) --- */
    .album-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 2px;
        padding: 2px;
    }

    .album-photo {
        position: relative;
        width: 100%;
        padding-bottom: 100%; /* 1:1 Aspect Ratio */
        background-color: #e9ecef;
        cursor: pointer;
    }

    .album-photo img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .video-indicator {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .video-indicator svg {
        width: 14px;
        height: 14px;
        fill: white;
        margin-left: 2px;
    }

    #peek-photo-modal .modal-window {
        width: 90%;
        max-width: 420px; /* 确保弹窗不会超过手机屏幕宽度 */
        padding: 15px;
        background-color: #fff;
        border-radius: 15px;
    }

    #peek-photo-image-container {
        width: 100%;
        max-height: 70vh;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        background-color: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
    }

    #peek-photo-image-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    #peek-photo-description {
        font-size: 15px;
        line-height: 1.6;
        color: #333;
        text-align: left;
        white-space: pre-wrap;
        padding: 0 5px 5px 5px;
        border-top: 1px solid #eee;
        margin-top: 15px;
        padding-top: 15px;
    }
        /* Peek Screen Specific Styles */
        #peek-messages-screen .list-item:hover,
        #peek-conversation-screen {
            background-color: #f8f9fa;
        }

        #peek-messages-screen .app-header,
        #peek-conversation-screen .app-header {
            background-color: rgba(248, 249, 250, 0.85);
            border-bottom-color: rgba(0, 0, 0, 0.08);
        }

        #peek-messages-screen .back-btn,
        #peek-conversation-screen .back-btn,
        #peek-messages-screen .title,
        #peek-conversation-screen .title {
            color: #212529;
        }

        #peek-messages-screen .chat-avatar {
            border-radius: 12px;
        }

        #peek-messages-screen .app-header .action-btn,
        #peek-conversation-screen .app-header .action-btn,
        #peek-cart-screen .app-header .action-btn,
        #peek-transfer-station-screen .app-header .action-btn,
        #peek-browser-screen .app-header .action-btn,
        #peek-drafts-screen .app-header .action-btn {
            color: #212529;
        }

        #peek-conversation-screen .message-bubble {
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #peek-conversation-screen .message-bubble.received {
            background-color: #e9ecef;
            color: #343a40;
        }

        #peek-conversation-screen .message-bubble.sent {
            background-color: #007bff;
            color: white;
        }

        /* --- Peek Memos Screen --- */
        #peek-memos-screen {
            background-color: #f9f9f9;
        }

        #peek-memos-screen .app-header .title,
        #peek-memos-screen .app-header .back-btn,
        #peek-memos-screen .app-header .action-btn {
            color: #212529;
        }

        #peek-memos-screen .content {
            padding: 0;
        }

        #peek-memos-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .memo-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .memo-item:hover {
            background-color: #f0f0f0;
        }

        .memo-item-title {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            margin: 0 0 5px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .memo-item-preview {
            font-size: 14px;
            color: #777;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Peek Memo Detail Screen --- */
        #peek-memo-detail-screen {
            background-color: #fff;
        }

        #peek-memo-detail-screen .app-header .title,
        #peek-memo-detail-screen .app-header .back-btn,
        #peek-memo-detail-screen .app-header .action-btn {
            color: #212529;
        }
        
        #peek-memo-detail-screen .content {
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        #memo-title-input {
            border: none;
            padding: 20px;
            font-size: 22px;
            font-weight: bold;
            outline: none;
            border-bottom: 1px solid #eee;
        }

        #memo-content-textarea {
            flex-grow: 1;
            border: none;
            padding: 20px;
            font-size: 16px;
            line-height: 1.6;
            outline: none;
            resize: none;
            font-family: var(--font-family);
        }

        /* --- Peek Cart Screen --- */
        #peek-cart-screen {
            background-color: #f8f9fa;
        }

        #peek-cart-screen .app-header .title,
        #peek-cart-screen .app-header .back-btn {
            color: #212529;
        }

        #peek-cart-screen .content {
            padding: 0;
        }

        .cart-item-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background-color: #fff;
            border-bottom: 1px solid #eee;
        }

        .cart-item-image {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
            margin-right: 15px;
            background-color: #eee;
        }

        .cart-item-details {
            flex-grow: 1;
        }

        .cart-item-title {
            font-weight: 600;
            font-size: 15px;
            color: #333;
            margin: 0 0 5px 0;
        }

        .cart-item-spec {
            font-size: 13px;
            color: #888;
            margin-bottom: 8px;
        }

        .cart-item-price {
            font-size: 16px;
            font-weight: bold;
            color: #e53935;
        }
        
        .cart-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            background-color: #fff;
            border-top: 1px solid #eee;
            flex-shrink: 0;
        }

        .cart-total-price {
            font-size: 18px;
            font-weight: bold;
            color: #e53935;
        }
        
        .cart-total-price .label {
            font-size: 14px;
            font-weight: normal;
            color: #333;
        }

        .checkout-btn {
            background-color: #e53935;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        /* --- Peek Transfer Station Screen --- */
        #peek-transfer-station-screen {
            background-color: #ededed; /* WeChat-like background */
        }

        #peek-transfer-station-screen .app-header {
            background-color: #ededed;
            border-bottom: 1px solid #dcdcdc;
        }

        #peek-transfer-station-screen .app-header .title,
        #peek-transfer-station-screen .app-header .back-btn {
            color: #000;
        }

        #peek-transfer-station-screen .content {
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        .transfer-station-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .transfer-station-input-area {
            flex-shrink: 0;
            padding: 8px;
            background-color: #f7f7f7;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
        }

        .transfer-station-input-area .fake-input {
            flex-grow: 1;
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            height: 36px;
        }

        .transfer-station-input-area .plus-btn {
            width: 36px;
            height: 36px;
            margin-left: 8px;
            background-image: url('https://i.postimg.cc/8PLqF514/icons8-48.png');
            background-size: 24px;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #f7f7f7;
            border: none;
        }

        /* --- Peek Browser Screen --- */
        #peek-browser-screen {
            background-color: #ffffff;
        }

        #peek-browser-screen .app-header .title,
        #peek-browser-screen .app-header .back-btn {
            color: #212529;
        }

        #peek-browser-screen .content {
            padding: 15px 0;
        }

        .browser-history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .browser-history-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .browser-history-item:last-child {
            border-bottom: none;
        }

        .history-item-title {
            font-weight: 500;
            font-size: 16px;
            color: #0056b3; /* A standard link blue */
            margin: 0 0 4px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-url {
            font-size: 13px;
            color: #555;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-annotation {
            font-size: 14px;
            color: #444;
            background-color: #f5f5f5;
            padding: 8px 12px;
            border-radius: 8px;
            line-height: 1.5;
            position: relative;
        }
        
        .history-item-annotation::before {
            content: '批注：';
            font-weight: 600;
            color: #888;
            font-size: 12px;
            display: block;
            margin-bottom: 4px;
        }

        /* --- Peek Drafts Screen --- */
        #peek-drafts-screen {
            background-color: #fff;
            flex-direction: column;
        }

        #peek-drafts-screen .app-header .title,
        #peek-drafts-screen .app-header .back-btn {
            color: #212529;
        }

        #peek-drafts-screen .content {
            padding: 30px 25px;
            font-family: 'Georgia', 'Times New Roman', serif;
            line-height: 1.8;
            color: #333;
            flex-grow: 1;
            overflow-y: auto;
        }

        .draft-paper {
            background-color: #fdfdfd;
            border: 1px solid #eee;
            padding: 25px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .draft-to {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .draft-content {
            font-size: 17px;
            white-space: pre-wrap; /* To preserve line breaks */
        }

        .strikethrough {
            text-decoration: line-through;
            color: #999;
        }

        /* --- Chat Expansion Panel --- */
        .expansion-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .expansion-item-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: background-color 0.2s;
        }
        
        .expansion-item:hover .expansion-item-icon {
            background-color: #f5f5f5;
        }

        .expansion-item-icon svg {
            width: 32px;
            height: 32px;
            fill: #555;
        }

        .expansion-item-name {
            font-size: 13px;
            color: #666;
        }

        /* --- Memory Journal Screen --- */
        #memory-journal-screen .content {
            padding: 15px;
            background-color: #f9f9f9;
        }

        .journal-card {
            background-color: #fdfdfd;
            border: 1px solid #eee;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            position: relative;
            transition: all 0.3s ease;
        }

        .journal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .journal-card-title {
            font-size: 18px;
            font-weight: bold;
            font-family: 'Georgia', 'Times New Roman', serif;
            color: #333;
            flex-grow: 1;
            padding-right: 60px; /* Space for buttons */
        }

        .journal-card-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .journal-card-actions .action-icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .journal-card-actions .action-icon-btn:hover {
            color: var(--primary-color);
        }

        .journal-card-actions .action-icon-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .journal-card-actions .favorite-journal-btn .star-solid {
            fill: #FFD700; /* Gold */
            display: none;
        }

        .journal-card-actions .favorite-journal-btn.favorited .star-solid {
            display: inline;
        }

        .journal-card-actions .favorite-journal-btn.favorited .star-outline {
            display: none;
        }

        .journal-card-content {
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 16px;
            line-height: 1.7;
            color: #444;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, margin-top 0.4s ease-out, padding-top 0.4s ease-out;
            white-space: pre-wrap;
            margin-top: 0;
            padding-top: 0;
            border-top: 1px solid #f0f0f0;
        }

        .journal-card.expanded .journal-card-content {
            max-height: 1000px; /* A large enough value */
            margin-top: 15px;
            padding-top: 15px;
        }

        .journal-card-content.editing {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            min-height: 150px;
            background: #fff;
            max-height: 1000px !important; /* Ensure it's visible when editing */
        }

        .journal-card-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 10px;
            height: 0;
            opacity: 0;
            transition: height 0.4s ease-out, opacity 0.4s ease-out;
        }

        .journal-card.expanded .journal-card-footer {
            height: auto;
            opacity: 1;
        }

        .journal-card-range {
            font-size: 12px;
            color: #aaa;
        }
        
        /* --- 论坛 --- */
        /* --- 论坛分享卡片 --- */
.forum-share-card {
    width: 250px; /* 卡片宽度 */
    background-color: #ffffff;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    padding: 12px 15px;
    cursor: pointer;
    border: 1px solid #f0f0f0;
    margin: 0 8px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.forum-share-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
}

.forum-share-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #888;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid #f5f5f5;
}

.forum-share-header svg {
    width: 18px;
    height: 18px;
    fill: #aaa;
    flex-shrink: 0;
}

.forum-share-content .forum-share-title {
    font-size: 15px;
    font-weight: 600;
    color: #333;
    margin: 0 0 5px 0;
    line-height: 1.4;
    /* 最多显示两行，超出部分显示省略号 */
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.forum-share-content .forum-share-summary {
    font-size: 13px;
    color: #666;
    line-height: 1.5;
    /* 最多显示三行 */
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
}

#forum-binding-modal .modal-window {
    max-width: 380px; /* 弹窗可以稍微宽一点 */
}

.forum-binding-tabs {
    display: flex;
    border-bottom: 2px solid #eee;
    margin-bottom: 15px;
}

.forum-binding-tabs .tab-btn {
    flex: 1;
    padding: 10px 15px;
    background: none;
    border: none;
    font-size: 15px;
    font-weight: 500;
    color: #888;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease-in-out;
}

.forum-binding-tabs .tab-btn:hover {
    color: var(--primary-color);
}

.forum-binding-tabs .tab-btn.active {
    color: var(--primary-color);
    font-weight: 600;
    border-bottom-color: var(--primary-color);
}

#forum-binding-content-wrapper {
    max-height: 50vh; /* 限制内容区域最大高度，超出则出现滚动条 */
    overflow-y: auto; /* 垂直方向溢出时显示滚动条 */
    padding-right: 10px; /* 为滚动条留出空间，防止内容被遮挡 */
}

.forum-binding-content {
    display: none; /* 默认隐藏所有内容面板 */
}

.forum-binding-content.active {
    display: block; /* 只显示激活的内容面板 */
}

.binding-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.binding-list-item {
    display: flex;
    align-items: center;
    padding: 12px 5px;
    border-bottom: 1px solid #f2f2f2;
}

.binding-list-item:last-child {
    border-bottom: none;
}

.binding-list-item input[type="checkbox"] {
    margin-right: 15px;
    width: 18px;
    height: 18px;
    flex-shrink: 0;
}

.binding-list-item label {
    font-size: 15px;
    color: var(--text-color);
    flex-grow: 1;
    cursor: pointer;
}

/* --- 论坛帖子样式 --- */
#forum-posts-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.forum-post-card {
    background-color: #ffffff;
    border-radius: 12px;
    padding: 18px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
}

.forum-post-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
}

.forum-post-card .post-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin: 0 0 8px 0;
}

.forum-post-card .post-summary {
    font-size: 14px;
    color: #888;
    margin: 0 0 12px 0;
    border-left: 3px solid var(--primary-color, #ff80ab);
    padding-left: 10px;
}

.forum-post-card .post-content {
    font-size: 15px;
    color: #555;
    line-height: 1.75;
    white-space: pre-wrap; /* 这很重要，能保留AI生成内容里的换行 */
    display: none; /* 默认隐藏详细内容 */
}

/* 当卡片被点击时，展开详细内容 */
.forum-post-card.expanded .post-content {
    display: block;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #f0f0f0;
}

/* --- Forum Post Detail Screen --- */
#forum-post-detail-screen {
    background-color: #f9f9f9;
}

#forum-post-detail-screen .content {
    padding: 0;
}

.post-detail-card {
    background-color: #fff;
    margin: 15px;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.post-author-info {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.post-author-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    margin-right: 12px;
    background-color: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    flex-shrink: 0;
}

.post-author-name {
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

.post-detail-title {
    font-size: 22px;
    font-weight: 700;
    margin: 0 0 20px 0;
    line-height: 1.4;
}

.post-detail-content {
    font-size: 17px;
    line-height: 1.8;
    color: #444;
    white-space: pre-wrap;
    margin-bottom: 25px;
}

.post-actions {
    display: flex;
    justify-content: space-around;
    padding-top: 15px;
    border-top: 1px solid #f0f0f0;
}

.post-action-item {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #666;
    font-size: 14px;
}

.post-action-item svg {
    width: 22px;
    height: 22px;
    fill: #888;
}

/* --- 论坛详情页新样式 --- */
#forum-post-detail-screen {
    background-color: #f0f2f5; /* 类似贴吧和社交媒体的浅灰色背景 */
}

#forum-post-detail-screen .content {
    padding: 10px; /* 页面边距 */
}

.post-detail-container {
    background-color: #ffffff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    margin-bottom: 10px;
    overflow: hidden;
}

.post-detail-main {
    padding: 15px;
}

.post-author-info {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
}

.author-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: bold;
    margin-right: 12px;
    flex-shrink: 0;
}

.author-details {
    display: flex;
    flex-direction: column;
}

.author-name {
    font-size: 15px;
    font-weight: 600;
    color: #333;
}

.post-meta-data {
    font-size: 12px;
    color: #999;
}

.post-detail-title {
    font-size: 20px;
    font-weight: 700;
    margin: 0 0 15px 0;
    line-height: 1.4;
    color: #1a1a1a;
}

.post-detail-content-body {
    font-size: 16px;
    line-height: 1.75;
    color: #333;
    white-space: pre-wrap;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.post-detail-actions {
    display: flex;
    justify-content: space-around;
    padding-top: 10px;
}

.post-detail-actions .action-item {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #666;
    font-size: 14px;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 5px;
    transition: background-color 0.2s;
}

.post-detail-actions .action-item:hover {
    background-color: #f5f5f5;
}

.post-detail-actions .action-item svg {
    width: 20px;
    height: 20px;
    fill: #888;
}

/* --- 评论区样式 --- */
.comments-section {
    background-color: #ffffff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    padding: 15px;
}

.comments-header {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
    margin-bottom: 10px;
}

.comment-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.comment-item {
    display: flex;
    padding: 12px 0;
    border-bottom: 1px solid #f5f5f5;
}

.comment-item:last-child {
    border-bottom: none;
}

.comment-author-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: var(--accent-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    margin-right: 12px;
    flex-shrink: 0;
}

.comment-body {
    flex-grow: 1;
}

.comment-author-name {
    font-size: 14px;
    font-weight: 600;
    color: #555;
}

.comment-content {
    font-size: 15px;
    color: #333;
    margin-top: 4px;
    line-height: 1.6;
}

.comment-timestamp {
    font-size: 12px;
    color: #aaa;
    margin-top: 6px;
}

/* --- 新的分离式柔和风格论坛搜索栏 --- */

/* 这是整个搜索区域的容器，我们让它透明，只用来布局 */
.forum-search-bar {
    display: flex;
    align-items: center;
    gap: 12px; /* 增大输入框和按钮之间的空隙，让它们彻底分开 */
    margin-bottom: 20px;
    width: 100%; /* 你可以在这里调整整个搜索栏的宽度，比如改成 90% 或者 350px */

    /* 核心改动：把之前的所有视觉样式（背景、边框、阴影）都去掉 */
    background-color: transparent;
    backdrop-filter: none;
    border-radius: 0;
    border: none;
    box-shadow: none;
    padding: 0; /* 现在不需要内边距了 */
}

/* 现在，我们单独给输入框加上样式，让它自己看起来像个完整的输入栏 */
#forum-search-input {
    flex-grow: 1; /* 让它自动占据大部分空间 */
    min-width: 0; /* 允许输入框在flex布局中无限缩小，防止溢出 */
    border: 1px solid rgba(255, 192, 203, 0.3); /* 一个非常淡的粉色边框 */
    background-color: rgba(255, 255, 255, 0.7); /* 半透明白底 */
    backdrop-filter: blur(8px);
    padding: 12px 18px; /* 调整内边距让输入框更高更舒服 */
    font-size: 15px;
    border-radius: 22px; /* 非常圆润的边角 */
    outline: none;
    color: var(--text-color, #444);
    box-shadow: 0 2px 10px rgba(200, 150, 160, 0.1); /* 淡淡的粉色阴影 */
    transition: box-shadow 0.3s ease, border-color 0.3s ease; /* 增加点击时的过渡效果 */
}

#forum-search-input:focus {
    border-color: rgba(255, 128, 171, 0.5); /* 点击输入框时，边框变成更明显的粉色 */
    box-shadow: 0 3px 15px rgba(255, 128, 171, 0.15); /* 阴影也带一点点粉色 */
}

#forum-search-input::placeholder {
    color: #b0aab3;
}

/* 单独给按钮设置样式，让它们看起来是独立的圆形按钮，并且没有边框 */
.forum-search-bar .action-btn {
    flex-shrink: 0;
    width: 42px;  /* 按钮稍微大一点点，更可爱 */
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%; /* 圆形 */
    background-color: rgba(255, 255, 255, 0.7); /* 和输入框一样的背景 */
    backdrop-filter: blur(8px);
    box-shadow: 0 2px 10px rgba(200, 150, 160, 0.1); /* 和输入框一样的阴影 */
    border: 1px solid rgba(255, 192, 203, 0.3); /* 和输入框一样的淡粉色边框 */
    transition: all 0.2s ease;
    cursor: pointer;

/* 图标颜色 */
.forum-search-bar .action-btn svg {
    fill: var(--primary-color, #ff80ab);
}

/* 鼠标悬停和点击时的效果 */
.forum-search-bar .action-btn:hover {
    transform: translateY(-2px); /* 轻轻向上浮动一点 */
    box-shadow: 0 4px 12px rgba(200, 150, 160, 0.15);
    background-color: rgba(255, 255, 255, 0.9);
}

.forum-search-bar .action-btn:active {
    transform: translateY(0); /* 点击时按下去 */
    box-shadow: 0 1px 6px rgba(200, 150, 160, 0.12);
}


}
/* --- 新增：折叠面板样式 --- */
.collapsible-section {
    background-color: #fff8fa;
    border: 1px solid #fce4ec;
    border-radius: 12px;
    margin-bottom: 15px;
    overflow: hidden; /* 防止内容溢出圆角 */
    transition: all 0.3s ease-in-out;
}

.collapsible-header {
    padding: 15px 20px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none; /* 防止选中文本 */
}

.collapsible-header h4 {
    margin: 0;
    font-size: 16px;
    color: var(--primary-color);
}

.collapsible-arrow {
    font-size: 14px;
    color: var(--secondary-color);
    transition: transform 0.3s ease-in-out;
}

.collapsible-content {
    max-height: 0; /* 默认折叠 */
    overflow: hidden;
    transition: max-height 0.4s ease-in-out;
    padding: 0 20px; /* 左右留出边距 */
}

/* 当 .collapsible-section 拥有 .open 类时应用的样式 */
.collapsible-section.open .collapsible-content {
    max-height: 5000px; /* 一个足够大的值来完全显示内容 */
    padding: 0 20px 20px; /* 展开时恢复底部内边距 */
}

.collapsible-section.open .collapsible-arrow {
    transform: rotate(180deg); /* 箭头旋转 */
}
/* --- 新增样式结束 --- */
.message-time {
     display: none !important;
}

 
 
/* --- Peek Steps App Styles (偷看步数应用样式) --- */
#peek-steps-screen {
    background-color: #f0f2f5;
    color: #1c1e21;
}


#peek-steps-screen .app-header {
    background-color: #f0f2f5;
    border-bottom: 1px solid #dcdcdc;
}

#peek-steps-screen .app-header .title,
#peek-steps-screen .app-header .back-btn {
    color: #1c1e21;
}

#peek-steps-screen .content {
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-grow: 1;
    overflow-y: auto;
}

.steps-header {
    display: flex;
    align-items: center;
    width: 100%;
    margin-bottom: 30px;
    padding: 0 10px;
}

.steps-header-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    margin-right: 15px;
}

.steps-header-name {
    font-size: 20px;
    font-weight: 600;
}

.steps-progress-container {
    width: 220px;
    height: 220px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 35px;
    flex-shrink: 0; /* 防止在flex布局中被压缩 */
}

.steps-progress-circle {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: conic-gradient(
        #4CAF50 0deg,
        #4CAF50 calc(3.6deg * var(--steps-percentage, 0)),
        #e6e6e6 calc(3.6deg * var(--steps-percentage, 0)),
        #e6e6e6 360deg
    );
    transition: background 0.5s ease-in-out;
}

.steps-progress-inner {
    position: absolute;
    width: 85%;
    height: 85%;
    background-color: #f0f2f5;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.steps-count {
    font-size: 42px;
    font-weight: bold;
    color: #4CAF50;
}

.steps-label {
    font-size: 14px;
    color: #65676b;
    margin-top: 5px;
}

.steps-module {
    width: 100%;
    background-color: #fff;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.steps-module-title {
    font-size: 16px;
    font-weight: 600;
    margin: 0 0 12px 0;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
}

.activity-track-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.activity-track-item {
    font-size: 15px;
    color: #333;
    padding: 8px 0;
}

.steps-annotation {
    width: 100%;
    background-color: #fff;
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    font-size: 14px;
    color: #555;
    line-height: 1.6;
    font-style: italic;
}
    </style>
    <style id="global-css-style"></style>
</head>

<body>
<div class="phone-screen">
    <div id="home-screen" class="screen active"></div>
    <div id="chat-list-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">聊天</h1>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="create-group-btn">群聊</button>
                <button class="action-btn" id="add-chat-btn">+</button>
            </div>
        </header>
        <main class="content">
            <ul class="list-container" id="chat-list-container"></ul>
            <div class="placeholder-text" id="no-chats-placeholder" style="display: none;">
                <p>还没有聊天对象哦~</p>
                <p>点击右上角的“+”创建一个吧！</p>
            </div>
        </main>
    </div>
    <div id="chat-room-screen" class="screen">
        <header class="app-header" id="chat-room-header-default">
            <button class="back-btn" data-target="chat-list-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="chat-room-title">...</h1>
                <div class="subtitle" id="chat-room-subtitle">
                    <div class="online-indicator"></div>
                    <span id="chat-room-status-text">在线</span>
                </div>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="peek-btn">
                    <img src="https://i.postimg.cc/m2DRpk7v/chan-39.png" alt="偷看" style="width: 28px; height: 28px;">
                </button>
                <button class="action-btn" id="chat-settings-btn"><img src="https://i.postimg.cc/nhwP4pQy/chan-73.png"
                                                                       alt="设置"></button>
            </div>
        </header>
        <header class="app-header" id="chat-room-header-select" style="display: none;">
            <button class="action-btn" id="cancel-multi-select-btn">取消</button>
            <div class="title-container">
                <h1 class="title" id="multi-select-title">选择消息</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <div class="message-area" id="message-area"></div>
            <div class="typing-indicator" id="typing-indicator"></div>
        </main>
        <div class="chat-input-wrapper">
            <div id="sticker-bar">
                <button class="sticker-bar-btn" id="regenerate-btn" title="重回">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65,6.35C16.2,4.9,14.21,4,12,4A8,8,0,0,0,4,12A8,8,0,0,0,12,20C15.73,20,18.84,17.45,19.73,14H17.65C16.83,16.33,14.61,18,12,18A6,6,0,0,1,6,12A6,6,0,0,1,12,6C13.66,6,15.14,6.69,16.22,7.78L13,11H20V4L17.65,6.35Z" />
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="sticker-toggle-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="photo-video-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="image-recognition-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M21.58,16.09L19.66,18L18.24,16.58L21,13.83C21.39,13.44 22,13.44 22.39,13.83L23.17,14.61C23.56,15 23.56,15.64 23.17,16.03L21.58,17.62M20.13,12.25L18.71,13.66L20.41,15.36L21.83,13.94L20.13,12.25M5.93,19H5C3.9,19 3,18.1 3,17V5C3,3.9 3.9,3 5,3H19C20.1,3 21,3.9 21,5V11.08L19,13.08V5H5V17H5.93L13.5,9.43L16.29,12.21L12.08,16.42L5.93,19Z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="voice-message-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="wallet-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 18H4V8H20V18ZM4 6H20V6H4Z"/>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="gift-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M20,8L12,13L4,8V6H20M20,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4M12.5,18C12.5,17.29 12.17,16.65 11.64,16.27C12.17,15.89 12.5,15.26 12.5,14.55C12.5,13.6 11.83,12.79 11,12.58V12H13V10H11V8H13V6H11V5C11,4.45 10.55,4 10,4H8C7.45,4 7,4.45 7,5V6H9V8H7V10H9V12H7V12.58C6.17,12.79 5.5,13.6 5.5,14.55C5.5,15.26 5.83,15.89 6.36,16.27C5.83,16.65 5.5,17.29 5.5,18H12.5Z"/>
                    </svg>
                </button>
                <!-- NEW: Time Skip Button -->
                <button class="sticker-bar-btn" id="time-skip-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M4 5v14l7-7-7-7zm9 0v14l7-7-7-7z"></path>
                    </svg>
                </button>
                <button class="sticker-bar-btn" id="placeholder-plus-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                </button>
            </div>
            <div class="message-input-area" id="message-input-default">
                <input type="text" id="message-input" placeholder="输入消息...">
                <button id="send-message-btn" class="icon-btn send-btn">➤</button>
                <button id="get-reply-btn" class="icon-btn">
                    <svg viewBox="0 0 24 24">
                        <path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 1,1 20,12A8,8 0 0,1 12,20M16.24,7.76C15.07,6.58 13.53,6 12,6V12L7.76,16.24C10.1,18.58 13.9,18.58 16.24,16.24C18.58,13.9 18.58,10.1 16.24,7.76Z"/>
                    </svg>
                </button>
            </div>
            <div class="message-input-area" id="message-edit-bar" style="display: none;">
                <input type="text" id="message-edit-input">
                <button id="save-edit-btn" class="icon-btn send-btn">✓</button>
                <button id="cancel-edit-btn" class="icon-btn" style="background-color: #aaa;">✗</button>
            </div>
        </div>
        
        <div id="music-screen" class="screen"></div>

        
        <div id="multi-select-bar"><span id="select-count">已选择 0 项</span>
            <button class="btn btn-danger" id="delete-selected-btn" style="width: auto; padding: 8px 16px;">删除已选
            </button>
        </div>
        <div id="sticker-modal">
            <div class="header">
                <span>我的表情</span>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-neutral btn-small" id="manage-stickers-btn">管理</button>
                    <button class="btn btn-primary btn-small" id="batch-add-sticker-btn" style="background-color: var(--accent-color);">批量导入</button>
                    <button class="btn btn-primary btn-small" id="add-new-sticker-btn">添加新表情</button>
                </div>
            </div>
            <div class="sticker-grid" id="sticker-grid-container"></div>
            <div id="sticker-manage-bar" style="display: none; padding: 10px; border-top: 1px solid #eee; background: #f7f7f7;">
                <button class="btn btn-danger" id="delete-selected-stickers-btn" style="width: 100%;">删除已选 (0)</button>
            </div>
        </div>
        <!-- NEW: Chat Expansion Panel -->
        <div id="chat-expansion-panel">
            <div class="sticker-grid" id="chat-expansion-grid">
                <!-- Items will be populated by JS -->
            </div>
        </div>
    </div>
    <div id="world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">世界书</h1>
            </div>
            <button class="action-btn" id="add-world-book-btn">+</button>
        </header>
        <main class="content">
            <ul class="list-container" id="world-book-list-container"></ul>
            <div class="placeholder-text" id="no-world-books-placeholder" style="display: none;">
                <p>你的世界一片混沌...</p>
                <p>点击右上角的“+”创造第一个设定吧！</p>
            </div>
        </main>
    </div>
    <div id="edit-world-book-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="world-book-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="edit-world-book-title">创建/编辑条目</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content">
            <form id="edit-world-book-form">
                <input type="hidden" id="world-book-id">
                <div class="form-group">
                    <label for="world-book-name">条目名称</label>
                    <input type="text" id="world-book-name" placeholder="例如：世界观背景、魔法体系" required>
                </div>
                <div class="form-group">
                    <label for="world-book-content">条目内容</label>
                    <textarea id="world-book-content" rows="8" placeholder="详细描述此项设定..." required></textarea>
                </div>
                <div class="form-group">
                    <label>注入位置</label>
                    <div class="form-group radio-group">
                        <label><input type="radio" name="world-book-position" value="before" checked> 前</label>
                        <label><input type="radio" name="world-book-position" value="after"> 后</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">保存条目</button>
            </form>
        </main>
    </div>
    <div id="api-settings-screen" class="screen"></div>
    <div id="wallpaper-screen" class="screen"></div>
    <div id="font-settings-screen" class="screen"></div>
    <div id="customize-screen" class="screen"></div>
    <div id="tutorial-screen" class="screen"></div>
    <div id="toast-notification" class="toast"></div>
    <input type="file" id="image-upload-input" accept="image/*" style="display:none;">
    <div id="add-char-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建新角色</h3>
            <form id="add-char-form">
                <div class="form-group">
                    <label for="char-real-name">角色姓名</label><input type="text" id="char-real-name"
                                                                       placeholder="角色的真实姓名" required>
                </div>
                <div class="form-group">
                    <label for="char-remark-name">角色备注 (昵称)</label><input type="text" id="char-remark-name"
                                                                                placeholder="你对Ta的称呼" required>
                </div>
                <div class="form-group">
                    <label for="my-name-for-char">我的姓名</label><input type="text" id="my-name-for-char"
                                                                         placeholder="你希望Ta如何称呼你" required>
                </div>
                <button type="submit" class="btn btn-primary">创建</button>
            </form>
        </div>
    </div>
    <div id="add-sticker-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="add-sticker-modal-title">添加新表情</h3>
            <form id="add-sticker-form"><input type="hidden" id="sticker-edit-id">
                <div id="sticker-preview"><span>预览</span></div>
                <div class="form-group"><label for="sticker-name">表情名称</label><input type="text" id="sticker-name"
                                                                                         placeholder="如：开心" required>
                </div>
                <div class="form-group"><label for="sticker-url-input">表情URL</label><input type="url"
                                                                                             id="sticker-url-input"
                                                                                             placeholder="粘贴图片URL">
                </div>
                <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p><input type="file"
                                                                                             id="sticker-file-upload"
                                                                                             accept="image/*"
                                                                                             style="display:none;"><label
                        for="sticker-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>
    <div id="sticker-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="edit-sticker-btn">编辑</button>
            <button class="action-sheet-button danger" id="delete-sticker-btn">删除</button>
        </div>
    </div>
    <!-- Batch Add Sticker Modal -->
    <div id="batch-add-sticker-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>批量导入表情</h3>
            <form id="batch-add-sticker-form">
                <div class="form-group">
                    <label for="sticker-urls-textarea">数据格式：名称:URL (英文冒号，每行一个)</label>
                    <textarea id="sticker-urls-textarea" rows="8" placeholder="例如：&#10;开心:https://example.com/happy.gif&#10;哭泣:https://example.com/cry.png"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">开始导入</button>
            </form>
        </div>
    </div>
    <div id="send-voice-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>发送语音消息</h3>
            <form id="send-voice-form">
                <div class="form-group">
                    <label for="voice-text-input">输入语音文字</label>
                    <textarea id="voice-text-input" placeholder="在这里输入你想说的话..." required rows="4"></textarea>
                </div>
                <div class="form-group" style="text-align:center; color:#888; font-size: 14px;">
                    预计时长: <span id="voice-duration-preview">0"</span>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-pv-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>分享照片/视频</h3>
            <form id="send-pv-form">
                <div class="form-group">
                    <label for="pv-text-input">输入描述</label>
                    <textarea id="pv-text-input" placeholder="在这里描述你的照片或视频内容..." required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-transfer-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>转账</h3>
            <form id="send-transfer-form">
                <div class="form-group">
                    <label for="transfer-amount-input">金额 (元)</label>
                    <input type="number" id="transfer-amount-input" placeholder="0.00" required step="0.01" min="0.01">
                </div>
                <div class="form-group">
                    <label for="transfer-remark-input">备注</label>
                    <input type="text" id="transfer-remark-input" placeholder="（选填）">
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <div id="send-gift-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>送出礼物</h3>
            <form id="send-gift-form">
                <div class="form-group">
                    <label for="gift-description-input">礼物描述</label>
                    <textarea id="gift-description-input" placeholder="告诉Ta你送了什么特别的东西..." required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <!-- NEW: Time Skip Modal -->
    <div id="time-skip-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>记录今天发生的事</h3>
            <form id="time-skip-form">
                <div class="form-group">
                    <label for="time-skip-input">事件描述 (该消息AI可见，会作为上下文)</label>
                    <textarea id="time-skip-input" placeholder="例如：我们一起去山顶看了日落，然后吃了烧烤。" required
                              rows="4"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">发送</button>
            </form>
        </div>
    </div>
    <!-- NEW: Group Recipient Selection Modal -->
    <div id="group-recipient-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="group-recipient-selection-title">选择收件人</h3>
            <ul id="group-recipient-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-group-recipient-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <div id="receive-transfer-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="accept-transfer-btn">接收</button>
            <button class="action-sheet-button danger" id="return-transfer-btn">退回</button>
        </div>
    </div>
    <!-- Private Chat Settings -->
    <div id="chat-settings-sidebar" class="settings-sidebar">
        <div class="header">聊天设置</div>
        <div class="content">
            <form id="chat-settings-form">
                <div class="avatar-setting"><img src="" alt="角色头像" id="setting-char-avatar-preview"
                                                 class="avatar-preview"><input type="file"
                                                                               id="setting-char-avatar-upload"
                                                                               accept="image/*"
                                                                               style="display:none;"><label
                        for="setting-char-avatar-upload" class="btn btn-primary"
                        style="flex-grow:1;">更换角色头像</label></div>
                <div class="form-group"><label for="setting-char-remark">角色备注 (昵称)</label><input type="text"
                                                                                                       id="setting-char-remark">
                </div>
                <div class="form-group"><label for="setting-char-persona">角色人设</label><textarea
                        id="setting-char-persona" placeholder="详细描述角色的性格、背景、说话风格等。"></textarea></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting"><img src="" alt="我的头像" id="setting-my-avatar-preview"
                                                 class="avatar-preview"><input type="file" id="setting-my-avatar-upload"
                                                                               accept="image/*"
                                                                               style="display:none;"><label
                        for="setting-my-avatar-upload" class="btn btn-secondary"
                        style="flex-grow:1;">更换我的头像</label></div>
                <div class="form-group"><label for="setting-my-name">我的姓名</label><input type="text"
                                                                                            id="setting-my-name"></div>
                <div class="form-group"><label for="setting-my-persona">我的人设</label><textarea
                        id="setting-my-persona" placeholder="描述你希望在对话中扮演的形象。"></textarea></div>
               <div class="panel panel-sm" style="padding:12px;border-radius:10px;border:1px solid var(--border-color,#e8e8ef);background:var(--panel-bg,#fff);box-shadow:var(--panel-shadow,0 4px 12px rgba(20,20,30,0.04));margin:10px 0;"><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><label for="mypersona-preset-select" style="width:88px;color:var(--muted,#667);font-size:13px;">人设</label><select id="mypersona-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;"><option value="">— 选择预设 —</option></select><button type="button" id="mypersona-apply-btn" class="btn btn-primary" style="margin-left:8px;padding:7px 10px;border-radius:8px;">应用</button></div><div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;"><label style="width:88px;color:var(--muted,#667);font-size:13px;">外观操作</label><button type="button" id="mypersona-save-btn" class="btn" style="padding:7px 10px;border-radius:8px;">另存为</button><button type="button" id="mypersona-manage-btn" class="btn" style="padding:7px 10px;border-radius:8px;">管理</button></div></div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-world-book-btn">关联世界书</button>
                </div>
                <div class="form-group"><label for="setting-theme-color">主题颜色 (对方/我方)</label><select
                        id="setting-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                        <input type="checkbox" id="setting-use-custom-css" style="width: auto;">
                    </div>
                    <div id="private-bubble-css-preview" class="bubble-css-preview"
                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-custom-bubble-css" rows="6"
                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                              disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                    </button>
                </div>
               <div class="panel panel-sm" style="padding:12px;border-radius:10px;border:1px solid var(--border-color,#e8e8ef);background:var(--panel-bg,#fff);box-shadow:var(--panel-shadow,0 4px 12px rgba(20,20,30,0.04));margin:10px 0;"><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><label for="bubble-preset-select" style="width:88px;color:var(--muted,#667);font-size:13px;">气泡</label><select id="bubble-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;"><option value="">— 选择预设 —</option></select><button type="button" id="apply-preset-btn" class="btn btn-primary" style="margin-left:8px;padding:7px 10px;border-radius:8px;">应用</button></div><div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;"><label style="width:88px;color:var(--muted,#667);font-size:13px;">外观操作</label><button type="button" id="save-preset-btn" class="btn" style="padding:7px 10px;border-radius:8px;">另存为</button><button type="button" id="manage-presets-btn" class="btn" style="padding:7px 10px;border-radius:8px;">管理</button></div></div>
                <div class="form-group"><label for="setting-max-memory">最大记忆轮数</label><input type="number"
                                                                                                   id="setting-max-memory"
                                                                                                   value="10" min="1">
                </div>
                <div class="form-group"><label for="setting-chat-bg-upload" class="btn btn-primary">更换聊天背景</label><input
                        type="file" id="setting-chat-bg-upload" accept="image/*" style="display:none;"></div>
                <button type="submit" class="btn btn-primary">保存设置</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-danger" id="clear-chat-history-btn">清空聊天记录</button>
        </div>
    </div>
    <div id="world-book-selection-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>选择要关联的世界书</h3>
            <ul id="world-book-selection-list"></ul>
            <button class="btn btn-primary" id="save-world-book-selection-btn" style="margin-top: 20px;">确认</button>
        </div>
    </div>
    <!-- Group Chat Creation Modal -->
    <div id="create-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建群聊</h3>
            <form id="create-group-form">
                <div class="form-group">
                    <label>选择群成员</label>
                    <ul id="member-selection-list" class="member-selection-list"></ul>
                </div>
                <div class="form-group">
                    <label for="group-name-input">群聊名称</label>
                    <input type="text" id="group-name-input" placeholder="给你的群聊起个名字吧" required>
                </div>
                <button type="submit" class="btn btn-primary">创建群聊</button>
            </form>
        </div>
    </div>
    <!-- Group Chat Settings -->
    <div id="group-settings-sidebar" class="settings-sidebar">
        <div class="header">群聊设置</div>
        <div class="content">
            <form id="group-settings-form">
                <div class="group-avatar-setting">
                    <img src="" alt="群头像" id="setting-group-avatar-preview" class="group-avatar-preview">
                    <input type="file" id="setting-group-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-avatar-upload" class="btn btn-primary"
                           style="flex-grow:1;">更换群头像</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-name">群名 (AI也可见)</label>
                    <input type="text" id="setting-group-name">
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="avatar-setting">
                    <img src="" alt="我的头像" id="setting-group-my-avatar-preview" class="avatar-preview">
                    <input type="file" id="setting-group-my-avatar-upload" accept="image/*" style="display:none;">
                    <label for="setting-group-my-avatar-upload" class="btn btn-secondary"
                           style="flex-grow:1;">更换我的头像</label>
                </div>
                <div class="form-group">
                    <label for="setting-group-my-nickname">我的群昵称</label>
                    <input type="text" id="setting-group-my-nickname">
                </div>
                <div class="form-group">
                    <label for="setting-group-my-persona">我的人设</label>
                    <textarea id="setting-group-my-persona" placeholder="描述你希望在此群聊中扮演的形象。"></textarea>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <label>群成员</label>
                    <div class="group-members-list" id="group-members-list-container"></div>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" id="link-group-world-book-btn">关联世界书</button>
                </div>
                <div class="form-group"><label for="setting-group-theme-color">主题颜色 (对方/我方)</label><select
                        id="setting-group-theme-color"></select></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="setting-group-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>
                        <input type="checkbox" id="setting-group-use-custom-css" style="width: auto;">
                    </div>
                    <div id="group-bubble-css-preview" class="bubble-css-preview"
                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
                    <textarea id="setting-group-custom-bubble-css" rows="6"
                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"
                              disabled></textarea>
                    <button type="button" class="btn btn-neutral" id="reset-group-custom-bubble-css-btn"
                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认
                    </button>
                </div>
               <div class="panel panel-sm" style="padding:12px;border-radius:10px;border:1px solid var(--border-color,#e8e8ef);background:var(--panel-bg,#fff);box-shadow:var(--panel-shadow,0 4px 12px rgba(20,20,30,0.04));margin:10px 0;"><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;"><label for="bubble-preset-select" style="width:88px;color:var(--muted,#667);font-size:13px;">气泡预设</label><select id="bubble-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;"><option value="">— 选择预设 —</option></select><button type="button" id="apply-preset-btn" class="btn btn-primary" style="margin-left:8px;padding:7px 10px;border-radius:8px;">应用</button></div><div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;"><label style="width:88px;color:var(--muted,#667);font-size:13px;">外观操作</label><button type="button" id="save-preset-btn" class="btn" style="padding:7px 10px;border-radius:8px;">另存为</button><button type="button" id="manage-presets-btn" class="btn" style="padding:7px 10px;border-radius:8px;">管理</button></div></div>
                <div class="form-group"><label for="setting-group-max-memory">最大记忆轮数</label><input type="number"
                                                                                                         id="setting-group-max-memory"
                                                                                                         value="10"
                                                                                                         min="1"></div>
                <div class="form-group"><label for="setting-group-chat-bg-upload"
                                               class="btn btn-primary">更换聊天背景</label><input type="file"
                                                                                                  id="setting-group-chat-bg-upload"
                                                                                                  accept="image/*"
                                                                                                  style="display:none;">
                </div>
                <button type="submit" class="btn btn-primary">保存设置</button>
            </form>
            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
            <button type="button" class="btn btn-danger" id="clear-group-chat-history-btn">清空聊天记录</button>
        </div>
    </div>
    <!-- Group Member Edit Modal -->
    <div id="edit-group-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3 id="edit-group-member-title">编辑群成员</h3>
            <form id="edit-group-member-form">
                <input type="hidden" id="editing-member-id">
                <div class="avatar-setting" style="justify-content: center;">
                    <img src="" alt="成员头像" id="edit-member-avatar-preview" class="avatar-preview"
                         style="cursor: pointer;">
                    <input type="file" id="edit-member-avatar-upload" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="edit-member-group-nickname">群昵称</label>
                    <input type="text" id="edit-member-group-nickname" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-real-name">真名</label>
                    <input type="text" id="edit-member-real-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-member-persona">人设</label>
                    <textarea id="edit-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">保存</button>
            </form>
        </div>
    </div>
    <!-- Add Member to Group Action Sheet -->
    <div id="add-member-actionsheet" class="action-sheet-overlay">
        <div class="action-sheet">
            <button class="action-sheet-button" id="invite-existing-member-btn">邀请现有角色</button>
            <button class="action-sheet-button" id="create-new-member-btn">创建新角色入群</button>
        </div>
    </div>
    <!-- Invite Existing Member Modal -->
    <div id="invite-member-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>邀请成员加入群聊</h3>
            <ul id="invite-member-selection-list"></ul>
            <button class="btn btn-primary" id="confirm-invite-btn" style="margin-top: 20px;">确认邀请</button>
        </div>
    </div>
    <!-- Create New Member for Group Modal -->
    <div id="create-member-for-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建新角色并加入群聊</h3>
            <form id="create-member-for-group-form">
                <div class="avatar-setting" style="justify-content: center;">
                    <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="新成员头像"
                         id="create-group-member-avatar-preview" class="avatar-preview" style="cursor: pointer;">
                    <input type="file" id="create-group-member-avatar-upload" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="create-group-member-nickname">群昵称</label>
                    <input type="text" id="create-group-member-nickname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-realname">真名</label>
                    <input type="text" id="create-group-member-realname" required>
                </div>
                <div class="form-group">
                    <label for="create-group-member-persona">人设</label>
                    <textarea id="create-group-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">创建并加入</button>
            </form>
        </div>
    </div>
    <!-- Memory Journal Screen -->
    <div id="memory-journal-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="chat-room-screen">‹</button>
            <div class="title-container">
                <h1 class="title">回忆日记</h1>
            </div>
            <div class="action-btn-group">
                <button class="action-btn" id="bind-journal-worldbook-btn" title="绑定世界书">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M17 7h-4v2h4c1.65 0 3 1.35 3 3s-1.35 3-3 3h-4v2h4c2.76 0 5-2.24 5-5s-2.24-5-5-5zm-6 8H7c-1.65 0-3-1.35-3-3s1.35-3 3-3h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-2zm-3-4h8v2H8v-2z"></path>
                    </svg>
                </button>
                <button class="action-btn" id="generate-new-journal-btn" title="生成新日记">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                    </svg>
                </button>
            </div>
        </header>
        <main class="content">
            <ul class="list-container" id="journal-list-container">
                <!-- Journal cards will be rendered here -->
            </ul>
            <div class="placeholder-text" id="no-journals-placeholder" style="display: none;">
                <p>还没有日记哦~</p>
                <p>点击右上角的“+号”来创建第一篇吧！</p>
            </div>
        </main>
    </div>

    <!-- Memory Journal Detail Screen -->
    <div id="memory-journal-detail-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="memory-journal-screen">‹</button>
            <div class="title-container">
                <h1 class="title">日记详情</h1>
            </div>
            <button class="action-btn" id="edit-journal-detail-btn">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>
            </button>
        </header>
        <main class="content" style="padding: 20px; font-family: 'Georgia', 'Times New Roman', serif;">
            <h2 id="journal-detail-title" style="margin-top: 0; font-size: 22px;"></h2>
            <p id="journal-detail-meta" style="font-size: 12px; color: #aaa; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;"></p>
            <div id="journal-detail-content" style="line-height: 1.7; white-space: pre-wrap; font-size: 16px;"></div>
        </main>
    </div>

    <!-- Peek Steps App Screen -->
    <div id="peek-steps-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="peek-screen">‹</button>
            <div class="title-container">
                <h1 class="title">步数</h1>
            </div>
            <div class="placeholder"></div> <!-- To balance the header -->
        </header>
        <main class="content">
            <div class="steps-header">
                <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="Char Avatar" class="steps-header-avatar" id="steps-char-avatar">
                <span class="steps-header-name" id="steps-char-name">Char</span>
            </div>

            <div class="steps-progress-container">
                <div class="steps-progress-circle" id="steps-progress-ring"></div>
                <div class="steps-progress-inner">
                    <div class="steps-count" id="steps-current-count">4321</div>
                    <div class="steps-label">/ 6000 步</div>
                </div>
            </div>

            <div class="steps-module">
                <h3 class="steps-module-title">最近活动轨迹</h3>
                <ul class="activity-track-list" id="activity-track-list">
                    <li class="activity-track-item">10:00 AM - 咖啡馆</li>
                    <li class="activity-track-item">01:30 PM - 市中心图书馆</li>
                    <li class="activity-track-item">06:00 PM - 河边公园</li>
                    <li class="activity-track-item">07:00 PM - 健身房</li>
                    <li class="activity-track-item">08:30 PM - 超市</li>
                    <li class="activity-track-item">09:00 PM - 回家</li>
                </ul>
            </div>
            <div class="steps-annotation" id="steps-annotation-content">
                “今天走了不少路，但感觉很充实。特别是下午在图书馆找到的那本书，感觉能看很久。”
            </div>
        </main>
    </div>

    <div id="peek-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="chat-room-screen">‹</button>
            <div class="title-container">
                <h1 class="title">Ta的手机</h1>
            </div>
            <button class="action-btn" id="peek-settings-btn"><img src="https://i.postimg.cc/nhwP4pQy/chan-73.png" alt="设置"></button>
        </header>
        <main class="content" style="padding: 50px 0; justify-content: flex-start; align-items: center;">
            <!-- Content rendered by renderPeekScreen() -->
        </main>
    </div>

   <div id="forum-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="home-screen">←</button>
        <div class="title-container">
            <h1 class="title">论坛</h1>
        </div>

        <div class="action-btn-group"></div>
    </header>
    <main class="content" style="padding: 15px;">

        <div class="forum-search-bar">
            <button class="action-btn" id="forum-link-btn" title="绑定">
                <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M17 7h-4v2h4c1.65 0 3 1.35 3 3s-1.35 3-3 3h-4v2h4c2.76 0 5-2.24 5-5s-2.24-5-5-5zm-6 8H7c-1.65 0-3-1.35-3-3s1.35-3 3-3h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-2zm-3-4h8v2H8v-2z"></path>
                </svg>
            </button>
            <input type="text" id="forum-search-input" placeholder="搜索关键词">
            <button class="action-btn" id="forum-refresh-btn" title="刷新">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
            </button>
        </div>

        <div id="forum-posts-container">
            <p class="placeholder-text" style="margin-top: 50px;">点击右上角刷新按钮来生成帖子...</p>
        </div>
    </main>
</div>



<div id="forum-post-detail-screen" class="screen">

</div>


<div id="peek-messages-screen" class="screen">

        <header class="app-header">
            <button class="back-btn" data-target="peek-screen">‹</button>
            <div class="title-container">
                <h1 class="title">Ta的消息</h1>
            </div>
            <button class="action-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
            </button>
        </header>
        <main class="content">
            <ul class="list-container" id="peek-chat-list-container">
                <!-- Simulated chat list will be rendered here -->
            </ul>
        </main>
    </div>

    <!-- Peek Conversation Screen -->
    <div id="peek-conversation-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="peek-messages-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="peek-conversation-title">...</h1>
            </div>
            <button class="action-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
            </button>
        </header>
        <main class="content">
            <div class="message-area" id="peek-message-area">
                <!-- Simulated messages will be rendered here -->
            </div>
        </main>
    </div>

    <!-- Peek Memos Screen -->
    <div id="peek-memos-screen" class="screen"></div>

    <!-- Peek Memo Detail Screen -->
    <div id="peek-memo-detail-screen" class="screen"></div>

    <!-- Peek Cart Screen -->
    <div id="peek-cart-screen" class="screen"></div>

    <!-- Peek Transfer Station Screen -->
    <div id="peek-transfer-station-screen" class="screen"></div>

    <!-- Peek Browser Screen -->
    <div id="peek-browser-screen" class="screen"></div>

    <!-- Peek Drafts Screen -->
    <div id="peek-drafts-screen" class="screen"></div>

    <div id="peek-album-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="peek-screen">‹</button>
            <div class="title-container"><h1 class="title">相册</h1></div>
            <button class="action-btn" id="refresh-album-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
        </header>
        <main class="content">
            <div class="album-grid">
                <p class="placeholder-text">正在生成相册内容...</p>
            </div>
        </main>
    </div>
 
    <!-- Peek Unlock Screen (Social Media) -->
    <div id="peek-unlock-screen" class="screen">
        <!-- Content will be dynamically rendered by renderPeekUnlock() -->
    </div>
 
    <div id="peek-confirm-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>要偷看ta的手机吗？</h3>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="peek-confirm-yes" class="btn btn-primary" style="flex: 1;">是</button>
                <button id="peek-confirm-no" class="btn btn-neutral" style="flex: 1;">否</button>
            </div>
        </div>
    </div>
    <!-- New Peek Wallpaper Modal -->
    <div id="peek-wallpaper-modal" class="modal-overlay">
        <div class="modal-window" style="max-height: 80vh; overflow-y: auto;">
            <h3>“偷看”页面自定义</h3>
            <div class="collapsible-section open">
                <div class="collapsible-header">
                    <h4>页面壁纸</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    <form id="peek-wallpaper-form">
                        <div class="form-group">
                            <label for="peek-wallpaper-url-input">壁纸URL</label>
                            <input type="url" id="peek-wallpaper-url-input" class="form-group" placeholder="粘贴图片URL">
                        </div>
                        <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p>
                        <input type="file" id="peek-wallpaper-upload" accept="image/*" style="display: none;">
                        <label for="peek-wallpaper-upload" class="btn btn-secondary">从本地上传</label>
                    </form>
                </div>
            </div>
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>应用图标</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content" id="peek-app-icons-settings">
                    <!-- App icon settings will be rendered here by JS -->
                </div>
            </div>
             <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>微博(Unlock)小号</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    <div class="form-group">
                        <label for="peek-unlock-avatar-url">头像URL</label>
                        <input type="url" id="peek-unlock-avatar-url" class="form-group" placeholder="粘贴图片URL">
                    </div>
                </div>
            </div>
            <button id="save-peek-settings-btn" class="btn btn-primary" style="margin-top: 20px;">保存所有更改</button>
        </div>
    </div>
    <div id="peek-photo-modal" class="modal-overlay">
        <div class="modal-window">
            <div id="peek-photo-image-container">
                <span class="placeholder-icon">🖼️</span>
            </div>
            <div id="peek-photo-description"></div>
        </div>
    </div>
</div>
 
    <div id="forum-binding-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>绑定上下文</h3>
            <div class="forum-binding-tabs">
                <button class="tab-btn active" data-target="binding-content-worldbook">世界书</button>
                <button class="tab-btn" data-target="binding-content-char">char</button>
                <button class="tab-btn" data-target="binding-content-user">user</button>
            </div>
            <div id="forum-binding-content-wrapper">
                <div id="binding-content-worldbook" class="forum-binding-content active">
                    <ul id="forum-worldbook-list" class="binding-list"></ul>
                </div>
                <div id="binding-content-char" class="forum-binding-content">
                    <ul id="forum-char-list" class="binding-list"></ul>
                </div>
                <div id="binding-content-user" class="forum-binding-content">
                    <ul id="forum-user-list" class="binding-list"></ul>
                </div>
            </div>
            <button id="confirm-forum-binding-btn" class="btn btn-primary" style="margin-top: 20px;">确认绑定</button>
        </div>
    </div>


<!-- Generate Journal Modal -->
<div id="generate-journal-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>指定总结范围</h3>
        <form id="generate-journal-form">
            <div id="journal-range-info" style="font-size: 12px; color: #888; text-align: center; margin-bottom: 15px;"></div>
            <div class="form-group">
                <label for="journal-range-start">起始消息 (序号)</label>
                <input type="number" id="journal-range-start" placeholder="例如：1" required>
            </div>
            <div class="form-group">
                <label for="journal-range-end">结束消息 (序号)</label>
                <input type="number" id="journal-range-end" placeholder="例如：100" required>
            </div>
            <button type="submit" class="btn btn-primary">生成</button>
        </form>
    </div>
</div>

<!-- Journal World Book Selection Modal -->
<div id="journal-worldbook-selection-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>为日记绑定世界书</h3>
        <ul id="journal-worldbook-selection-list" class="list-container" style="max-height: 40vh; overflow-y: auto; padding: 0; margin: 15px 0;">
            <!-- World book items will be rendered here -->
        </ul>
        <button class="btn btn-primary" id="save-journal-worldbook-selection-btn" style="margin-top: 20px;">确认</button>
    </div>
</div>

<!-- NEW: Delete History Chunk Modals -->
<div id="delete-chunk-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>删除指定范围记录</h3>
        <form id="delete-chunk-form">
            <div id="delete-chunk-range-info" style="font-size: 12px; color: #888; text-align: center; margin-bottom: 15px;"></div>
            <div class="form-group">
                <label for="delete-range-start">起始消息 (序号)</label>
                <input type="number" id="delete-range-start" placeholder="例如：1" required>
            </div>
            <div class="form-group">
                <label for="delete-range-end">结束消息 (序号)</label>
                <input type="number" id="delete-range-end" placeholder="例如：100" required>
            </div>
            <button type="submit" class="btn btn-primary">下一步</button>
        </form>
    </div>
</div>

<div id="share-post-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>是否将分享给他人？</h3>
        <div style="margin: 20px 0;">
            <details>
                <summary style="font-weight: 500; cursor: pointer; color: var(--primary-color);">选择分享对象</summary>
                <ul id="share-char-list" class="binding-list" style="margin-top: 10px; max-height: 40vh; overflow-y: auto;">

                </ul>
            </details>
        </div>
        <button id="confirm-share-btn" class="btn btn-primary" style="margin-top: 15px;">确认发送</button>
    </div>
</div>


<div id="delete-chunk-confirm-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>确认删除</h3>
        <p>将永久删除以下范围的消息，此操作不可撤销！</p>
        <div id="delete-chunk-preview" style="max-height: 200px; overflow-y: auto; background: #f5f5f5; border-radius: 8px; padding: 10px; margin: 15px 0; font-size: 12px; line-height: 1.5;">
            <!-- Preview will be inserted here -->
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="confirm-delete-chunk-btn" class="btn btn-danger" style="flex: 1;">永久删除</button>
            <button id="cancel-delete-chunk-btn" class="btn btn-neutral" style="flex: 1;">取消</button>
        </div>
    </div>
</div>

<div id="bubble-presets-modal" class="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;"><div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);"><h3 style="margin:0 0 10px 0;font-size:16px;">管理气泡预设</h3><div id="bubble-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button type="button" id="close-presets-modal" class="btn btn-primary" style="padding:8px 12px;border-radius:8px;">关闭</button></div></div></div>
<div id="mypersona-presets-modal" class="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;"><div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);"><h3 style="margin:0 0 10px 0;font-size:16px;">管理我的人设预设</h3><div id="mypersona-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button type="button" id="mypersona-close-modal" class="btn btn-primary" style="padding:8px 12px;border-radius:8px;">关闭</button></div></div></div>
<div id="global-css-presets-modal" class="modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;z-index:9999;"><div class="modal-window" style="max-width:520px;background:var(--panel-bg,#fff);padding:14px;border-radius:10px;box-shadow:0 12px 36px rgba(10,10,20,0.12);"><h3 style="margin:0 0 10px 0;font-size:16px;">管理全局CSS预设</h3><div id="global-css-presets-list" style="max-height:340px; overflow:auto; margin-bottom:12px;"></div><div style="display:flex;gap:8px;justify-content:flex-end;"><button type="button" id="global-css-close-modal" class="btn btn-primary" style="padding:8px 12px;border-radius:8px;">关闭</button></div></div></div>
<input type="file" id="import-data-input" accept=".ee" style="display: none;">

<script>
    async function updateBatteryStatus() {
        // 首先检查浏览器是否支持电池API
        if ('getBattery' in navigator) {
            try {
                // 异步获取电池状态管理器
                const battery = await navigator.getBattery();        // 获取相关的HTML元素
            const batteryLevelText = document.getElementById('battery-level');
            const batteryFillRect = document.getElementById('battery-fill-rect');
    
            // 创建一个内部函数，用于更新显示
            const updateDisplay = () => {
                if (!batteryLevelText || !batteryFillRect) return;
    
                // 计算电量百分比
                const level = Math.floor(battery.level * 100);
                batteryLevelText.textContent = `${level}%`;
    
                // 根据电量更新SVG内部填充条的宽度
                // SVG内部填充区域总宽度是18，所以用电量百分比去乘以它
                batteryFillRect.setAttribute('width', 18 * battery.level);
    
                // 根据电量和充电状态改变颜色，更有细节感
                let fillColor = "#666"; // 默认颜色
                if (battery.charging) {
                    fillColor = "#4CAF50"; // 充电时显示绿色
                } else if (level <= 20) {
                    fillColor = "#f44336"; // 低电量时显示红色
                }
                batteryFillRect.setAttribute('fill', fillColor);
            };
    
            // 第一次加载时，立即更新一次
            updateDisplay();
    
            // 添加事件监听器，当电量变化或充电状态变化时，自动更新
            battery.addEventListener('levelchange', updateDisplay);
            battery.addEventListener('chargingchange', updateDisplay);
    
        } catch (error) {
            console.error('无法获取电池信息:', error);
            // 如果获取失败，就隐藏电池小部件
            const batteryWidget = document.querySelector('.widget-battery');
            if (batteryWidget) batteryWidget.style.display = 'none';
        }
    } else {
        console.log('您的浏览器不支持电池状态API。');
        // 如果浏览器不支持，也隐藏电池小部件
        const batteryWidget = document.querySelector('.widget-battery');
        if (batteryWidget) batteryWidget.style.display = 'none';
    }
    }
    
    
    // gemini如果是多个密钥, 那么随机获取一个
    function getRandomValue(str) {
        // 检查字符串是否包含逗号
        if (str.includes(',')) {
            // 用逗号分隔字符串并移除多余空格
            const arr = str.split(',').map(item => item.trim());
            // 生成随机索引 (0 到 arr.length-1)
            const randomIndex = Math.floor(Math.random() * arr.length);
            // 返回随机元素
            return arr[randomIndex];
        }
        // 没有逗号则直接返回原字符串
        return str;
    }

    document.addEventListener('DOMContentLoaded', () => {
        async function compressImage(file, options = {}) {
            const {
                quality = 0.8, maxWidth = 800, maxHeight = 800
            } = options;

            // --- 新增：处理GIF动图 ---
            // 如果文件是GIF，则不经过canvas压缩，直接返回原始文件数据以保留动画
            if (file.type === 'image/gif') {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            // --- 对其他静态图片（如PNG, JPG）进行压缩 ---
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onerror = reject;
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onerror = reject;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * (maxWidth / width));
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * (maxHeight / height));
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');

                        // 对于有透明背景的PNG图片，先填充一个白色背景
                        // 这样可以防止透明区域在转换成JPEG时变黑
                        if (file.type === 'image/png') {
                            ctx.fillStyle = '#FFFFFF'; // 白色背景
                            ctx.fillRect(0, 0, width, height);
                        }

                        ctx.drawImage(img, 0, 0, width, height);

                        // --- 关键修正：将输出格式改为 'image/jpeg' ---
                        // JPEG格式可以显著减小文件大小，避免浏览器处理超大Base64字符串时崩溃
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedDataUrl);
                    };
                };
            });
        }

        // --- Initial HTML Injection ---
        document.getElementById('api-settings-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">API 设置</h1></div><div class="placeholder"></div></header><main class="content"><form id="api-form"><div class="form-group"><label for="api-provider">API 服务商</label><select id="api-provider" name="provider"><option value="newapi">NewAPI (自定义)</option><option value="deepseek">DeepSeek</option><option value="claude">Claude</option><option value="gemini">Gemini</option></select></div><div class="form-group"><label for="api-url">API 地址（后缀不用添加/v1）</label><input type="url" id="api-url" name="url" placeholder="选择服务商可自动填写" required></div><div class="form-group"><label for="api-key">密钥 (Key)</label><input type="password" id="api-key" name="key" placeholder="请输入你的API密钥" required></div><button type="button" class="btn btn-secondary" id="fetch-models-btn"><span class="btn-text">点击拉取模型</span><div class="spinner"></div></button><div class="form-group"><label for="api-model">选择模型</label><select id="api-model" name="model" required><option value="">请先拉取模型列表</option></select></div><div class.blade.php="form-group" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #fce4ec; border-radius: 10px; background-color: #fff8fa;">
    <label for="time-perception-switch" style="margin-bottom: 0; color: var(--secondary-color); font-weight: 600;">时间感知加强</label>
    <input type="checkbox" id="time-perception-switch" style="width: auto; height: 20px; width: 20px;">
</div>
<button type="submit" class="btn btn-primary" id="save-btn"><span class="btn-text">保 存</span><div class="spinner"></div></button></form><div class="api-presets-embedded" style="margin-top:12px;"><div id="api-presets-control" style="margin:12px 0;padding:12px;border-radius:8px;border:1px solid var(--border-color, #eee);background:var(--panel-bg, #fff);box-shadow:var(--panel-shadow, none);"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><label style="min-width:86px;color:var(--muted,#666);">API 预设：</label><select id="api-preset-select" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;"><option value="">— 选择 API 预设 —</option></select><button id="api-apply-preset" class="btn btn-primary" style="margin-left:8px;padding:6px 10px;">应用</button></div><div style="display:flex;gap:8px;align-items:center;"><button id="api-save-preset" class="btn" style="padding:6px 10px;">另存为</button><button id="api-manage-presets" class="btn" style="padding:6px 10px;">管理</button><div style="flex:1"></div><button id="api-import-presets" class="btn" style="padding:6px 10px;">导入</button><button id="api-export-presets" class="btn" style="padding:6px 10px;">导出</button></div></div><div id="api-presets-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:9999;align-items:center;justify-content:center;"><div style="width:640px;max-width:94%;background:var(--panel-bg,#fff);padding:16px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12);"><h3 style="margin:0 0 12px 0;">API 预设管理</h3><div id="api-presets-list" style="max-height:360px;overflow:auto;border:1px solid #f0f0f0;padding:8px;border-radius:6px;"></div><div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;"><button id="api-close-modal" class="btn btn-primary">关闭</button></div></div></div></div></main>`;
        document.getElementById('wallpaper-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">更换壁纸</h1></div><div class="placeholder"></div></header><main class="content"><div class="wallpaper-preview" id="wallpaper-preview"><span>当前壁纸预览</span></div><input type="file" id="wallpaper-upload" accept="image/*" style="display: none;"><label for="wallpaper-upload" class="btn btn-primary">从相册选择新壁纸</label></main>`;
        document.getElementById('font-settings-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">字体设置</h1></div><div class="placeholder"></div></header><main class="content"><form id="font-settings-form"><div class="form-group"><label for="font-url">字体链接 (ttf, woff, woff2)</label><input type="url" id="font-url" placeholder="https://.../font.ttf" required></div><p style="font-size:12px; color:#888; text-align:center;">示例: https://lf3-static.bytednsdoc.com/obj/eden-cn/jplptk/ljhwZthlaukjlkulzlp/portal/fonts/HarmonyOS_Sans_SC_Regular.woff2</p><button type="submit" class="btn btn-primary">应用字体</button><button type="button" class="btn btn-neutral" id="restore-default-font-btn" style="margin-top: 15px;">恢复默认字体</button></form></main>`;
        document.getElementById('customize-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">主屏幕自定义</h1></div><div class="placeholder"></div></header><main class="content"><form id="customize-form"></form></main>`;
        document.getElementById('tutorial-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">教程</h1></div><div class="placeholder"></div></header><main class="content" id="tutorial-content-area"></main>`;

        // --- Global Variables and Constants ---
        const colorThemes = {
            'white_pink': {
                name: '白/粉',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(255,204,204,0.9)', text: '#A56767'}
            },
            'white_blue': {
                name: '白/蓝',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(173,216,230,0.9)', text: '#4A6F8A'}
            },
            'white_yellow': {
                name: '白/黄',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(249,237,105,0.9)', text: '#8B7E4B'}
            },
            'white_green': {
                name: '白/绿',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(188,238,188,0.9)', text: '#4F784F'}
            },
            'white_purple': {
                name: '白/紫',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(185,190,240,0.9)', text: '#6C5B7B'}
            },
            'black_red': {
                name: '黑/红',
                received: {bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0'},
                sent: {bg: 'rgb(226,62,87,0.9)', text: '#fff'}
            },
            'black_green': {
                name: '黑/绿',
                received: {bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0'},
                sent: {bg: 'rgba(119,221,119,0.9)', text: '#2E5C2E'}
            },
            'black_white': {
                name: '黑/白',
                received: {bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0'},
                sent: {bg: 'rgba(245,245,245,0.9)', text: '#333'}
            },
            'white_black': {
                name: '白/黑',
                received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
                sent: {bg: 'rgba(50,50,50,0.85)', text: '#F5F5F5'}
            },
            'yellow_purple': {
                name: '黄/紫',
                received: {bg: 'rgba(255,250,205,0.9)', text: '#8B7E4B'},
                sent: {bg: 'rgba(185,190,240,0.9)', text: '#6C5B7B'}
            },
            'pink_blue': {
                name: '粉/蓝',
                received: {bg: 'rgba(255,231,240,0.9)', text: '#7C6770'},
                sent: {bg: 'rgba(173,216,230,0.9)', text: '#4A6F8A'}
            },
        };
        const defaultWidgetSettings = {
            centralCircleImage: 'https://i.postimg.cc/mD83gR29/avatar-1.jpg',
            topLeft: { imageUrl: 'https://i.postimg.cc/B6q5Q6cY/chan-23.png', text: '心情' },
            topRight: { imageUrl: 'https://i.postimg.cc/tJ7x7kNg/chan-40.png', text: '天气' },
            bottomLeft: { imageUrl: 'https://i.postimg.cc/3J8R8PMb/chan-101.png', text: '音乐' },
            bottomRight: { imageUrl: 'https://i.postimg.cc/QdpgTfV9/chan-112.png', text: '待办' }
        };
               const defaultIcons = {
            'chat-list-screen': {name: '404', url: 'https://i.postimg.cc/VvQB8dQT/chan-143.png'},
            'api-settings-screen': {name: 'api', url: 'https://i.postimg.cc/50FqT8GL/chan-125.png'},
            'wallpaper-screen': {name: '壁纸', url: 'https://i.postimg.cc/3wqFttL3/chan-90.png'},
            'world-book-screen': {name: '世界书', url: 'https://i.postimg.cc/prCWkrKT/chan-74.png'},
            'customize-screen': {name: '自定义', url: 'https://i.postimg.cc/vZVdC7gt/chan-133.png'},
            'font-settings-screen': {name: '字体', url: 'https://i.postimg.cc/FzVtC0x4/chan-21.png'},
            'tutorial-screen': {name: '教程', url: 'https://i.postimg.cc/6QgNzCFf/chan-118.png'},
            'day-mode-btn': {name: '白昼模式', url: 'https://i.postimg.cc/Jz0tYqnT/chan-145.png'},
            'night-mode-btn': {name: '夜间模式', url: 'https://i.postimg.cc/htYvkdQK/chan-146.png'},
            'forum-screen': {name: '论坛', url: 'https://i.postimg.cc/fyPVBZf1/1758451183605.png'},
'music-screen': {name: '音乐', url: 'https://i.postimg.cc/ydd65txK/1758451018266.png'},
'diary-screen': {name: '日记本', url: 'https://i.postimg.cc/bJBLzmFH/chan-70.png'},
'piggy-bank-screen': {name: '存钱罐', url: 'https://i.postimg.cc/3RmWRRtS/chan-18.png'}
        };


        const peekScreenApps = {
            'messages': { name: '消息', url: 'https://i.postimg.cc/Kvs4tDh5/export202509181826424260.png' },
            'memos': { name: '备忘录', url: 'https://i.postimg.cc/JzD0xH1C/export202509181829064550.png' },
            'cart': { name: '购物车', url: 'https://i.postimg.cc/pLwT6VTh/export202509181830143960.png' },
            'transfer': { name: '中转站', url: 'https://i.postimg.cc/63wQBHCB/export202509181831140230.png' },
            'browser': { name: '浏览器', url: 'https://i.postimg.cc/SKcsF02Z/export202509181830445980.png' },
            'drafts': { name: '草稿箱', url: 'https://i.postimg.cc/ZKqC9D2R/export202509181827225860.png' },
            'album': { name: '相册', url: 'https://i.postimg.cc/qBcdpqNc/export202509221549335970.png' },
            'steps': { name: '步数', url: 'https://i.postimg.cc/5NndFrq6/export202509181824532800.png' },
            'unlock': { name: 'unlock！', url: 'https://i.postimg.cc/28zNyYWs/export202509221542593320.png' }
        };

        const simulatedMemos = [];

        let db = {
            characters: [],
            groups: [],
            apiSettings: {},
            wallpaper: 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg',
            myStickers: [],
            homeScreenMode: 'night',
            worldBooks: [],
            fontUrl: '',
            customIcons: {},
            apiPresets: [],
            bubbleCssPresets: [],
            myPersonaPresets: [],
            forumPosts: [],
            globalCss: '',
            globalCssPresets: [],
            homeSignature: '编辑个性签名...',
            forumBindings: { 
                worldBookIds: [],
                charIds: [],
                userPersonaIds: []
            },
        };
        let currentChatId = null, currentChatType = null, isGenerating = false, longPressTimer = null,
            isInMultiSelectMode = false, editingMessageId = null, currentPage = 1, currentTransferMessageId = null,
            currentEditingWorldBookId = null, currentStickerActionTarget = null,
            currentJournalDetailId = null,
            currentGroupAction = {type: null, recipients: []};
        let isStickerManageMode = false;
        let selectedStickerIds = new Set();
        let peekContentCache = {};
        let generatingPeekApps = new Set(); // Tracks which apps are currently generating content
        let selectedMessageIds = new Set();
        const MESSAGES_PER_PAGE = 50;

        // --- DOM Element Cache ---
        const screens = document.querySelectorAll('.screen'),
            toastElement = document.getElementById('toast-notification'),
            homeScreen = document.getElementById('home-screen'),
            chatListContainer = document.getElementById('chat-list-container'),
            noChatsPlaceholder = document.getElementById('no-chats-placeholder'),
            addChatBtn = document.getElementById('add-chat-btn'),
            addCharModal = document.getElementById('add-char-modal'),
            addCharForm = document.getElementById('add-char-form'),
            chatRoomScreen = document.getElementById('chat-room-screen'),
            chatRoomHeaderDefault = document.getElementById('chat-room-header-default'),
            chatRoomHeaderSelect = document.getElementById('chat-room-header-select'),
            cancelMultiSelectBtn = document.getElementById('cancel-multi-select-btn'),
            multiSelectTitle = document.getElementById('multi-select-title'),
            chatRoomTitle = document.getElementById('chat-room-title'),
            chatRoomStatusText = document.getElementById('chat-room-status-text'),
            messageArea = document.getElementById('message-area'),
            messageInputDefault = document.getElementById('message-input-default'),
            messageInput = document.getElementById('message-input'),
            sendMessageBtn = document.getElementById('send-message-btn'),
            getReplyBtn = document.getElementById('get-reply-btn'),
            typingIndicator = document.getElementById('typing-indicator'),
            chatSettingsBtn = document.getElementById('chat-settings-btn'),
            settingsSidebar = document.getElementById('chat-settings-sidebar'),
            settingsForm = document.getElementById('chat-settings-form'),
            messageEditBar = document.getElementById('message-edit-bar'),
            messageEditInput = document.getElementById('message-edit-input'),
            saveEditBtn = document.getElementById('save-edit-btn'),
            cancelEditBtn = document.getElementById('cancel-edit-btn'),
            multiSelectBar = document.getElementById('multi-select-bar'),
            selectCount = document.getElementById('select-count'),
            deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const regenerateBtn = document.getElementById('regenerate-btn'),
            stickerToggleBtn = document.getElementById('sticker-toggle-btn'),
            stickerModal = document.getElementById('sticker-modal'),
            stickerGridContainer = document.getElementById('sticker-grid-container'),
            addNewStickerBtn = document.getElementById('add-new-sticker-btn'),
            addStickerModal = document.getElementById('add-sticker-modal'),
            addStickerModalTitle = document.getElementById('add-sticker-modal-title'),
            addStickerForm = document.getElementById('add-sticker-form'),
            stickerEditIdInput = document.getElementById('sticker-edit-id'),
            stickerPreview = document.getElementById('sticker-preview'),
            stickerNameInput = document.getElementById('sticker-name'),
            stickerUrlInput = document.getElementById('sticker-url-input'),
            stickerFileUpload = document.getElementById('sticker-file-upload');
        const stickerActionSheet = document.getElementById('sticker-actionsheet'),
            editStickerBtn = document.getElementById('edit-sticker-btn'),
            deleteStickerBtn = document.getElementById('delete-sticker-btn');
        const voiceMessageBtn = document.getElementById('voice-message-btn'),
            sendVoiceModal = document.getElementById('send-voice-modal'),
            sendVoiceForm = document.getElementById('send-voice-form'),
            voiceTextInput = document.getElementById('voice-text-input'),
            voiceDurationPreview = document.getElementById('voice-duration-preview');
        const photoVideoBtn = document.getElementById('photo-video-btn'),
            sendPvModal = document.getElementById('send-pv-modal'),
            sendPvForm = document.getElementById('send-pv-form'),
            pvTextInput = document.getElementById('pv-text-input');
        const imageRecognitionBtn = document.getElementById('image-recognition-btn'),
            imageUploadInput = document.getElementById('image-upload-input');
        const walletBtn = document.getElementById('wallet-btn'),
            sendTransferModal = document.getElementById('send-transfer-modal'),
            sendTransferForm = document.getElementById('send-transfer-form'),
            transferAmountInput = document.getElementById('transfer-amount-input'),
            transferRemarkInput = document.getElementById('transfer-remark-input');
        const receiveTransferActionSheet = document.getElementById('receive-transfer-actionsheet'),
            acceptTransferBtn = document.getElementById('accept-transfer-btn'),
            returnTransferBtn = document.getElementById('return-transfer-btn');
        const giftBtn = document.getElementById('gift-btn'), sendGiftModal = document.getElementById('send-gift-modal'),
            sendGiftForm = document.getElementById('send-gift-form'),
            giftDescriptionInput = document.getElementById('gift-description-input');
        const timeSkipBtn = document.getElementById('time-skip-btn'),
            timeSkipModal = document.getElementById('time-skip-modal'),
            timeSkipForm = document.getElementById('time-skip-form'),
            timeSkipInput = document.getElementById('time-skip-input');
        const clearChatHistoryBtn = document.getElementById('clear-chat-history-btn');
        const worldBookListContainer = document.getElementById('world-book-list-container'),
            noWorldBooksPlaceholder = document.getElementById('no-world-books-placeholder'),
            addWorldBookBtn = document.getElementById('add-world-book-btn'),
            editWorldBookScreen = document.getElementById('edit-world-book-screen'),
            editWorldBookForm = document.getElementById('edit-world-book-form'),
            worldBookIdInput = document.getElementById('world-book-id'),
            worldBookNameInput = document.getElementById('world-book-name'),
            worldBookContentInput = document.getElementById('world-book-content');
        const linkWorldBookBtn = document.getElementById('link-world-book-btn'),
            worldBookSelectionModal = document.getElementById('world-book-selection-modal'),
            worldBookSelectionList = document.getElementById('world-book-selection-list'),
            saveWorldBookSelectionBtn = document.getElementById('save-world-book-selection-btn');
        const fontSettingsForm = document.getElementById('font-settings-form'),
            fontUrlInput = document.getElementById('font-url'),
            restoreDefaultFontBtn = document.getElementById('restore-default-font-btn');
        const createGroupBtn = document.getElementById('create-group-btn'),
            createGroupModal = document.getElementById('create-group-modal'),
            createGroupForm = document.getElementById('create-group-form'),
            memberSelectionList = document.getElementById('member-selection-list'),
            groupNameInput = document.getElementById('group-name-input'),
            groupSettingsSidebar = document.getElementById('group-settings-sidebar'),
            groupSettingsForm = document.getElementById('group-settings-form'),
            groupMembersListContainer = document.getElementById('group-members-list-container'),
            editGroupMemberModal = document.getElementById('edit-group-member-modal'),
            editGroupMemberForm = document.getElementById('edit-group-member-form');
        const addMemberActionSheet = document.getElementById('add-member-actionsheet'),
            inviteExistingMemberBtn = document.getElementById('invite-existing-member-btn'),
            createNewMemberBtn = document.getElementById('create-new-member-btn'),
            inviteMemberModal = document.getElementById('invite-member-modal'),
            inviteMemberSelectionList = document.getElementById('invite-member-selection-list'),
            confirmInviteBtn = document.getElementById('confirm-invite-btn'),
            createMemberForGroupModal = document.getElementById('create-member-for-group-modal'),
            createMemberForGroupForm = document.getElementById('create-member-for-group-form');
        const customizeForm = document.getElementById('customize-form'),
            tutorialContentArea = document.getElementById('tutorial-content-area');
        const groupRecipientSelectionModal = document.getElementById('group-recipient-selection-modal'),
            groupRecipientSelectionList = document.getElementById('group-recipient-selection-list'),
            confirmGroupRecipientBtn = document.getElementById('confirm-group-recipient-btn'),
            groupRecipientSelectionTitle = document.getElementById('group-recipient-selection-title');
        const linkGroupWorldBookBtn = document.getElementById('link-group-world-book-btn');

        // --- 优化的数据存储系统 ---
        class OptimizedDataStorage {
            constructor() {
                // 创建数据库
                this.db = new Dexie('章鱼喷墨机DB_V2');

                // 定义数据库结构
                this.db.version(1).stores({
                    // 基础数据存储
                    storage: 'key, value, timestamp',
                    // 消息分块存储
                    messageChunks: 'id, chatId, chatType, chunkIndex, messages, timestamp',
                    // 元数据存储
                    metadata: 'key, value, timestamp'
                });

                // LRU缓存配置
                this.cache = new Map();
                this.maxCacheSize = 50; // 最大缓存50个数据块
                this.chunkSize = 100; // 每个数据块100条消息

                // 性能监控
                this.performanceMetrics = {
                    cacheHits: 0,
                    cacheMisses: 0,
                    operationTimes: [],
                    memoryUsage: 0
                };
            }



            // LRU缓存管理
            updateCache(key, value) {
                if (this.cache.has(key)) {
                    this.cache.delete(key);
                }
                this.cache.set(key, value);

                if (this.cache.size > this.maxCacheSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }

                // 更新内存使用量估算
                this.performanceMetrics.memoryUsage = JSON.stringify([...this.cache.values()]).length;
            }

            // 从缓存获取数据
            getFromCache(key) {
                if (this.cache.has(key)) {
                    const value = this.cache.get(key);
                    // 移到最后（最近使用）
                    this.cache.delete(key);
                    this.cache.set(key, value);
                    this.performanceMetrics.cacheHits++;
                    return value;
                }
                this.performanceMetrics.cacheMisses++;
                return null;
            }

            // 保存基础数据（非消息数据）
            async saveData(key, data) {
                const startTime = Date.now();
                try {
                    const item = {
                        key: key,
                        value: JSON.stringify(data),
                        timestamp: Date.now()
                    };

                    await this.db.storage.put(item);
                    this.updateCache(key, data);
                    console.log(`数据已保存: ${key}`);
                    return true;
                } catch (error) {
                    console.error('保存数据失败:', error);
                    return false;
                }
            }

            // 获取基础数据
            async getData(key) {
                const startTime = Date.now();
                try {
                    // 先检查缓存
                    const cached = this.getFromCache(key);
                    if (cached !== null) {
                        return cached;
                    }

                    const item = await this.db.storage.get(key);
                    if (item) {
                        const data = JSON.parse(item.value);
                        this.updateCache(key, data);
                        return data;
                    } else {
                        console.log(`未找到数据: ${key}`);
                        return null;
                    }
                } catch (error) {
                    console.error('获取数据失败:', error);
                    return null;
                }
            }

            // 保存聊天消息（分块存储）
            async saveChatMessages(chatId, chatType, messages) {
                const startTime = Date.now();
                try {
                    // 清除该聊天的所有现有分块
                    await this.db.messageChunks.where('chatId').equals(chatId).and(chunk => chunk.chatType === chatType).delete();

                    // 将消息分块存储
                    const chunks = [];
                    for (let i = 0; i < messages.length; i += this.chunkSize) {
                        const chunkMessages = messages.slice(i, i + this.chunkSize);
                        const chunkId = `${chatId}_${chatType}_${Math.floor(i / this.chunkSize)}`;

                        chunks.push({
                            id: chunkId,
                            chatId: chatId,
                            chatType: chatType,
                            chunkIndex: Math.floor(i / this.chunkSize),
                            messages: chunkMessages,
                            timestamp: Date.now()
                        });
                    }

                    if (chunks.length > 0) {
                        await this.db.messageChunks.bulkPut(chunks);
                    }

                    // 更新缓存
                    const cacheKey = `messages_${chatId}_${chatType}`;
                    this.updateCache(cacheKey, messages);

                    console.log(`消息已分块保存: ${chatId} (${chunks.length}个分块)`);
                    return true;
                } catch (error) {
                    console.error('保存消息失败:', error);
                    return false;
                }
            }

            // 获取聊天消息（按需加载）
            async getChatMessages(chatId, chatType, limit = null, offset = 0) {
                const startTime = Date.now();
                try {
                    const cacheKey = `messages_${chatId}_${chatType}`;

                    // 如果没有限制，先检查缓存
                    if (!limit) {
                        const cached = this.getFromCache(cacheKey);
                        if (cached !== null) {
                            return cached;
                        }
                    }

                    // 从数据库获取分块
                    const chunks = await this.db.messageChunks
                        .where('chatId').equals(chatId)
                        .and(chunk => chunk.chatType === chatType)
                        .sortBy('chunkIndex');

                    if (chunks.length === 0) {
                        return [];
                    }

                    // 合并所有消息
                    let allMessages = [];
                    chunks.forEach(chunk => {
                        allMessages = allMessages.concat(chunk.messages);
                    });

                    // 如果没有限制，更新缓存
                    if (!limit) {
                        this.updateCache(cacheKey, allMessages);
                    }

                    // 应用分页
                    if (limit) {
                        const result = allMessages.slice(offset, offset + limit);
                        return result;
                    }

                    return allMessages;
                } catch (error) {
                    console.error('获取消息失败:', error);
                    return [];
                }
            }

            // 添加单条消息（增量更新）
            async addMessage(chatId, chatType, message) {
                const startTime = Date.now();
                try {
                    // 获取当前消息
                    const currentMessages = await this.getChatMessages(chatId, chatType);
                    currentMessages.push(message);

                    // 重新保存（会自动分块）
                    await this.saveChatMessages(chatId, chatType, currentMessages);

                    return true;
                } catch (error) {
                    console.error('添加消息失败:', error);
                    return false;
                }
            }

            // 删除消息
            async deleteMessage(chatId, chatType, messageId) {
                const startTime = Date.now();
                try {
                    const currentMessages = await this.getChatMessages(chatId, chatType);
                    const filteredMessages = currentMessages.filter(msg => msg.id !== messageId);

                    await this.saveChatMessages(chatId, chatType, filteredMessages);


                    return true;
                } catch (error) {
                    console.error('删除消息失败:', error);

                    return false;
                }
            }

            // 更新消息
            async updateMessage(chatId, chatType, messageId, updatedMessage) {
                const startTime = Date.now();
                try {
                    const currentMessages = await this.getChatMessages(chatId, chatType);
                    const messageIndex = currentMessages.findIndex(msg => msg.id === messageId);

                    if (messageIndex !== -1) {
                        currentMessages[messageIndex] = { ...currentMessages[messageIndex], ...updatedMessage };
                        await this.saveChatMessages(chatId, chatType, currentMessages);

                        return true;
                    }

                    return false;
                } catch (error) {
                    console.error('更新消息失败:', error);

                    return false;
                }
            }

            // 清空聊天记录
            async clearChatMessages(chatId, chatType) {
                const startTime = Date.now();
                try {
                    await this.db.messageChunks.where('chatId').equals(chatId).and(chunk => chunk.chatType === chatType).delete();

                    // 清除缓存
                    const cacheKey = `messages_${chatId}_${chatType}`;
                    this.cache.delete(cacheKey);


                    return true;
                } catch (error) {
                    console.error('清空消息失败:', error);

                    return false;
                }
            }

            // 删除数据
            async removeData(key) {
                const startTime = Date.now();
                try {
                    await this.db.storage.delete(key);
                    this.cache.delete(key);
                    console.log(`数据已删除: ${key}`);

                    return true;
                } catch (error) {
                    console.error('删除数据失败:', error);

                    return false;
                }
            }

            // 清空所有数据
            async clearAll() {
                const startTime = Date.now();
                try {
                    await this.db.storage.clear();
                    await this.db.messageChunks.clear();
                    await this.db.metadata.clear();
                    this.cache.clear();
                    console.log('所有数据已清空');

                    return true;
                } catch (error) {
                    console.error('清空数据失败:', error);

                    return false;
                }
            }

            // 获取所有存储的键
            async getAllKeys() {
                try {
                    const storageItems = await this.db.storage.toArray();
                    return storageItems.map(item => item.key);
                } catch (error) {
                    console.error('获取所有键失败:', error);
                    return [];
                }
            }

            // 获取存储信息
            async getStorageInfo() {
                const startTime = Date.now();
                try {
                    const [storageItems, messageChunks] = await Promise.all([
                        this.db.storage.toArray(),
                        this.db.messageChunks.toArray()
                    ]);

                    const storageSize = storageItems.reduce((sum, item) => sum + item.value.length, 0);
                    const messageSize = messageChunks.reduce((sum, chunk) => sum + JSON.stringify(chunk.messages).length, 0);
                    const totalSize = storageSize + messageSize;

                    const info = {
                        itemCount: storageItems.length,
                        chunkCount: messageChunks.length,
                        totalSize: totalSize,
                        storageSize: storageSize,
                        messageSize: messageSize,
                        cacheSize: this.cache.size,
                        items: storageItems.map(item => ({
                            key: item.key,
                            size: item.value.length,
                            timestamp: new Date(item.timestamp).toLocaleString()
                        }))
                    };

                    // 更新显示
                    this.updateStorageDisplay(info);

                    return info;
                } catch (error) {
                    console.error('获取存储信息失败:', error);

                    return null;
                }
            }

            // 更新存储信息显示
            updateStorageDisplay(info) {
                const monitor = document.getElementById('performance-monitor');
                if (!monitor) return;

                document.getElementById('storage-size').textContent = `${(info.totalSize / 1024).toFixed(1)} KB`;
                document.getElementById('chunk-count').textContent = info.chunkCount.toString();

                // 设置存储大小颜色指示器
                const sizeElement = document.getElementById('storage-size');
                const sizeKB = info.totalSize / 1024;
                if (sizeKB < 1000) sizeElement.className = 'metric-value good';
                else if (sizeKB < 5000) sizeElement.className = 'metric-value warning';
                else sizeElement.className = 'metric-value error';
            }

            // 数据迁移方法（从旧版本迁移）
            async migrateFromOldStorage() {
                const startTime = Date.now();
                let oldDb = null;
                let migrationSuccess = false;

                try {
                    // 尝试从旧数据库获取数据
                    oldDb = new Dexie('章鱼喷墨机DB');
                    oldDb.version(1).stores({
                        storage: 'key, value, timestamp'
                    });

                    // 检查旧数据库是否存在数据
                    const oldData = await oldDb.storage.get('章鱼喷墨机');
                    if (oldData) {
                        console.log('检测到旧数据库，开始迁移...');
                        const data = JSON.parse(oldData.value);

                        // 迁移基础数据
                        const { characters, groups, ...baseData } = data;
                        await this.saveData('章鱼喷墨机', baseData);

                        let migratedCharacters = 0;
                        let migratedGroups = 0;

                        // 迁移角色消息
                        if (characters) {
                            for (const char of characters) {
                                if (char.history && char.history.length > 0) {
                                    await this.saveChatMessages(char.id, 'private', char.history);
                                }
                                // 保存角色信息（不包含history）
                                const { history, ...charData } = char;
                                charData.history = []; // 保持兼容性
                                await this.saveData(`character_${char.id}`, charData);
                                migratedCharacters++;
                            }
                        }

                        // 迁移群组消息
                        if (groups) {
                            for (const group of groups) {
                                if (group.history && group.history.length > 0) {
                                    await this.saveChatMessages(group.id, 'group', group.history);
                                }
                                // 保存群组信息（不包含history）
                                const { history, ...groupData } = group;
                                groupData.history = []; // 保持兼容性
                                await this.saveData(`group_${group.id}`, groupData);
                                migratedGroups++;
                            }
                        }

                        migrationSuccess = true;
                        console.log(`数据迁移完成: ${migratedCharacters}个角色, ${migratedGroups}个群组`);

                        // 迁移成功后立即删除旧数据库
                        try {
                            console.log('开始删除旧数据库...');

                            // 关闭数据库连接
                            if (oldDb.isOpen()) {
                                oldDb.close();
                            }

                            // 删除整个数据库
                            await oldDb.delete();
                            console.log('旧数据库删除成功');

                            // 验证删除是否成功
                            const deletedDb = new Dexie('章鱼喷墨机DB');
                            try {
                                deletedDb.version(1).stores({
                                    storage: 'key, value, timestamp'
                                });
                                const testData = await deletedDb.storage.get('章鱼喷墨机');
                                if (!testData) {
                                    console.log('旧数据库删除验证成功');
                                } else {
                                    console.warn('旧数据库可能未完全删除');
                                }
                                deletedDb.close();
                            } catch (verifyError) {
                                // 如果无法访问，说明删除成功
                                console.log('旧数据库删除验证成功（数据库不存在）');
                            }

                        } catch (deleteError) {
                            console.error('删除旧数据库失败，但不影响主要功能:', deleteError);
                            // 尝试清空数据而不是删除数据库
                            try {
                                if (!oldDb.isOpen()) {
                                    await oldDb.open();
                                }
                                await oldDb.storage.clear();
                                console.log('已清空旧数据库内容');
                                oldDb.close();
                            } catch (clearError) {
                                console.error('清空旧数据库也失败:', clearError);
                            }
                        }

                        return true;
                    } else {
                        console.log('未发现旧数据库数据');
                        // 即使没有数据，也尝试删除可能存在的空数据库
                        try {
                            if (oldDb.isOpen()) {
                                oldDb.close();
                            }
                            await oldDb.delete();
                            console.log('已删除空的旧数据库');
                        } catch (deleteError) {
                            // 删除失败可能是因为数据库不存在，这是正常的
                            console.log('旧数据库不存在或已删除');
                        }
                        return false;
                    }


                    return false;
                } catch (error) {
                    console.error('数据迁移失败:', error);

                    // 即使迁移失败，也尝试清理旧数据库连接
                    if (oldDb) {
                        try {
                            if (oldDb.isOpen()) {
                                oldDb.close();
                                console.log('已关闭旧数据库连接');
                            }
                        } catch (closeError) {
                            console.error('关闭旧数据库连接失败:', closeError);
                        }
                    }

                    return false;
                } finally {
                    // 确保在任何情况下都记录迁移耗时
                    const duration = Date.now() - startTime;
                    console.log(`数据迁移操作完成，耗时: ${duration}ms, 成功: ${migrationSuccess}`);
                }
            }
        }

        const dataStorage = new OptimizedDataStorage();

        // 兼容性适配器 - 保持原有API接口
        const saveData = async (data) => {
            const dbData = data ? data : db;

            // 分离消息数据和基础数据
            const { characters, groups, ...baseData } = dbData;

            // 保存基础数据
            await dataStorage.saveData('章鱼喷墨机', baseData);

            // 分别保存角色和群组数据（包含消息）
            if (characters) {
                for (const char of characters) {
                    if (char.history && char.history.length > 0) {
    await dataStorage.saveChatMessages(char.id, 'private', char.history);
} else {
    // 如果历史记录为空，则清空数据库中的消息
    await dataStorage.clearChatMessages(char.id, 'private');
}
                    // 保存角色基础信息（不包含history）
                    const { history, ...charData } = char;
                    charData.history = []; // 保持兼容性
                    await dataStorage.saveData(`character_${char.id}`, charData);
                }
            }

            if (groups) {
                for (const group of groups) {
                    // 保存消息到分块存储
                    if (group.history && group.history.length > 0) {
    await dataStorage.saveChatMessages(group.id, 'group', group.history);
} else {
    // 如果历史记录为空，则清空数据库中的消息
    await dataStorage.clearChatMessages(group.id, 'group');
}
                    // 保存群组基础信息（不包含history）
                    const { history, ...groupData } = group;
                    groupData.history = []; // 保持兼容性
                    await dataStorage.saveData(`group_${group.id}`, groupData);
                }
            }

            if(dbData.apiSettings){
                await dataStorage.saveData('apiSettings', dbData.apiSettings);
            }
            if(dbData.customIcons){
                await dataStorage.saveData('customIcons', dbData.customIcons);
            }
            if(dbData.apiPresets){
                await dataStorage.saveData('apiPresets', dbData.apiPresets);
            }
            if(dbData.bubbleCssPresets){
                await dataStorage.saveData('bubbleCssPresets', dbData.bubbleCssPresets);
            }
            if(dbData.myPersonaPresets){
                await dataStorage.saveData('myPersonaPresets', dbData.myPersonaPresets);
            }
            if(dbData.globalCssPresets){
                await dataStorage.saveData('globalCssPresets', dbData.globalCssPresets);
            }
            if(dbData.globalCss){
                await dataStorage.saveData('globalCss', dbData.globalCss);
            }
            if(dbData.fontUrl){
                await dataStorage.saveData('fontUrl', dbData.fontUrl);
            }
            if(dbData.homeScreenMode){
                await dataStorage.saveData('homeScreenMode', dbData.homeScreenMode);
            }
            
            if(dbData.forumPosts){
    await dataStorage.saveData('forumPosts', dbData.forumPosts);
}

return Promise.resolve();
            
            if(dbData.wallpaper){
                await dataStorage.saveData('wallpaper', dbData.wallpaper);
            }
            return Promise.resolve();
        };

        const loadData = async () => {
            // 首先尝试数据迁移
            await dataStorage.migrateFromOldStorage();

            // 检查localStorage中的旧数据
            const oldData = localStorage.getItem('gemini-chat-app-db');
            if (oldData) {
                console.log('检测到localStorage中的旧数据，开始迁移...');
                await saveData(JSON.parse(oldData));
                localStorage.removeItem('gemini-chat-app-db');
                console.log('localStorage旧数据迁移完成并已清理');
            }

            // 额外的安全检查：确保旧数据库完全清理
            try {
                const safetyCheckDb = new Dexie('章鱼喷墨机DB');
                safetyCheckDb.version(1).stores({
                    storage: 'key, value, timestamp'
                });

                const residualData = await safetyCheckDb.storage.get('章鱼喷墨机');
                if (residualData) {
                    console.warn('发现残留的旧数据库数据，执行强制清理...');
                    await safetyCheckDb.storage.clear();
                    safetyCheckDb.close();
                    await safetyCheckDb.delete();
                    console.log('残留旧数据库已强制清理');
                } else {
                    safetyCheckDb.close();
                }
            } catch (safetyError) {
                // 如果无法访问旧数据库，说明已经被正确删除
                console.log('旧数据库安全检查完成（数据库不存在）');
            }

            // 加载基础数据
            let data = await dataStorage.getData('章鱼喷墨机');
            if (data) {
                db = { ...db, ...data };
            }

            // 初始化默认值
            if (!db.apiSettings) db.apiSettings = {};
            if (!db.wallpaper) db.wallpaper = 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg';
            if (!db.myStickers) db.myStickers = [];
            if (!db.homeScreenMode) db.homeScreenMode = 'night';
            if (!db.worldBooks) db.worldBooks = [];
            if (!db.fontUrl) db.fontUrl = '';
            if (!db.customIcons) db.customIcons = {};

            // 加载预设数据
            db.apiPresets = await dataStorage.getData('apiPresets') || [];
            db.bubbleCssPresets = await dataStorage.getData('bubbleCssPresets') || [];
            db.myPersonaPresets = await dataStorage.getData('myPersonaPresets') || [];
            db.globalCssPresets = await dataStorage.getData('globalCssPresets') || [];
            db.globalCss = await dataStorage.getData('globalCss') || '';
            db.forumPosts = await dataStorage.getData('forumPosts') || [];

            // 重建characters和groups列表
            // 由于saveData时这两个字段被排除，需要从存储中重新构建
            db.characters = [];
            db.groups = [];

            // 获取所有存储的键，找出角色和群组数据
            const allKeys = await dataStorage.getAllKeys();
            const characterKeys = allKeys.filter(key => key.startsWith('character_'));
            const groupKeys = allKeys.filter(key => key.startsWith('group_'));

            console.log(`发现 ${characterKeys.length} 个角色数据, ${groupKeys.length} 个群组数据`);

            // 加载角色数据
            const characterPromises = characterKeys.map(async (key) => {
                const charId = key.replace('character_', '');
                const charData = await dataStorage.getData(key);
                if (charData) {
                    // 按需加载消息历史
                    charData.history = await dataStorage.getChatMessages(charId, 'private');

                    // 设置默认值
                    if (charData.isPinned === undefined) charData.isPinned = false;
                    if (charData.status === undefined) charData.status = '在线';
                    if (!charData.worldBookIds) charData.worldBookIds = [];
                    if (charData.customBubbleCss === undefined) charData.customBubbleCss = '';
                    if (charData.useCustomBubbleCss === undefined) charData.useCustomBubbleCss = false;
                    if (!charData.memoryJournals) charData.memoryJournals = []; // Ensure memoryJournals exists
                    if (!charData.journalWorldBookIds) charData.journalWorldBookIds = []; // 新增：确保字段存在
 
                    if (!charData.peekScreenSettings) {
                       charData.peekScreenSettings = { wallpaper: '', customIcons: {}, unlockAvatar: '' };
                    }
                     return charData;
                 }
                return null;
            });

            // 加载群组数据
            const groupPromises = groupKeys.map(async (key) => {
                const groupId = key.replace('group_', '');
                const groupData = await dataStorage.getData(key);
                if (groupData) {
                    // 按需加载消息历史
                    groupData.history = await dataStorage.getChatMessages(groupId, 'group');

                    // 设置默认值
                    if (groupData.isPinned === undefined) groupData.isPinned = false;
                    if (!groupData.worldBookIds) groupData.worldBookIds = [];
                    if (groupData.customBubbleCss === undefined) groupData.customBubbleCss = '';
                    if (groupData.useCustomBubbleCss === undefined) groupData.useCustomBubbleCss = false;

                    return groupData;
                }
                return null;
            });

            // 等待所有数据加载完成
            const [loadedCharacters, loadedGroups] = await Promise.all([
                Promise.all(characterPromises),
                Promise.all(groupPromises)
            ]);

            // 过滤掉null值并赋值给db
            db.characters = loadedCharacters.filter(char => char !== null);
            db.groups = loadedGroups.filter(group => group !== null);

            console.log(`成功加载 ${db.characters.length} 个角色, ${db.groups.length} 个群组`);
            console.log('完整数据库对象:', db);

            // 启动性能监控和数据完整性检查
            setTimeout(async () => {
                dataStorage.getStorageInfo();

                // 执行数据完整性验证
                const validation = await validateDataIntegrity();
                if (!validation.isValid) {
                    console.warn('数据完整性检查发现问题:', validation.issues);
                    // 可以选择显示警告或自动修复
                }
            }, 1000);



            // 在 loadData 函数的末尾
            if (!db.forumBindings) {
                db.forumBindings = {
                    worldBookIds: [],
                    charIds: [],
                    userPersonaIds: []
                };
            }

            return Promise.resolve();
        };

        const showToast = (message) => {
            toastElement.textContent = message;
            toastElement.classList.add('show');
            setTimeout(() => toastElement.classList.remove('show'), 3000);
        };
        const switchScreen = (targetId) => {
            screens.forEach(screen => screen.classList.remove('active'));
            document.getElementById(targetId)?.classList.add('active');
            // Close all overlays and sidebars
            const overlays = document.querySelectorAll('.modal-overlay, .action-sheet-overlay, .settings-sidebar');
            overlays.forEach(o => o.classList.remove('visible', 'open'));
        };
        const pad = (num) => num.toString().padStart(2, '0');

        function createContextMenu(items, x, y) {
            removeContextMenu();
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            items.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'context-menu-item';
                if (item.danger) menuItem.classList.add('danger');
                menuItem.textContent = item.label;
                menuItem.onclick = () => {
                    item.action();
                    removeContextMenu();
                };
                menu.appendChild(menuItem);
            });
            document.body.appendChild(menu);
            document.addEventListener('click', removeContextMenu, {once: true});
        }

        function removeContextMenu() {
            const menu = document.querySelector('.context-menu');
            if (menu) menu.remove();
        }

        function updateCustomBubbleStyle(chatId, css, enabled) {
            const styleId = `custom-bubble-style-for-${chatId}`;
            let styleElement = document.getElementById(styleId);

            if (enabled && css) {
                if (!styleElement) {
                    styleElement = document.createElement('style');
                    styleElement.id = styleId;
                    document.head.appendChild(styleElement);
                }
                const scopedCss = css.replace(/(\.message-bubble(?:\.sent|\.received)?)/g, `#chat-room-screen.chat-active-${chatId} $1`);
                styleElement.innerHTML = scopedCss;
            } else {
                if (styleElement) styleElement.remove();
            }
        }

        function updateBubbleCssPreview(previewContainer, css, useDefault, theme) {
            previewContainer.innerHTML = '';

            const sentBubble = document.createElement('div');
            sentBubble.className = 'message-bubble sent';
            sentBubble.textContent = '这是我方气泡。';
            sentBubble.style.alignSelf = 'flex-end';
            sentBubble.style.borderBottomRightRadius = '5px';

            const receivedBubble = document.createElement('div');
            receivedBubble.className = 'message-bubble received';
            receivedBubble.textContent = '这是对方气泡。';
            receivedBubble.style.alignSelf = 'flex-start';
            receivedBubble.style.borderBottomLeftRadius = '5px';

            [sentBubble, receivedBubble].forEach(bubble => {
                bubble.style.maxWidth = '70%';
                bubble.style.padding = '8px 12px';
                bubble.style.wordWrap = 'break-word';
                bubble.style.lineHeight = '1.4';
            });

            if (useDefault || !css) {
                sentBubble.style.backgroundColor = theme.sent.bg;
                sentBubble.style.color = theme.sent.text;
                sentBubble.style.borderRadius = '18px';
                sentBubble.style.borderBottomRightRadius = '5px';
                receivedBubble.style.backgroundColor = theme.received.bg;
                receivedBubble.style.color = theme.received.text;
                receivedBubble.style.borderRadius = '18px';
                receivedBubble.style.borderBottomLeftRadius = '5px';
            } else {
                const styleTag = document.createElement('style');
                const scopedCss = css.replace(/(\.message-bubble(?:\.sent|\.received)?)/g, `#${previewContainer.id} $1`);
                styleTag.textContent = scopedCss;
                previewContainer.appendChild(styleTag);
            }
            previewContainer.appendChild(receivedBubble);
            previewContainer.appendChild(sentBubble);
        }

        const init = async () => {
            await loadData();
            if (!db.homeWidgetSettings || !db.homeWidgetSettings.topLeft) {
            db.homeWidgetSettings = JSON.parse(JSON.stringify(defaultWidgetSettings));
            }
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('.context-menu')) {
                    e.stopPropagation();
                    return;
                }
                removeContextMenu();

                const backBtn = e.target.closest('.back-btn');
                if (backBtn) {
                    e.preventDefault();
                    switchScreen(backBtn.getAttribute('data-target'));
                }

                // Consolidated overlay closing logic
                const openOverlay = document.querySelector('.modal-overlay.visible, .action-sheet-overlay.visible');
                if (openOverlay && e.target === openOverlay) {
                    openOverlay.classList.remove('visible');
                }
            });

            // Specific nav links that switch screens
            document.body.addEventListener('click', e => {
                const navLink = e.target.closest('.app-icon[data-target]');
                if (navLink) {
                    e.preventDefault();
                    const target = navLink.getAttribute('data-target');
                    if (target === 'music-screen' || target === 'diary-screen' || target === 'piggy-bank-screen') {
                        showToast('该应用正在开发中，敬请期待！');
                        return;
                    }
                    switchScreen(target);
                }
            });

            updateClock();
            setInterval(updateClock, 30000);
            applyGlobalFont(db.fontUrl);
            applyGlobalCss(db.globalCss);
            setupHomeScreen();
            setupChatListScreen();
            setupAddCharModal();
            setupChatRoom();
            setupChatSettings();
            setupApiSettingsApp();
            setupWallpaperApp();
            await setupStickerSystem();
            setupPresetFeatures();
            setupVoiceMessageSystem();
            setupPhotoVideoSystem();
            setupImageRecognition();
            setupWalletSystem();
            setupGiftSystem();
            setupTimeSkipSystem();
            setupWorldBookApp();
            setupFontSettingsApp();
            setupGroupChatSystem();
            setupCustomizeApp();
            setupTutorialApp();
            setupPeekFeature();
            setupChatExpansionPanel();
            setupMemoryJournalScreen(); // 新增：初始化回忆日记功能
            setupDeleteHistoryChunk();
            setupForumBindingFeature();
            setupForumFeature();
            setupShareModal();
        };

        function setupMemoryJournalScreen() {
            const generateNewJournalBtn = document.getElementById('generate-new-journal-btn');
            const generateJournalModal = document.getElementById('generate-journal-modal');
            const generateJournalForm = document.getElementById('generate-journal-form');
            const journalListContainer = document.getElementById('journal-list-container');
            const editDetailBtn = document.getElementById('edit-journal-detail-btn');
            const bindWorldBookBtn = document.getElementById('bind-journal-worldbook-btn');
            const journalWorldBookModal = document.getElementById('journal-worldbook-selection-modal');
            const journalWorldBookList = document.getElementById('journal-worldbook-selection-list');
            const saveJournalWorldBookBtn = document.getElementById('save-journal-worldbook-selection-btn');

            // 新增：绑定世界书按钮事件
            bindWorldBookBtn.addEventListener('click', () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;

                journalWorldBookList.innerHTML = ''; // 清空列表
                if (db.worldBooks.length === 0) {
                    journalWorldBookList.innerHTML = '<li style="color: #888; text-align: center;">暂无世界书条目</li>';
                } else {
                    db.worldBooks.forEach(book => {
                        const li = document.createElement('li');
                        li.className = 'world-book-select-item';
                        const isChecked = (character.journalWorldBookIds || []).includes(book.id);
                        li.innerHTML = `<input type="checkbox" id="journal-wb-select-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}><label for="journal-wb-select-${book.id}">${book.name}</label>`;
                        journalWorldBookList.appendChild(li);
                    });
                }
                journalWorldBookModal.classList.add('visible');
            });

            // 新增：保存世界书绑定
            saveJournalWorldBookBtn.addEventListener('click', async () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;

                const selectedIds = Array.from(journalWorldBookList.querySelectorAll('input:checked')).map(input => input.value);
                character.journalWorldBookIds = selectedIds;
                await saveData();
                journalWorldBookModal.classList.remove('visible');
                showToast('日记绑定的世界书已更新');
            });

             // "生成新日记" 按钮 -> 弹出范围选择模态框
            generateNewJournalBtn.addEventListener('click', () => {
                const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
                const totalMessages = chat ? chat.history.length : 0;
                
                const rangeInfo = document.getElementById('journal-range-info');
                rangeInfo.textContent = `当前聊天总消息数: ${totalMessages}`;

                generateJournalForm.reset();
                generateJournalModal.classList.add('visible');
            });

            // 范围选择表单提交
            generateJournalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const startInput = document.getElementById('journal-range-start');
                const endInput = document.getElementById('journal-range-end');

                const start = parseInt(startInput.value);
                const end = parseInt(endInput.value);
                
                if (isNaN(start) || isNaN(end) || start <= 0 || end < start) {
                    showToast('请输入有效的起止范围');
                    return;
                }

                generateJournalModal.classList.remove('visible');
                await generateJournal(start, end);
            });

            // 点击列表容器中的项目 (事件委托)
            journalListContainer.addEventListener('click', async (e) => {
                const target = e.target;
                const card = target.closest('.journal-card');
                if (!card) return;

                const journalId = card.dataset.id;
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;
                const journal = character.memoryJournals.find(j => j.id === journalId);
                if (!journal) return;

                // --- Handle Action Buttons ---
                if (target.closest('.delete-journal-btn')) {
                    if (confirm('确定要删除这篇日记吗？')) {
                        character.memoryJournals = character.memoryJournals.filter(j => j.id !== journalId);
                        await saveData();
                        renderJournalList();
                        showToast('日记已删除');
                    }
                    return;
                }

                if (target.closest('.favorite-journal-btn')) {
                    journal.isFavorited = !journal.isFavorited;
                    await saveData();
                    target.closest('.favorite-journal-btn').classList.toggle('favorited', journal.isFavorited);
                    showToast(journal.isFavorited ? '已收藏' : '已取消收藏');
                    return;
                }
                
                // --- Handle Navigation to Detail Screen ---
                const date = new Date(journal.createdAt);
                const formattedDate = `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
                
                currentJournalDetailId = journal.id;

                const titleEl = document.getElementById('journal-detail-title');
                const contentEl = document.getElementById('journal-detail-content');

                titleEl.isContentEditable = false;
                contentEl.isContentEditable = false;
                titleEl.style.border = 'none';
                contentEl.style.border = 'none';
                titleEl.style.padding = '0';
                contentEl.style.padding = '0';
                editDetailBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>`;

                titleEl.textContent = journal.title;
                document.getElementById('journal-detail-meta').textContent = `创建于 ${formattedDate} | 消息范围: ${journal.range.start}-${journal.range.end}`;
                document.getElementById('journal-detail-content').textContent = journal.content;
                
                switchScreen('memory-journal-detail-screen');
            });

            // --- NEW: Event listener for the detail page edit button ---
            editDetailBtn.addEventListener('click', async () => {
                if (!currentJournalDetailId) return;

                const titleEl = document.getElementById('journal-detail-title');
                const contentEl = document.getElementById('journal-detail-content');
                const isEditing = titleEl.isContentEditable;

                if (isEditing) {
                    // --- SAVE LOGIC ---
                    const character = db.characters.find(c => c.id === currentChatId);
                    if (!character) return;
                    const journal = character.memoryJournals.find(j => j.id === currentJournalDetailId);
                    if (!journal) return;

                    journal.title = titleEl.textContent.trim();
                    journal.content = contentEl.textContent.trim();
                    await saveData();

                    titleEl.isContentEditable = false;
                    contentEl.isContentEditable = false;
                    titleEl.style.border = 'none';
                    contentEl.style.border = 'none';
                    titleEl.style.padding = '0';
                    contentEl.style.padding = '0';
                    editDetailBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>`;
                    showToast('日记已保存');
                    renderJournalList(); // Re-render list to show updated title if changed
                } else {
                    // --- EDIT LOGIC ---
                    titleEl.setAttribute('contenteditable', 'true');
                    contentEl.setAttribute('contenteditable', 'true');
                    titleEl.style.border = '1px dashed #ccc';
                    titleEl.style.padding = '5px';
                    contentEl.style.border = '1px dashed #ccc';
                    contentEl.style.padding = '10px';
                    editDetailBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9,16.17L4.83,12L3.41,13.41L9,19L21,7L19.59,5.59L9,16.17Z" /></svg>`; // Checkmark icon
                    titleEl.focus();
                }
            });
        }

        function renderJournalList() {
            const container = document.getElementById('journal-list-container');
            const placeholder = document.getElementById('no-journals-placeholder');
            container.innerHTML = '';

            const character = db.characters.find(c => c.id === currentChatId);
            const journals = character ? character.memoryJournals : [];

            if (!journals || journals.length === 0) {
                placeholder.style.display = 'block';
                return;
            }

            placeholder.style.display = 'none';

            const sortedJournals = [...journals].sort((a, b) => a.createdAt - b.createdAt);

            sortedJournals.forEach(journal => {
                const card = document.createElement('li');
                card.className = 'journal-card';
                card.dataset.id = journal.id;

                const date = new Date(journal.createdAt);
                const formattedDate = `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;

                card.innerHTML = `
                    <div class="journal-card-header">
                        <div class="journal-card-title">${journal.title}</div>
                    </div>
                    <div class="journal-card-actions">
                        <button class="action-icon-btn favorite-journal-btn" title="收藏">
                            <svg viewBox="0 0 24 24">
                                <path class="star-outline" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z" fill="currentColor"/>
                                <path class="star-solid" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"/>
                            </svg>
                        </button>
                        <button class="action-icon-btn delete-journal-btn" title="删除">
                            <svg viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>
                        </button>
                    </div>
                    <div class="journal-card-footer" style="justify-content: space-between; height: auto; opacity: 1; margin-top: 10px;">
                        <span class="journal-card-date">${formattedDate}</span>
                        <span class="journal-card-range">范围: ${journal.range.start}-${journal.range.end}</span>
                    </div>
                `;

                if (journal.isFavorited) {
                    card.querySelector('.favorite-journal-btn').classList.add('favorited');
                }

                container.appendChild(card);
            });

            // 为相册刷新按钮添加事件监听
            const refreshAlbumBtn = document.getElementById('refresh-album-btn');
            if(refreshAlbumBtn) {
                refreshAlbumBtn.addEventListener('click', () => generateAndRenderPeekContent('album', { forceRefresh: true }));
            }
    
            // 为照片详情模态框添加关闭事件
            const photoModal = document.getElementById('peek-photo-modal');
            if(photoModal) {
                photoModal.addEventListener('click', (e) => {
                    if (e.target === photoModal) {
                        photoModal.classList.remove('visible');
                    }
                });
            }
        }

        async function generateJournal(start, end) {
            showToast('正在生成日记，请稍候...');
            isGenerating = true; // Set a flag to prevent other actions

            try {
                const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
                if (!chat) {
                    throw new Error("未找到当前聊天。");
                }

                // Message indices are 1-based for the user, so convert to 0-based for slicing
                const startIndex = start - 1;
                const endIndex = end;
                
                if (startIndex < 0 || endIndex > chat.history.length || startIndex >= endIndex) {
                    throw new Error("无效的消息范围。");
                }

                const messagesToSummarize = chat.history.slice(startIndex, endIndex);
                
                // 使用为日记绑定的世界书
                const journalWorldBooks = (chat.journalWorldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id)).filter(Boolean);
                const worldBooksContent = journalWorldBooks.map(wb => wb.content).join('\n\n');

                let summaryPrompt = `你是一个日记整理助手。请以角色 "${chat.remarkName || chat.name}" 的第一人称视角，总结以下聊天记录。请专注于重要的情绪、事件和细节，语言内省而克制，带有诗意与隐喻感，用冷静的笔触将对话片段凝练为思绪流动与寓言化的自白。\n\n`;
                summaryPrompt += "为了更好地理解角色和背景，请参考以下信息：\n";
                summaryPrompt += "=====\n";

                if (worldBooksContent) {
                    summaryPrompt += `世界观设定:\n${worldBooksContent}\n\n`;
                }

                summaryPrompt += `你的角色设定:\n- 角色名: ${chat.realName}\n- 人设: ${chat.persona || "一个友好、乐于助人的伙伴。"}\n\n`;
                summaryPrompt += `我的角色设定:\n- 我的称呼: ${chat.myName}\n- 我的人设: ${chat.myPersona || "无特定人设。"}\n\n`;
                summaryPrompt += "=====\n";
                summaryPrompt += `请基于以上所有背景信息，总结以下聊天记录。你的输出必须是一个JSON对象，包含 'title' (一个简洁的标题) 和 'content' (完整的日记正文) 两个字段。聊天记录如下：\n\n---\n${messagesToSummarize.map(m => m.content).join('\n')}\n---`;

                const { url, key, model, provider } = db.apiSettings;
                if (!url || !key || !model) {
                    throw new Error("API设置不完整。");
                }

                const requestBody = {
                    model: model,
                    messages: [{ role: 'user', content: summaryPrompt }],
                    temperature: 0.7,
                    response_format: { type: "json_object" }, // Request JSON output
                };
                const endpoint = `${url}/v1/chat/completions`;
                const headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${key}` };

                const response = await fetch(endpoint, { method: 'POST', headers: headers, body: JSON.stringify(requestBody) });
                if (!response.ok) {
                    throw new Error(`API 错误: ${response.status} ${await response.text()}`);
                }

                const result = await response.json();
                const rawContent = result.choices[0].message.content;
                const journalData = JSON.parse(rawContent);

                // Create and save the new journal entry
                const newJournal = {
                    id: `journal_${Date.now()}`,
                    range: { start, end },
                    title: journalData.title || "无标题日记",
                    content: journalData.content || "内容为空。",
                    createdAt: Date.now(),
                    chatId: currentChatId,
                    chatType: currentChatType,
                    isFavorited: false // 新增：收藏状态
                };

                if (!chat.memoryJournals) {
                    chat.memoryJournals = [];
                }
                chat.memoryJournals.push(newJournal);
                await saveData();

                renderJournalList();
                showToast('新日记已生成！');

            } catch (error) {
                console.error('生成日记失败:', error);
                showToast(`生成失败: ${error.message}`);
            } finally {
                isGenerating = false; // Reset the flag
            }
        }

        function setupPeekFeature() {
            const peekBtn = document.getElementById('peek-btn');
            const peekConfirmModal = document.getElementById('peek-confirm-modal');
            const peekConfirmYes = document.getElementById('peek-confirm-yes');
            const peekConfirmNo = document.getElementById('peek-confirm-no');
            const peekSettingsBtn = document.getElementById('peek-settings-btn');
            const peekWallpaperModal = document.getElementById('peek-wallpaper-modal');
            const peekWallpaperForm = document.getElementById('peek-wallpaper-form');
            const peekWallpaperUpload = document.getElementById('peek-wallpaper-upload');
            const peekWallpaperPreview = document.getElementById('peek-wallpaper-preview');

            peekBtn?.addEventListener('click', () => {
                peekConfirmModal.classList.add('visible');
            });

            peekConfirmNo?.addEventListener('click', () => {
                peekConfirmModal.classList.remove('visible');
            });

            peekConfirmYes?.addEventListener('click', () => {
                peekConfirmModal.classList.remove('visible');
                peekContentCache = {}; // Clear cache for new session
                renderPeekScreen(); // Render before switching
                switchScreen('peek-screen');
            });

            // New simplified settings functionality
            peekSettingsBtn?.addEventListener('click', () => {
                renderPeekSettings();
                peekWallpaperModal.classList.add('visible');
            });

            peekWallpaperUpload?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
                        document.getElementById('peek-wallpaper-url-input').value = compressedUrl;
                        showToast('图片已压缩并填入URL输入框');
                    } catch (error) {
                        showToast('壁纸压缩失败，请重试');
                    }
                }
            });

            // Combined save button for all peek settings
            document.getElementById('save-peek-settings-btn')?.addEventListener('click', async () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) {
                    showToast('错误：未找到当前角色');
                    return;
                }

                if (!character.peekScreenSettings) {
                    character.peekScreenSettings = { wallpaper: '', customIcons: {}, unlockAvatar: '' };
                }

                // Save wallpaper
                character.peekScreenSettings.wallpaper = document.getElementById('peek-wallpaper-url-input').value.trim();

                // Save custom app icons
                const iconInputs = document.querySelectorAll('#peek-app-icons-settings input[type="url"]');
                iconInputs.forEach(input => {
                    const appId = input.dataset.appId;
                    const newUrl = input.value.trim();
                    if (newUrl) {
                        if (!character.peekScreenSettings.customIcons) {
                            character.peekScreenSettings.customIcons = {};
                        }
                        character.peekScreenSettings.customIcons[appId] = newUrl;
                    } else {
                        if (character.peekScreenSettings.customIcons) {
                            delete character.peekScreenSettings.customIcons[appId];
                        }
                    }
                });
                
                // Save unlock avatar
                character.peekScreenSettings.unlockAvatar = document.getElementById('peek-unlock-avatar-url').value.trim();

                await saveData();
                renderPeekScreen(); // Re-render to apply all changes
                showToast('已保存！');
                peekWallpaperModal.classList.remove('visible');
            });

            // Add collapsible functionality
            peekWallpaperModal.addEventListener('click', (e) => {
                const header = e.target.closest('.collapsible-header');
                if (header) {
                    header.parentElement.classList.toggle('open');
                }
            });

            const peekMessagesScreen = document.getElementById('peek-messages-screen');
            peekMessagesScreen.addEventListener('click', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (chatItem) {
                    const partnerName = chatItem.dataset.name;
                    const cachedData = peekContentCache.messages;
                    if (cachedData && cachedData.conversations) {
                        const conversation = cachedData.conversations.find(c => c.partnerName === partnerName);
                        if (conversation) {
                            renderPeekConversation(conversation.history, conversation.partnerName);
                            switchScreen('peek-conversation-screen');
                        } else {
                            showToast('找不到对话记录');
                        }
                    }
                } else if (e.target.closest('.action-btn')) {
                    generateAndRenderPeekContent('messages', { forceRefresh: true });
                }
            });

            const peekConversationScreen = document.getElementById('peek-conversation-screen');
            peekConversationScreen.addEventListener('click', (e) => {
                if (e.target.closest('.action-btn')) {
                    generateAndRenderPeekContent('messages', { forceRefresh: true });
                }
            });

            // 为相册刷新按钮添加事件监听
            const refreshAlbumBtn = document.getElementById('refresh-album-btn');
            if(refreshAlbumBtn) {
                refreshAlbumBtn.addEventListener('click', () => generateAndRenderPeekContent('album', { forceRefresh: true }));
            }
    
            // 为照片详情模态框添加关闭事件
            const photoModal = document.getElementById('peek-photo-modal');
            if(photoModal) {
                photoModal.addEventListener('click', (e) => {
                    if (e.target === photoModal) {
                        photoModal.classList.remove('visible');
                    }
                });
            }
        }

        function renderPeekAlbum(photos) {
            const screen = document.getElementById('peek-album-screen');
            const grid = screen.querySelector('.album-grid');
            grid.innerHTML = ''; // Clear previous content
    
            if (!photos || photos.length === 0) {
                grid.innerHTML = '<p class="placeholder-text">正在生成相册内容...</p>';
                return;
            }
    
            photos.forEach(photo => {
                const photoEl = document.createElement('div');
                photoEl.className = 'album-photo';
                photoEl.dataset.imageDescription = photo.imageDescription;
                photoEl.dataset.description = photo.description;
    
                const img = document.createElement('img');
                img.src = 'https://i.postimg.cc/1tH6ds9g/1752301200490.jpg'; // 使用一个静态占位图
                img.alt = "相册照片";
                photoEl.appendChild(img);
    
                if (photo.type === 'video') {
                    const videoIndicator = document.createElement('div');
                    videoIndicator.className = 'video-indicator';
                    videoIndicator.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>`;
                    photoEl.appendChild(videoIndicator);
                }
                
                photoEl.addEventListener('click', () => {
                    const modal = document.getElementById('peek-photo-modal');
                    const imgContainer = document.getElementById('peek-photo-image-container');
                    const descriptionEl = document.getElementById('peek-photo-description');
                    
                    // 将AI生成的图片文字描述展示出来，而不是真的图片
                    imgContainer.innerHTML = `<div style="padding: 20px; text-align: left; color: #555; font-size: 16px; line-height: 1.6; height: 100%; overflow-y: auto;">${photo.imageDescription}</div>`;
                    // 显示角色对照片的批注
                    descriptionEl.textContent = `批注：${photo.description}`;
                    
                    modal.classList.add('visible');
                });
    
                grid.appendChild(photoEl);
            });
        }

        function renderPeekUnlock(data) {
            const screen = document.getElementById('peek-unlock-screen');
            if (!screen) return;

            // Handle loading/empty state
            if (!data) {
                screen.innerHTML = `
                    <header class="app-header">
                        <button class="back-btn" data-target="peek-screen">‹</button>
                        <div class="title-container"><h1 class="title">...</h1></div>
                        <button class="action-btn">···</button>
                    </header>
                    <main class="content"><p class="placeholder-text">正在生成小号内容...</p></main>
                `;
                return;
            }

            const { nickname, handle, bio, posts } = data;
            const character = db.characters.find(c => c.id === currentChatId);
            const peekSettings = character?.peekScreenSettings || { unlockAvatar: '' };
            const fixedAvatar = peekSettings.unlockAvatar || 'https://i.postimg.cc/SNwL1XwR/chan-11.png';

            // Random numbers for stats
            const randomFollowers = (Math.random() * 5 + 1).toFixed(1) + 'k';
            const randomFollowing = Math.floor(Math.random() * 500) + 50;

            let postsHtml = '';
            if (posts && posts.length > 0) {
                posts.forEach(post => {
                    const randomComments = Math.floor(Math.random() * 100);
                    const randomLikes = Math.floor(Math.random() * 500);
                    postsHtml += `
                        <div class="unlock-post-card">
                            <div class="unlock-post-card-header">
                                <img src="${fixedAvatar}" alt="Profile Avatar">
                                <div class="unlock-post-card-author-info">
                                    <span class="username">${nickname}</span>
                                    <span class="timestamp">${post.timestamp}</span>
                                </div>
                            </div>
                            <div class="unlock-post-card-content">
                                ${post.content.replace(/\n/g, '<br>')}
                            </div>
                            <div class="unlock-post-card-actions">
                                <div class="action"><svg viewBox="0 0 24 24"><path d="M18,16.08C17.24,16.08 16.56,16.38 16.04,16.85L8.91,12.7C8.96,12.47 9,12.24 9,12C9,11.76 8.96,11.53 8.91,11.3L16.04,7.15C16.56,7.62 17.24,7.92 18,7.92C19.66,7.92 21,6.58 21,5C21,3.42 19.66,2 18,2C16.34,2 15,3.42 15,5C15,5.24 15.04,5.47 15.09,5.7L7.96,9.85C7.44,9.38 6.76,9.08 6,9.08C4.34,9.08 3,10.42 3,12C3,13.58 4.34,14.92 6,14.92C6.76,14.92 7.44,14.62 7.96,14.15L15.09,18.3C15.04,18.53 15,18.76 15,19C15,20.58 16.34,22 18,22C19.66,22 21,20.58 21,19C21,17.42 19.66,16.08 18,16.08Z"></path></svg> <span>分享</span></div>
                                <div class="action"><svg viewBox="0 0 24 24"><path d="M20,2H4C2.9,0,2,0.9,2,2v18l4-4h14c1.1,0,2-0.9,2-2V4C22,2.9,21.1,2,20,2z M18,14H6v-2h12V14z M18,11H6V9h12V11z M18,8H6V6h12V8z"></path></svg> <span>${randomComments}</span></div>
                                <div class="action"><svg viewBox="0 0 24 24"><path d="M12,21.35L10.55,20.03C5.4,15.36,2,12.27,2,8.5C2,5.42,4.42,3,7.5,3c1.74,0,3.41,0.81,4.5,2.09C13.09,3.81,14.76,3,16.5,3C19.58,3,22,5.42,22,8.5c0,3.78-3.4,6.86-8.55,11.54L12,21.35z"></path></svg> <span>${randomLikes}</span></div>
                            </div>
                        </div>
                    `;
                });
            }

            screen.innerHTML = `
                <header class="app-header">
                    <button class="back-btn" data-target="peek-screen">‹</button>
                    <div class="title-container">
                        <h1 class="title">${nickname}</h1>
                    </div>
                    <button class="action-btn" id="refresh-unlock-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
                </header>
                <main class="content">
                    <div class="unlock-profile-header">
                        <img src="${fixedAvatar}" alt="Profile Avatar" class="unlock-profile-avatar">
                        <div class="unlock-profile-info">
                            <h2 class="unlock-profile-username">${nickname}</h2>
                            <p class="unlock-profile-handle">${handle}</p>
                        </div>
                    </div>
                    <div class="unlock-profile-bio">
                        <p>${bio.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div class="unlock-profile-stats">
                        <div class="unlock-profile-stat">
                            <span class="count">${posts.length}</span>
                            <span class="label">帖子</span>
                        </div>
                        <div class="unlock-profile-stat">
                            <span class="count">${randomFollowers}</span>
                            <span class="label">粉丝</span>
                        </div>
                        <div class="unlock-profile-stat">
                            <span class="count">${randomFollowing}</span>
                            <span class="label">关注</span>
                        </div>
                    </div>
                    <div class="unlock-post-feed">
                        ${postsHtml}
                    </div>
                </main>
            `;

            // Add event listener for the new refresh button
            screen.querySelector('#refresh-unlock-btn').addEventListener('click', () => {
                generateAndRenderPeekContent('unlock', { forceRefresh: true });
            });
        }
 
        function renderPeekConversation(history, partnerName) {
            const titleEl = document.getElementById('peek-conversation-title');
            const messageAreaEl = document.getElementById('peek-message-area');

            titleEl.textContent = partnerName;
            messageAreaEl.innerHTML = '';

            if (!history || history.length === 0) {
                messageAreaEl.innerHTML = '<p class="placeholder-text">正在生成对话...</p>';
                return;
            }

            history.forEach(msg => {
                const isSentByChar = msg.sender === 'char'; // 'char' is the character whose phone we are peeking
                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${isSentByChar ? 'sent' : 'received'}`;

                const bubbleRow = document.createElement('div');
                bubbleRow.className = 'message-bubble-row';

                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${isSentByChar ? 'sent' : 'received'}`;
                bubble.textContent = msg.content;

                if (isSentByChar) {
                    bubbleRow.appendChild(bubble);
                } else {
                    const avatar = document.createElement('img');
                    avatar.className = 'message-avatar';
                    avatar.src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
                    bubbleRow.appendChild(avatar);
                    bubbleRow.appendChild(bubble);
                }
                
                wrapper.appendChild(bubbleRow);
                messageAreaEl.appendChild(wrapper);
            });
            messageAreaEl.scrollTop = messageAreaEl.scrollHeight;
        }

        function renderPeekScreen() {
            const peekScreen = document.getElementById('peek-screen');
            const contentArea = peekScreen.querySelector('main.content');

            // Set content
            contentArea.innerHTML = `
                <div class="time-widget">
                    <div class="time" id="peek-time-display"></div>
                    <div class="date" id="peek-date-display"></div>
                </div>
                <div class="app-grid"></div>
            `;

            const character = db.characters.find(c => c.id === currentChatId);
            const peekSettings = character?.peekScreenSettings || { wallpaper: '', customIcons: {} };

            // Apply wallpaper to the parent screen element
            const wallpaper = peekSettings.wallpaper;
            if (wallpaper) {
                peekScreen.style.backgroundImage = `url(${wallpaper})`;
            } else {
                peekScreen.style.backgroundImage = `url(${db.wallpaper})`; // Fallback to global wallpaper
            }
            peekScreen.style.backgroundSize = 'cover';
            peekScreen.style.backgroundPosition = 'center';

            // Render the 6 specific, non-functional icons
            const appGrid = contentArea.querySelector('.app-grid');
            Object.keys(peekScreenApps).forEach(id => {
                const iconData = peekScreenApps[id];
                const iconEl = document.createElement('a');
                iconEl.href = '#';
                iconEl.className = 'app-icon';
                iconEl.dataset.peekAppId = id;
                const customIconUrl = peekSettings.customIcons?.[id];
                const iconUrl = customIconUrl || iconData.url;
                iconEl.innerHTML = `
                    <img src="${iconUrl}" alt="${iconData.name}" class="icon-img">
                    <span class="app-name">${iconData.name}</span>
                `;
                iconEl.addEventListener('click', (e) => {
                    e.preventDefault();
                    generateAndRenderPeekContent(id);
                });
                appGrid.appendChild(iconEl);
            });

            // Call updateClock to immediately populate the time
            updateClock();
        }

        function renderPeekChatList(conversations = []) {
            const container = document.getElementById('peek-chat-list-container');
            container.innerHTML = '';

            if (!conversations || conversations.length === 0) {
                // This case is handled by the loading/error message in generateAndRenderPeekContent
                return;
            }

            // Use a pool of default avatars
            conversations.forEach((convo) => {
                const history = convo.history || [];
                const lastMessage = history.length > 0 ? history[history.length - 1] : null;
                const lastMessageText = lastMessage ? (lastMessage.content || '').replace(/\[.*?的消息：([\s\S]+)\]/, '$1') : '...';
                
                const li = document.createElement('li');
                li.className = 'list-item chat-item';
                // Use partnerName as the unique identifier for clicking
                li.dataset.name = convo.partnerName;

                const avatarUrl = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';

                li.innerHTML = `
                    <img src="${avatarUrl}" alt="${convo.partnerName}" class="chat-avatar">
                    <div class="item-details">
                        <div class="item-details-row"><div class="item-name">${convo.partnerName}</div></div>
                        <div class="item-preview-wrapper">
                            <div class="item-preview">${lastMessageText}</div>
                        </div>
                    </div>`;
                container.appendChild(li);
            });
        }

        function renderMemosList(memos) {
            const screen = document.getElementById('peek-memos-screen');
            let listHtml = '';
            if (!memos || memos.length === 0) {
                listHtml = '<p class="placeholder-text">正在生成备忘录...</p>';
            } else {
                memos.forEach(memo => {
                    const firstLine = memo.content.split('\n')[0];
                    listHtml += `
                        <li class="memo-item" data-id="${memo.id}">
                            <h3 class="memo-item-title">${memo.title}</h3>
                            <p class="memo-item-preview">${firstLine}</p>
                        </li>
                    `;
                });
            }

            screen.innerHTML = `
                <header class="app-header">
                    <button class="back-btn" data-target="peek-screen">‹</button>
                    <div class="title-container"><h1 class="title">备忘录</h1></div>
                    <button class="action-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
                </header>
                <main class="content"><ul id="peek-memos-list">${listHtml}</ul></main>
            `;

            screen.querySelector('.action-btn').addEventListener('click', () => {
                generateAndRenderPeekContent('memos', { forceRefresh: true });
            });

            screen.querySelectorAll('.memo-item').forEach(item => {
                item.addEventListener('click', () => {
                    // FIX: Correctly access the 'memos' array within the cached object.
                    const memo = peekContentCache.memos?.memos?.find(m => m.id === item.dataset.id);
                    if (memo) {
                        renderMemoDetail(memo);
                        switchScreen('peek-memo-detail-screen');
                    }
                });
            });
        }

        function renderMemoDetail(memo) {
            const screen = document.getElementById('peek-memo-detail-screen');
            if (!memo) return;
            const contentHtml = memo.content.replace(/\n/g, '<br>');
            screen.innerHTML = `
                <header class="app-header">
                    <button class="back-btn" data-target="peek-memos-screen">‹</button>
                    <div class="title-container"><h1 class="title">${memo.title}</h1></div>
                    <button class="action-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
                </header>
                <main class="content" style="padding: 20px; line-height: 1.6;">${contentHtml}</main>
            `;
        }

       function renderPeekCart(items) {
           const screen = document.getElementById('peek-cart-screen');
            let itemsHtml = '';
            let totalPrice = 0;

            if (!items || items.length === 0) {
                itemsHtml = '<p class="placeholder-text">正在生成购物车内容...</p>';
            } else {
                items.forEach(item => {
                    itemsHtml += `
                        <li class="cart-item" data-id="${item.id}">
                            <img src="https://i.postimg.cc/wMbSMvR9/export202509181930036600.png" class="cart-item-image" alt="${item.title}">
                            <div class="cart-item-details">
                                <h3 class="cart-item-title">${item.title}</h3>
                                <p class="cart-item-spec">规格：${item.spec}</p>
                                <p class="cart-item-price">¥${item.price}</p>
                            </div>
                        </li>
                    `;
                    totalPrice += parseFloat(item.price);
                });
            }

           screen.innerHTML = `
               <header class="app-header">
                   <button class="back-btn" data-target="peek-screen">‹</button>
                   <div class="title-container"><h1 class="title">购物车</h1></div>
                   <button class="action-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
               </header>
               <main class="content"><ul class="cart-item-list">${itemsHtml}</ul></main>
               <footer class="cart-footer">
                   <div class="cart-total-price">
                       <span class="label">合计：</span>¥${totalPrice.toFixed(2)}
                   </div>
                   <button class="checkout-btn">结算</button>
               </footer>
           `;
           
            screen.querySelector('.action-btn').addEventListener('click', () => {
                generateAndRenderPeekContent('cart', { forceRefresh: true });
            });
           screen.querySelector('.checkout-btn').addEventListener('click', () => {
               showToast('功能开发中');
           });
       }

       function renderPeekTransferStation(entries) {
           const screen = document.getElementById('peek-transfer-station-screen');
            let messagesHtml = '';

            if (!entries || entries.length === 0) {
                messagesHtml = '<p class="placeholder-text">正在生成中转站内容...</p>';
            } else {
                entries.forEach(entry => {
                    // Each entry is a message from the character to themselves.
                    // We'll render it as a 'sent' message bubble.
                    messagesHtml += `
                        <div class="message-wrapper sent">
                            <div class="message-bubble-row">
                                <div class="message-bubble sent" style="background-color: #98E165; color: #000;">
                                    ${entry}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

           screen.innerHTML = `
               <header class="app-header">
                   <button class="back-btn" data-target="peek-screen">‹</button>
                   <div class="title-container">
                       <h1 class="title">文件传输助手</h1>
                   </div>
                   <button class="action-btn">
                       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg>
                   </button>
               </header>
               <main class="content">
                   <div class="message-area" style="padding: 10px;">
                        ${messagesHtml}
                   </div>
                   <div class="transfer-station-input-area">
                       <div class="fake-input"></div>
                       <button class="plus-btn"></button>
                   </div>
               </main>
           `;
            
            screen.querySelector('.action-btn').addEventListener('click', () => {
                generateAndRenderPeekContent('transfer', { forceRefresh: true });
            });

            const messageArea = screen.querySelector('.message-area');
            if (messageArea) {
                messageArea.scrollTop = messageArea.scrollHeight;
            }
       }

      function renderPeekBrowser(historyItems) {
          const screen = document.getElementById('peek-browser-screen');
          let itemsHtml = '';
            if (!historyItems || historyItems.length === 0) {
                itemsHtml = '<p class="placeholder-text">正在生成浏览记录...</p>';
            } else {
                historyItems.forEach(item => {
                    itemsHtml += `
                        <li class="browser-history-item">
                            <h3 class="history-item-title">${item.title}</h3>
                            <p class="history-item-url">${item.url}</p>
                            <div class="history-item-annotation">${item.annotation}</div>
                        </li>
                    `;
                });
            }

          screen.innerHTML = `
              <header class="app-header">
                  <button class="back-btn" data-target="peek-screen">‹</button>
                  <div class="title-container"><h1 class="title">浏览器</h1></div>
                  <button class="action-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
              </header>
              <main class="content"><ul class="browser-history-list">${itemsHtml}</ul></main>
          `;
          screen.querySelector('.action-btn').addEventListener('click', () => {
              generateAndRenderPeekContent('browser', { forceRefresh: true });
          });
      }

       function renderPeekDrafts(draft) {
            const screen = document.getElementById('peek-drafts-screen');
            let draftTo = '...';
            let draftContent = '<p class="placeholder-text">正在生成草稿...</p>';

            if (draft) {
                draftTo = draft.to;
                draftContent = draft.content;
            }
            
           screen.innerHTML = `
               <header class="app-header">
                   <button class="back-btn" data-target="peek-screen">‹</button>
                   <div class="title-container"><h1 class="title">草稿箱</h1></div>
                   <button class="action-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button>
               </header>
               <main class="content">
                   <div class="draft-paper">
                       <div class="draft-to">To: ${draftTo}</div>
                       <div class="draft-content">${draftContent}</div>
                   </div>
               </main>
           `;
            screen.querySelector('.action-btn').addEventListener('click', () => {
                generateAndRenderPeekContent('drafts', { forceRefresh: true });
            });
       }

      // ==================================================================================================================
      // ========================================== 1. API 预设管理 (API PRESET MANAGEMENT) ==========================================
      // ==================================================================================================================
       function _getApiPresets() {
           return db.apiPresets || [];
       }
       function _saveApiPresets(arr) {
           db.apiPresets = arr || [];
           saveData();
       }

       function populateApiSelect() {
           const sel = document.getElementById('api-preset-select');
           if (!sel) return;
           const presets = _getApiPresets();
           sel.innerHTML = '<option value="">— 选择 API 预设 —</option>';
           presets.forEach(p => {
           const opt = document.createElement('option');
           opt.value = p.name;
           opt.textContent = p.name;
           sel.appendChild(opt);
           });
       }

       function saveCurrentApiAsPreset() {
           const apiKeyEl = document.querySelector('#api-key');
           const apiUrlEl = document.querySelector('#api-url');
           const providerEl = document.querySelector('#api-provider');
           const modelEl = document.querySelector('#api-model');

           const data = {
               apiKey: apiKeyEl ? apiKeyEl.value : '',
               apiUrl: apiUrlEl ? apiUrlEl.value : '',
               provider: providerEl ? providerEl.value : '',
               model: modelEl ? modelEl.value : ''
           };
           
           let name = prompt('为该 API 预设填写名称（会覆盖同名预设）：');
           if (!name) return;
           const presets = _getApiPresets();
           const idx = presets.findIndex(p => p.name === name);
           const preset = {name: name, data: data};
           if (idx >= 0) presets[idx] = preset; else presets.push(preset);
           _saveApiPresets(presets);
           populateApiSelect();
           (window.showToast && showToast('API 预设已保存')) || console.log('API 预设已保存');
       }

       async function applyApiPreset(name) {
           const presets = _getApiPresets();
           const p = presets.find(x => x.name === name);
           if (!p) return (window.showToast && showToast('未找到该预设')) || alert('未找到该预设');
           try {
               const apiKeyEl = document.querySelector('#api-key');
               const apiUrlEl = document.querySelector('#api-url');
               const providerEl = document.querySelector('#api-provider');
               const modelEl = document.querySelector('#api-model');

               if (apiKeyEl && p.data && typeof p.data.apiKey !== 'undefined') apiKeyEl.value = p.data.apiKey;
               if (apiUrlEl && p.data && typeof p.data.apiUrl !== 'undefined') apiUrlEl.value = p.data.apiUrl;
               if (providerEl && p.data && typeof p.data.provider !== 'undefined') providerEl.value = p.data.provider;
               if (modelEl && p.data && typeof p.data.model !== 'undefined') {
                   modelEl.innerHTML = `<option value="${p.data.model}">${p.data.model}</option>`;
                   modelEl.value = p.data.model;
               }

               (window.showToast && showToast('已应用 API 预设')) || console.log('已应用 API 预设');
           } catch(e) {
               console.error('applyApiPreset error', e);
           }
       }

       function openApiManageModal() {
           const modal = document.getElementById('api-presets-modal');
           const list = document.getElementById('api-presets-list');
           if (!modal || !list) return;
           list.innerHTML = '';
           const presets = _getApiPresets();
           if (!presets.length) {
               list.innerHTML = '<p style="color:#888;margin:6px 0;">暂无预设</p>';
           }
           presets.forEach((p, idx) => {
               const row = document.createElement('div');
               row.style.display = 'flex';
               row.style.justifyContent = 'space-between';
               row.style.alignItems = 'center';
               row.style.padding = '8px 6px';
               row.style.borderBottom = '1px solid #f6f6f6';

               const left = document.createElement('div');
               left.style.flex = '1';
               left.style.minWidth = '0';
               left.innerHTML = '<div style="font-weight:600;">'+p.name+'</div><div style="font-size:12px;color:#666;margin-top:4px;">' + (p.data && p.data.provider ? ('提供者：'+p.data.provider) : '') + '</div>';

               const btns = document.createElement('div');
               btns.style.display = 'flex';
               btns.style.gap = '6px';

               const applyBtn = document.createElement('button');
               applyBtn.className = 'btn';
               applyBtn.textContent = '应用';
               applyBtn.onclick = function(){ applyApiPreset(p.name); modal.style.display='none'; };

               const renameBtn = document.createElement('button');
               renameBtn.className = 'btn';
               renameBtn.textContent = '重命名';
               renameBtn.onclick = function(){
                   const newName = prompt('输入新名称：', p.name);
                   if (!newName) return;
                   const all = _getApiPresets();
                   all[idx].name = newName;
                   _saveApiPresets(all);
                   openApiManageModal();
                   populateApiSelect();
               };

               const delBtn = document.createElement('button');
               delBtn.className = 'btn';
               delBtn.textContent = '删除';
               delBtn.onclick = function(){ if(!confirm('确定删除 "'+p.name+'" ?')) return; const all=_getApiPresets(); all.splice(idx,1); _saveApiPresets(all); openApiManageModal(); populateApiSelect(); };

               btns.appendChild(applyBtn); btns.appendChild(renameBtn); btns.appendChild(delBtn);

               row.appendChild(left); row.appendChild(btns);
               list.appendChild(row);
           });
           modal.style.display = 'flex';
       }

       function exportApiPresets() {
           const presets = _getApiPresets();
           const blob = new Blob([JSON.stringify(presets, null, 2)], {type: 'application/json'});
           const url = URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url; a.download = 'api_presets.json'; document.body.appendChild(a); a.click(); a.remove();
           URL.revokeObjectURL(url);
       }
       function importApiPresets() {
           const inp = document.createElement('input');
           inp.type = 'file';
           inp.accept = 'application/json';
           inp.onchange = function(e){
               const f = e.target.files[0];
               if (!f) return;
               const r = new FileReader();
               r.onload = function(){ try { const data = JSON.parse(r.result); if (Array.isArray(data)) { _saveApiPresets(data); populateApiSelect(); openApiManageModal(); } else alert('文件格式不正确'); } catch(e){ alert('导入失败：'+e.message); } };
               r.readAsText(f);
           };
           inp.click();
       }
       
       // ==================================================================================================================
       // =================================== 2. 气泡CSS自定义预设管理 (BUBBLE CSS PRESET MANAGEMENT) ===================================
       // ==================================================================================================================
       function _getBubblePresets() {
           return db.bubbleCssPresets || [];
       }
       function _saveBubblePresets(arr) {
           db.bubbleCssPresets = arr || [];
           saveData();
       }

       function populateBubblePresetSelect() {
           const sel = document.getElementById('bubble-preset-select');
           if (!sel) return;
           const presets = _getBubblePresets();
           sel.innerHTML = '<option value="">— 选择预设 —</option>';
           presets.forEach((p) => {
               const opt = document.createElement('option');
               opt.value = p.name;
               opt.textContent = p.name;
               sel.appendChild(opt);
           });
       }

       async function applyPresetToCurrentChat(presetName) {
           const presets = _getBubblePresets();
           const preset = presets.find(p => p.name === presetName);
           if (!preset) { (window.showToast && showToast('未找到该预设')) || alert('未找到该预设'); return; }
           
           const textarea = document.getElementById('setting-custom-bubble-css') || document.getElementById('setting-group-custom-bubble-css');
           if (textarea) textarea.value = preset.css;

           try {
               const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
               if (chat) {
                   chat.customBubbleCss = preset.css;
                   chat.useCustomBubbleCss = true;
                   if (currentChatType === 'private') {
                       document.getElementById('setting-use-custom-css').checked = true;
                       document.getElementById('setting-custom-bubble-css').disabled = false;
                   } else {
                       document.getElementById('setting-group-use-custom-css').checked = true;
                       document.getElementById('setting-group-custom-bubble-css').disabled = false;
                   }
               }
           } catch(e){
               console.warn('applyPresetToCurrentChat: cannot write to db object', e);
           }

           try {
               updateCustomBubbleStyle(window.currentChatId || null, preset.css, true);
               const previewBox = document.getElementById('private-bubble-css-preview') || document.getElementById('group-bubble-css-preview');
               if (previewBox) {
                   const themeKey = (currentChatType === 'private' ? db.characters.find(c => c.id === currentChatId).theme : db.groups.find(g => g.id === currentChatId).theme) || 'white_pink';
                   updateBubbleCssPreview(previewBox, preset.css, false, colorThemes[themeKey]);
               }
               (window.showToast && showToast('预设已应用到当前聊天并保存')) || alert('预设已应用（若页面支持）');
               await saveData();
           } catch(e){
               console.error('applyPresetToCurrentChat error', e);
           }
       }

       function saveCurrentTextareaAsPreset() {
           const textarea = document.getElementById('setting-custom-bubble-css') || document.getElementById('setting-group-custom-bubble-css');
           if (!textarea) return (window.showToast && showToast('找不到自定义 CSS 文本框')) || alert('找不到自定义 CSS 文本框');
           const css = textarea.value.trim();
           if (!css) return (window.showToast && showToast('当前 CSS 为空，无法保存')) || alert('当前 CSS 为空，无法保存');
           let name = prompt('请输入预设名称（将覆盖同名预设）:');
           if (!name) return;
           const presets = _getBubblePresets();
           const idx = presets.findIndex(p => p.name === name);
           if (idx >= 0) presets[idx].css = css;
           else presets.push({name, css});
           _saveBubblePresets(presets);
           populateBubblePresetSelect();
           (window.showToast && showToast('预设已保存')) || alert('预设已保存');
       }

       function openManagePresetsModal() {
           const modal = document.getElementById('bubble-presets-modal');
           const list = document.getElementById('bubble-presets-list');
           if (!modal || !list) return;
           list.innerHTML = '';
           const presets = _getBubblePresets();
           if (!presets.length) list.innerHTML = '<p style="color:#888;margin:6px 0;">暂无预设</p>';
           presets.forEach((p, idx) => {
               const row = document.createElement('div');
               row.style.display = 'flex';
               row.style.justifyContent = 'space-between';
               row.style.alignItems = 'center';
               row.style.padding = '8px 0';
               row.style.borderBottom = '1px solid #f0f0f0';
               const nameDiv = document.createElement('div');
               nameDiv.style.flex = '1';
               nameDiv.style.whiteSpace = 'nowrap';
               nameDiv.style.overflow = 'hidden';
               nameDiv.style.textOverflow = 'ellipsis';
               nameDiv.textContent = p.name;
               row.appendChild(nameDiv);

               const btnWrap = document.createElement('div');
               btnWrap.style.display = 'flex';
               btnWrap.style.gap = '6px';

               const applyBtn = document.createElement('button');
               applyBtn.className = 'btn btn-primary';
               applyBtn.style.padding = '6px 8px;border-radius:8px';
               applyBtn.textContent = '应用';
               applyBtn.onclick = function(){ applyPresetToCurrentChat(p.name); modal.style.display = 'none'; };

               const renameBtn = document.createElement('button');
               renameBtn.className = 'btn';
               renameBtn.style.padding = '6px 8px;border-radius:8px';
               renameBtn.textContent = '重命名';
               renameBtn.onclick = function(){
                   const newName = prompt('输入新名称：', p.name);
                   if (!newName) return;
                   const presetsAll = _getBubblePresets();
                   presetsAll[idx].name = newName;
                   _saveBubblePresets(presetsAll);
                   openManagePresetsModal(); // refresh
                   populateBubblePresetSelect();
               };

               const delBtn = document.createElement('button');
               delBtn.className = 'btn btn-danger';
               delBtn.style.padding = '6px 8px;border-radius:8px';
               delBtn.textContent = '删除';
               delBtn.onclick = function(){
                   if (!confirm('确定删除预设 \"' + p.name + '\" ?')) return;
                   const presetsAll = _getBubblePresets();
                   presetsAll.splice(idx, 1);
                   _saveBubblePresets(presetsAll);
                   openManagePresetsModal();
                   populateBubblePresetSelect();
               };

               btnWrap.appendChild(applyBtn);
               btnWrap.appendChild(renameBtn);
               btnWrap.appendChild(delBtn);
               row.appendChild(btnWrap);
               list.appendChild(row);
           });
           modal.style.display = 'flex';
       }

       // ==================================================================================================================
       // ======================================= 3. 人设预设管理 (USER PERSONA PRESET MANAGEMENT) =======================================
       // ==================================================================================================================
       function _getMyPersonaPresets() {
           return db.myPersonaPresets || [];
       }
       function _saveMyPersonaPresets(arr) {
           db.myPersonaPresets = arr || [];
           saveData();
       }

       function populateMyPersonaSelect() {
           const sel = document.getElementById('mypersona-preset-select');
           if (!sel) return;
           const presets = _getMyPersonaPresets();
           sel.innerHTML = '<option value="">— 选择预设 —</option>';
           presets.forEach(p => {
               const opt = document.createElement('option');
               opt.value = p.name;
               opt.textContent = p.name;
               sel.appendChild(opt);
           });
       }

       function saveCurrentMyPersonaAsPreset() {
           const personaEl = document.getElementById('setting-my-persona');
           const avatarEl = document.getElementById('setting-my-avatar-preview');
           if (!personaEl || !avatarEl) return (window.showToast && showToast('找不到我的人设或头像控件')) || alert('找不到我的人设或头像控件');
           const persona = personaEl.value.trim();
           const avatar = avatarEl.src || '';
           if (!persona && !avatar) return (window.showToast && showToast('人设和头像都为空，无法保存')) || alert('人设和头像都为空，无法保存');
           const name = prompt('请输入预设名称（将覆盖同名预设）：');
           if (!name) return;
           const presets = _getMyPersonaPresets();
           const idx = presets.findIndex(p => p.name === name);
           const preset = { name, persona, avatar };
           if (idx >= 0) presets[idx] = preset; else presets.push(preset);
           _saveMyPersonaPresets(presets);
           populateMyPersonaSelect();
           (window.showToast && showToast('我的人设预设已保存')) || console.log('我的人设预设已保存');
       }

       async function applyMyPersonaPresetToCurrentChat(presetName) {
           const presets = _getMyPersonaPresets();
           const p = presets.find(x => x.name === presetName);
           if (!p) { (window.showToast && showToast('未找到该预设')) || alert('未找到该预设'); return; }

           const personaEl = document.getElementById('setting-my-persona');
           const avatarEl = document.getElementById('setting-my-avatar-preview');
           if (personaEl) personaEl.value = p.persona || '';
           if (avatarEl) avatarEl.src = p.avatar || '';

           try {
               if (currentChatType === 'private') {
                   const e = db.characters.find(c => c.id === currentChatId);
                   if (e) {
                       e.myPersona = p.persona || '';
                       e.myAvatar = p.avatar || '';
                       await saveData();
                       (window.showToast && showToast('预设已应用并保存到当前聊天')) || console.log('预设已应用');
                       if (typeof loadSettingsToSidebar === 'function') try{ loadSettingsToSidebar(); }catch(e){}
                       if (typeof renderChatList === 'function') try{ renderChatList(); }catch(e){}
                   }
               } else {
                   (window.showToast && showToast('预设已应用到界面（未检测到当前聊天保存入口）')) || console.log('预设已应用到界面');
               }
           } catch(err) {
               console.error('applyMyPersonaPresetToCurrentChat error', err);
           }
       }

       function openManageMyPersonaModal() {
           const modal = document.getElementById('mypersona-presets-modal');
           const list = document.getElementById('mypersona-presets-list');
           if (!modal || !list) return;
           list.innerHTML = '';
           const presets = _getMyPersonaPresets();
           if (!presets.length) list.innerHTML = '<p style="color:#888;margin:6px 0;">暂无预设</p>';
           presets.forEach((p, idx) => {
               const row = document.createElement('div');
               row.style.display = 'flex';
               row.style.justifyContent = 'space-between';
               row.style.alignItems = 'center';
               row.style.padding = '8px 0';
               row.style.borderBottom = '1px solid #f0f0f0';

               const nameDiv = document.createElement('div');
               nameDiv.style.flex = '1';
               nameDiv.style.whiteSpace = 'nowrap';
               nameDiv.style.overflow = 'hidden';
               nameDiv.style.textOverflow = 'ellipsis';
               nameDiv.textContent = p.name;
               row.appendChild(nameDiv);

               const btnWrap = document.createElement('div');
               btnWrap.style.display = 'flex';
               btnWrap.style.gap = '6px';

               const applyBtn = document.createElement('button');
               applyBtn.className = 'btn btn-primary';
               applyBtn.style.padding = '6px 8px;border-radius:8px';
               applyBtn.textContent = '应用';
               applyBtn.onclick = function(){ applyMyPersonaPresetToCurrentChat(p.name); modal.style.display = 'none'; };

               const renameBtn = document.createElement('button');
               renameBtn.className = 'btn';
               renameBtn.style.padding = '6px 8px;border-radius:8px';
               renameBtn.textContent = '重命名';
               renameBtn.onclick = function(){
                   const newName = prompt('输入新名称：', p.name);
                   if (!newName) return;
                   const all = _getMyPersonaPresets();
                   all[idx].name = newName;
                   _saveMyPersonaPresets(all);
                   openManageMyPersonaModal();
                   populateMyPersonaSelect();
               };

               const deleteBtn = document.createElement('button');
               deleteBtn.className = 'btn';
               deleteBtn.style.padding = '6px 8px;border-radius:8px;color:#e53935';
               deleteBtn.textContent = '删除';
               deleteBtn.onclick = function(){
                   if (!confirm('确认删除该预设？')) return;
                   const all = _getMyPersonaPresets();
                   all.splice(idx,1);
                   _saveMyPersonaPresets(all);
                   openManageMyPersonaModal();
                   populateMyPersonaSelect();
               };

               btnWrap.appendChild(applyBtn);
               btnWrap.appendChild(renameBtn);
               btnWrap.appendChild(deleteBtn);
               row.appendChild(btnWrap);

               list.appendChild(row);
           });

           modal.style.display = 'flex';
       }

        function updateClock() {
            const now = new Date();
            const timeString = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            const dateString = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日`;

            const homeTimeDisplay = document.getElementById('time-display');
            const homeDateDisplay = document.getElementById('date-display');
            if (homeTimeDisplay) homeTimeDisplay.textContent = timeString;
            if (homeDateDisplay) homeDateDisplay.textContent = dateString;

            const peekTimeDisplay = document.getElementById('peek-time-display');
            const peekDateDisplay = document.getElementById('peek-date-display');
            if (peekTimeDisplay) peekTimeDisplay.textContent = timeString;
            if (peekDateDisplay) peekDateDisplay.textContent = dateString;
        }

        function updatePageIndicator(index) {
            const dots = document.querySelectorAll('.page-indicator .dot');
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
        }

        // --- App Setup Functions ---
        let currentPageIndex = 0;
        function setupHomeScreen() {
            const getIcon = (id) => db.customIcons[id] || defaultIcons[id].url;
            const homeScreenHTML = `
            <div class="home-screen-swiper">
                <div class="home-screen-page">
                    <div class="home-widget-container">
                        <div class="central-circle" style="background-image: url('${db.homeWidgetSettings.centralCircleImage}');"></div>
                        <div class="satellite-oval oval-top-left">
                            <img src="${db.homeWidgetSettings.topLeft.imageUrl}" alt="">
                            <span>${db.homeWidgetSettings.topLeft.text}</span>
                        </div>
                        <div class="satellite-oval oval-top-right">
                            <img src="${db.homeWidgetSettings.topRight.imageUrl}" alt="">
                            <span>${db.homeWidgetSettings.topRight.text}</span>
                        </div>
                        <div class="satellite-oval oval-bottom-left">
                            <img src="${db.homeWidgetSettings.bottomLeft.imageUrl}" alt="">
                            <span>${db.homeWidgetSettings.bottomLeft.text}</span>
                        </div>
                        <div class="satellite-oval oval-bottom-right">
                            <img src="${db.homeWidgetSettings.bottomRight.imageUrl}" alt="">
                            <span>${db.homeWidgetSettings.bottomRight.text}</span>
                        </div>


                        <div class="widget-time" id="time-display"></div>
                        <div contenteditable="true" class="widget-signature" id="widget-signature" placeholder="编辑个性签名..."></div>
                        <div class="widget-date" id="date-display"></div>
                        <div class="widget-battery">
                            <svg width="32" height="23" viewBox="0 0 24 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M1 2.5C1 1.94772 1.44772 1.5 2 1.5H20C20.5523 1.5 21 1.94772 21 2.5V9.5C21 10.0523 20.5523 10.5 20 10.5H2C1.44772 10.5 1 10.0523 1 9.5V2.5Z" stroke="#666" stroke-opacity="0.8" stroke-width="1"/>
                                <path d="M22.5 4V8" stroke="#666" stroke-opacity="0.8" stroke-width="1.5" stroke-linecap="round"/>
                                <rect id="battery-fill-rect" x="2" y="2.5" width="18" height="7" rx="0.5" fill="#666" fill-opacity="0.8"/>
                            </svg>
                            <span id="battery-level">--%</span>
                        </div>
                    </div>
                    <div class="app-grid">
                        <a href="#" class="app-icon" data-target="chat-list-screen"><img src="${getIcon('chat-list-screen')}" alt="404" class="icon-img"><span class="app-name">${defaultIcons['chat-list-screen'].name}</span></a>
                        <a href="#" class="app-icon" data-target="api-settings-screen"><img src="${getIcon('api-settings-screen')}" alt="API" class="icon-img"><span class="app-name">${defaultIcons['api-settings-screen'].name}</span></a>
                        <a href="#" class="app-icon" data-target="wallpaper-screen"><img src="${getIcon('wallpaper-screen')}" alt="Wallpaper" class="icon-img"><span class="app-name">${defaultIcons['wallpaper-screen'].name}</span></a>
                        <a href="#" class="app-icon" data-target="world-book-screen"><img src="${getIcon('world-book-screen')}" alt="World Book" class="icon-img"><span class="app-name">${defaultIcons['world-book-screen'].name}</span></a>
                        <a href="#" class="app-icon" data-target="customize-screen"><img src="${getIcon('customize-screen')}" alt="Customize" class="icon-img"><span class="app-name">${defaultIcons['customize-screen'].name}</span></a>
                        <a href="#" class="app-icon" data-target="tutorial-screen"><img src="${getIcon('tutorial-screen')}" alt="Tutorial" class="icon-img"><span class="app-name">${defaultIcons['tutorial-screen'].name}</span></a>
                    </div>
                </div>

                <div class="home-screen-page">
                     <div class="app-grid">
                        <a href="#" class="app-icon" data-target="forum-screen">
                            <img src="${getIcon('forum-screen')}" alt="论坛" class="icon-img">
                            <span class="app-name">${defaultIcons['forum-screen'].name}</span>
                        </a>
                        <a href="#" class="app-icon" data-target="music-screen">
    <img src="${getIcon('music-screen')}" alt="音乐" class="icon-img">
    <span class="app-name">${defaultIcons['music-screen'].name}</span>
</a>
                        <a href="#" class="app-icon" data-target="diary-screen">
                            <img src="${getIcon('diary-screen')}" alt="日记本" class="icon-img">
                            <span class="app-name">${defaultIcons['diary-screen'].name}</span>
                        </a>
                        <a href="#" class="app-icon" data-target="piggy-bank-screen">
                            <img src="${getIcon('piggy-bank-screen')}" alt="存钱罐" class="icon-img">
                            <span class="app-name">${defaultIcons['piggy-bank-screen'].name}</span>
                        </a>
                     </div>
                </div>

            </div>
            <div class="page-indicator">
                <span class="dot active" data-page="0"></span>
                <span class="dot" data-page="1"></span>
            </div>
            <div class="dock">
                <a href="#" class="app-icon" id="day-mode-btn"><img src="${getIcon('day-mode-btn')}" alt="日间" class="icon-img"></a>
                <a href="#" class="app-icon" id="night-mode-btn"><img src="${getIcon('night-mode-btn')}" alt="夜间" class="icon-img"></a>
                <a href="#" class="app-icon" data-target="font-settings-screen"><img src="${getIcon('font-settings-screen')}" alt="字体" class="icon-img"></a>
            </div>`;
            homeScreen.innerHTML = homeScreenHTML;
            updateClock();
            applyWallpaper(db.wallpaper);
            applyHomeScreenMode(db.homeScreenMode);
            document.getElementById('day-mode-btn')?.addEventListener('click', (e) => {
                e.preventDefault();
                applyHomeScreenMode('day');
            });
            document.getElementById('night-mode-btn')?.addEventListener('click', (e) => {
                e.preventDefault();
                applyHomeScreenMode('night');
            });
            document.querySelector('[data-target="world-book-screen"]').addEventListener('click', renderWorldBookList);
            document.querySelector('[data-target="customize-screen"]').addEventListener('click', renderCustomizeForm);
            document.querySelector('[data-target="tutorial-screen"]').addEventListener('click', renderTutorialContent);
            updateBatteryStatus();

            const signatureWidget = document.getElementById('widget-signature');
            if (signatureWidget) {
                signatureWidget.textContent = db.homeSignature || '';
                signatureWidget.addEventListener('blur', async (e) => {
                    const newSignature = e.target.textContent.trim();
                    if (db.homeSignature !== newSignature) {
                        db.homeSignature = newSignature;
                        await saveData();
                        showToast('签名已保存');
                    }
                });
            }

            // --- Home Screen Swipe Logic ---
            const swiper = homeScreen.querySelector('.home-screen-swiper');
            let touchStartX = 0;
            let touchEndX = 0;
            // currentPageIndex is now global
            const totalPages = 2;
            const swipeThreshold = 50; // Minimum distance for a swipe
            let isDragging = false;

            // Apply initial state based on global currentPageIndex
            swiper.style.transform = `translateX(-${currentPageIndex * 100 / totalPages}%)`;
            updatePageIndicator(currentPageIndex);

            // --- Touch Events ---
            homeScreen.addEventListener('touchstart', (e) => {
                if (e.target.closest('a') || e.target.closest('#widget-signature')) return;
                isDragging = true;
                touchStartX = e.changedTouches[0].screenX;
                touchEndX = e.changedTouches[0].screenX; // Reset on start
            }, { passive: true });

            homeScreen.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                touchEndX = e.changedTouches[0].screenX;
            }, { passive: true });

            homeScreen.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                handleSwipe();
            });

            // --- Mouse Events ---
            homeScreen.addEventListener('mousedown', (e) => {
                if (e.target.closest('a') || e.target.closest('#widget-signature')) return;
                e.preventDefault();
                isDragging = true;
                touchStartX = e.screenX;
                touchEndX = e.screenX; // Reset on start
                homeScreen.style.cursor = 'grabbing';
            });

            homeScreen.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    touchEndX = e.screenX;
                }
            });

            homeScreen.addEventListener('mouseup', (e) => {
                if (isDragging) {
                    isDragging = false;
                    homeScreen.style.cursor = 'grab';
                    handleSwipe();
                }
            });

            homeScreen.addEventListener('mouseleave', (e) => {
                if (isDragging) {
                    isDragging = false;
                    homeScreen.style.cursor = 'grab';
                    // Reset positions to cancel swipe
                    touchStartX = 0;
                    touchEndX = 0;
                }
            });

            function handleSwipe() {
                if (touchEndX === 0 && touchStartX === 0) return; // Swipe was cancelled by mouseleave
                
                const deltaX = touchEndX - touchStartX;

                if (Math.abs(deltaX) > swipeThreshold) {
                    if (deltaX < 0 && currentPageIndex < totalPages - 1) {
                        currentPageIndex++;
                    } else if (deltaX > 0 && currentPageIndex > 0) {
                        currentPageIndex--;
                    }
                }
                
                swiper.style.transform = `translateX(-${currentPageIndex * 100 / totalPages}%)`;
                updatePageIndicator(currentPageIndex);

                // Reset positions
                touchStartX = 0;
                touchEndX = 0;
            }

            // 新增：处理签名失焦的逻辑
            homeScreen.addEventListener('click', (e) => {
                const signatureWidget = document.getElementById('widget-signature');
                // 如果点击的目标不是签名框，并且签名框当前是激活编辑状态
                if (e.target !== signatureWidget && document.activeElement === signatureWidget) {
                    signatureWidget.blur(); // 手动触发失焦
                }
            });
        }

        function applyWallpaper(url) {
            homeScreen.style.backgroundImage = `url(${url})`;
        }

        async function applyHomeScreenMode(mode) {
            if (mode === 'day') {
                homeScreen.classList.add('day-mode');
            } else {
                homeScreen.classList.remove('day-mode');
            }
            db.homeScreenMode = mode;
            await saveData();
        }

                function setupCustomizeApp() {
            customizeForm.addEventListener('input', async (e) => {
                const target = e.target;

                // --- 处理应用图标的逻辑 ---
                if (target.dataset.iconId) { // 修改这里，统一使用一个标识
                    const iconId = target.dataset.iconId;
                    const newUrl = target.value.trim();
                    const previewImg = document.getElementById(`icon-preview-${iconId}`);
                    if (newUrl) {
                        if (!db.customIcons) db.customIcons = {}; // 确保 customIcons 已初始化
                        db.customIcons[iconId] = newUrl;
                        if(previewImg) previewImg.src = newUrl;
                    }
                // --- 新增：处理小部件的逻辑 ---
                } else if (target.dataset.widgetPart) {
                    const part = target.dataset.widgetPart;
                    const prop = target.dataset.widgetProp;
                    const newValue = target.value.trim();

                    if (prop) { // 这是小椭圆 (有prop属性)
                        db.homeWidgetSettings[part][prop] = newValue;
                    } else { // 这是中央大圆 (没有prop属性)
                        db.homeWidgetSettings[part] = newValue;
                    }
                }

                await saveData();
                setupHomeScreen(); // 实时刷新主页
            });
            customizeForm.addEventListener('click', async (e) => {
                // --- 处理重置应用图标的逻辑 ---
                if (e.target.matches('.reset-icon-btn')) {
                    const iconId = e.target.dataset.id;
                    if (db.customIcons) {
                        delete db.customIcons[iconId];
                    }
                    await saveData();
                    renderCustomizeForm(); // 重新渲染自定义页
                    setupHomeScreen(); // 刷新主页
                    showToast('图标已重置');
                }

                // --- 新增：处理重置小部件的逻辑 ---
                if (e.target.matches('#reset-widget-btn')) {
                    if (confirm('确定要将小部件恢复为默认设置吗？')) {
                        db.homeWidgetSettings = JSON.parse(JSON.stringify(defaultWidgetSettings));
                        await saveData();
                        renderCustomizeForm(); // 重新渲染自定义页
                        setupHomeScreen(); // 刷新主页
                        showToast('小部件已恢复默认');
                    }
                }
            });

         customizeForm.addEventListener('change', async (e) => {
             if (e.target.matches('.widget-upload-input')) {
                 const file = e.target.files[0];
                 if (!file) return;
 
                 const widgetPart = e.target.dataset.widgetTarget;
                 const widgetProp = e.target.dataset.widgetProp;
 
                 try {
                     const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                     
                     let targetInput;
                     if (widgetProp) {
                         targetInput = document.getElementById(`widget-input-${widgetPart}-${widgetProp}`);
                     } else {
                         targetInput = document.getElementById(`widget-input-${widgetPart}`);
                     }
 
                     if (targetInput) {
                         targetInput.value = compressedUrl;
                         // Manually trigger an input event to save the data
                         targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                         showToast('图片已上传并压缩');
                     }
                 } catch (error) {
                     console.error('Widget image compression failed:', error);
                     showToast('图片压缩失败，请重试');
                 } finally {
                     e.target.value = null; // Reset file input
                 }
             }
         });
        }

                function renderCustomizeForm() {
            customizeForm.innerHTML = ''; // 清空旧内容

            // --- 1. 应用图标自定义部分 ---
            const iconOrder = [
                'chat-list-screen', 'api-settings-screen', 'wallpaper-screen',
                'world-book-screen', 'customize-screen', 'tutorial-screen',
                'font-settings-screen', 'day-mode-btn', 'night-mode-btn', 'forum-screen', 'music-screen', 'diary-screen', 'piggy-bank-screen'
            ];

            let iconsContentHTML = '';
            iconOrder.forEach(id => {
                const { name, url } = defaultIcons[id];
                const currentIcon = (db.customIcons && db.customIcons[id]) || url;
                iconsContentHTML += `
                <div class="icon-custom-item">
                    <img src="${currentIcon}" alt="${name}" class="icon-preview" id="icon-preview-${id}">
                    <div class="icon-details">
                        <p>${name || '模式切换'}</p>
                        <input type="url" class="form-group" placeholder="粘贴新的图标URL" value="${(db.customIcons && db.customIcons[id]) || ''}" data-icon-id="${id}">
                    </div>
                    <button type="button" class="reset-icon-btn" data-id="${id}">重置</button>
                </div>`;
            });

            const iconsSectionHTML = `
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>应用图标</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    ${iconsContentHTML}
                </div>
            </div>
            `;
            customizeForm.insertAdjacentHTML('beforeend', iconsSectionHTML);

            // --- 2. 主页小部件自定义部分 ---
            const widgetSettings = db.homeWidgetSettings || defaultWidgetSettings;
            const widgetSectionHTML = `
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>主页小部件</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px;">
                        <button type="button" id="reset-widget-btn" class="btn btn-neutral btn-small">恢复默认</button>
                    </div>
                    <div class="form-group">
                        <label>中心圆圈图片URL</label>
                        <input type="url" class="form-group" placeholder="粘贴图片URL" value="${widgetSettings.centralCircleImage}" data-widget-part="centralCircleImage" id="widget-input-centralCircleImage">
                        <input type="file" id="widget-upload-centralCircleImage" data-widget-target="centralCircleImage" class="widget-upload-input" accept="image/*" style="display:none;">
                        <label for="widget-upload-centralCircleImage" class="btn btn-secondary btn-small" style="margin-top: 5px;">本地上传</label>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div>
                            <div class="form-group"><label>左上角文字</label><input type="text" class="form-group" value="${widgetSettings.topLeft.text}" data-widget-part="topLeft" data-widget-prop="text"></div>
                            <div class="form-group"><label>左上角图片URL</label><input type="url" class="form-group" value="${widgetSettings.topLeft.imageUrl}" data-widget-part="topLeft" data-widget-prop="imageUrl" id="widget-input-topLeft-imageUrl">
                                <input type="file" id="widget-upload-topLeft-imageUrl" data-widget-target="topLeft" data-widget-prop="imageUrl" class="widget-upload-input" accept="image/*" style="display:none;">
                                <label for="widget-upload-topLeft-imageUrl" class="btn btn-secondary btn-small" style="margin-top: 5px;">本地上传</label>
                            </div>
                        </div>
                        <div>
                            <div class="form-group"><label>右上角文字</label><input type="text" class="form-group" value="${widgetSettings.topRight.text}" data-widget-part="topRight" data-widget-prop="text"></div>
                            <div class="form-group"><label>右上角图片URL</label><input type="url" class="form-group" value="${widgetSettings.topRight.imageUrl}" data-widget-part="topRight" data-widget-prop="imageUrl" id="widget-input-topRight-imageUrl">
                                <input type="file" id="widget-upload-topRight-imageUrl" data-widget-target="topRight" data-widget-prop="imageUrl" class="widget-upload-input" accept="image/*" style="display:none;">
                                <label for="widget-upload-topRight-imageUrl" class="btn btn-secondary btn-small" style="margin-top: 5px;">本地上传</label>
                            </div>
                        </div>
                        <div>
                            <div class="form-group"><label>左下角文字</label><input type="text" class="form-group" value="${widgetSettings.bottomLeft.text}" data-widget-part="bottomLeft" data-widget-prop="text"></div>
                            <div class="form-group"><label>左下角图片URL</label><input type="url" class="form-group" value="${widgetSettings.bottomLeft.imageUrl}" data-widget-part="bottomLeft" data-widget-prop="imageUrl" id="widget-input-bottomLeft-imageUrl">
                                <input type="file" id="widget-upload-bottomLeft-imageUrl" data-widget-target="bottomLeft" data-widget-prop="imageUrl" class="widget-upload-input" accept="image/*" style="display:none;">
                                <label for="widget-upload-bottomLeft-imageUrl" class="btn btn-secondary btn-small" style="margin-top: 5px;">本地上传</label>
                            </div>
                        </div>
                        <div>
                            <div class="form-group"><label>右下角文字</label><input type="text" class="form-group" value="${widgetSettings.bottomRight.text}" data-widget-part="bottomRight" data-widget-prop="text"></div>
                            <div class="form-group"><label>右下角图片URL</label><input type="url" class="form-group" value="${widgetSettings.bottomRight.imageUrl}" data-widget-part="bottomRight" data-widget-prop="imageUrl" id="widget-input-bottomRight-imageUrl">
                                <input type="file" id="widget-upload-bottomRight-imageUrl" data-widget-target="bottomRight" data-widget-prop="imageUrl" class="widget-upload-input" accept="image/*" style="display:none;">
                                <label for="widget-upload-bottomRight-imageUrl" class="btn btn-secondary btn-small" style="margin-top: 5px;">本地上传</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
            customizeForm.insertAdjacentHTML('beforeend', widgetSectionHTML);

            // --- 3. 全局CSS美化部分 ---
            const globalCssSectionHTML = `
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <h4>全局CSS美化</h4>
                    <span class="collapsible-arrow">▼</span>
                </div>
                <div class="collapsible-content">
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <label for="global-beautification-css" style="font-weight: bold; font-size: 1.1em; color: var(--primary-color); margin-bottom: 0;">全局美化CSS代码</label>
                            <button type="button" id="apply-global-css-now-btn" class="btn btn-primary btn-small">立即应用</button>
                        </div>
                        <textarea id="global-beautification-css" class="form-group" rows="8" placeholder="在此输入CSS代码... 您的创造力没有边界！"></textarea>
                    </div>
                    <div class="panel panel-sm" style="padding:12px;border-radius:10px;border:1px solid var(--border-color,#e8e8ef);background:var(--panel-bg,#fff);box-shadow:var(--panel-shadow,0 4px 12px rgba(20,20,30,0.04));margin:10px 0;">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                            <label for="global-css-preset-select" style="width:auto;color:var(--muted,#667);font-size:13px; font-weight: bold;">全局样式预设库</label>
                            <select id="global-css-preset-select" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--input-border,#e6e6ea);background:var(--input-bg,#fff);font-size:14px;"><option value="">-- 选择预设 --</option></select>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;justify-content: flex-end;">
                            <button type="button" id="global-css-apply-btn" class="btn btn-primary" style="padding:7px 10px;border-radius:8px;">应用预设</button>
                            <button type="button" id="global-css-save-btn" class="btn" style="padding:7px 10px;border-radius:8px;">存为预设</button>
                            <button type="button" id="global-css-manage-btn" class="btn" style="padding:7px 10px;border-radius:8px;">管理</button>
                        </div>
                    </div>
                </div>
            </div>
            `;
            customizeForm.insertAdjacentHTML('beforeend', globalCssSectionHTML);

            // 填充预设下拉框
            populateGlobalCssPresetSelect();

            // --- 新增：为所有折叠标题添加一个点击事件监听器 ---
            customizeForm.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                   header.parentElement.classList.toggle('open');
                });
            });

            // 重新绑定之前已有的事件监听器
            const globalCssTextarea = document.getElementById('global-beautification-css');
            if (globalCssTextarea) {
                globalCssTextarea.value = db.globalCss || '';
            }
            const applyGlobalCssNowBtn = document.getElementById('apply-global-css-now-btn');
            if (applyGlobalCssNowBtn) {
                applyGlobalCssNowBtn.addEventListener('click', async () => {
                    const newCss = globalCssTextarea.value;
                    db.globalCss = newCss;
                    applyGlobalCss(newCss);
                    await dataStorage.saveData('globalCss', newCss);
                    showToast('全局样式已应用');
                });
            }
            const globalCssApplyBtn = document.getElementById('global-css-apply-btn');
            if (globalCssApplyBtn) {
                globalCssApplyBtn.addEventListener('click', () => {
                    const select = document.getElementById('global-css-preset-select');
                    const presetName = select.value;
                    if (!presetName) return showToast('请选择一个预设');
                    const preset = db.globalCssPresets.find(p => p.name === presetName);
                    if (preset) {
                        globalCssTextarea.value = preset.css;
                        db.globalCss = preset.css;
                        applyGlobalCss(preset.css);
                        dataStorage.saveData('globalCss', preset.css);
                        showToast('全局CSS预设已应用');
                    }
                });
            }
            const globalCssSaveBtn = document.getElementById('global-css-save-btn');
            if (globalCssSaveBtn) {
                 globalCssSaveBtn.addEventListener('click', () => {
                    const css = globalCssTextarea.value.trim();
                    if (!css) return showToast('CSS内容为空，无法保存');
                    const name = prompt('请输入此预设的名称（同名将覆盖）:');
                    if (!name) return;
                    if (!db.globalCssPresets) db.globalCssPresets = [];
                    const existingIndex = db.globalCssPresets.findIndex(p => p.name === name);
                    if (existingIndex > -1) {
                        db.globalCssPresets[existingIndex].css = css;
                    } else {
                        db.globalCssPresets.push({ name, css });
                    }
                    dataStorage.saveData('globalCssPresets', db.globalCssPresets);
                    populateGlobalCssPresetSelect();
                    showToast('全局CSS预设已保存');
                });
            }
            const globalCssManageBtn = document.getElementById('global-css-manage-btn');
            if (globalCssManageBtn) {
                 globalCssManageBtn.addEventListener('click', openGlobalCssManageModal);
            }
        }


        function setupTutorialApp() {
            tutorialContentArea.addEventListener('click', (e) => {
                const header = e.target.closest('.tutorial-header');
                if (header) {
                    header.parentElement.classList.toggle('open');
                }
            });
        }
        let loadingBtn = false

        function renderTutorialContent() {
            const tutorials = [
                {title: '写在前面', imageUrls: ['https://i.postimg.cc/7PgyMG9S/image.jpg']},
                {
                    title: '软件介绍',
                    imageUrls: ['https://i.postimg.cc/VvsJRh6q/IMG-20250713-162647.jpg', 'https://i.postimg.cc/8P5FfxxD/IMG-20250713-162702.jpg', 'https://i.postimg.cc/3r94R3Sn/IMG-20250713-162712.jpg']
                },
                {
                    title: '404',
                    imageUrls: ['https://i.postimg.cc/x8scFPJW/IMG-20250713-162756.jpg', 'https://i.postimg.cc/pX6mfqtj/IMG-20250713-162809.jpg', 'https://i.postimg.cc/YScjV00q/IMG-20250713-162819.jpg', 'https://i.postimg.cc/13VfJw9j/IMG-20250713-162828.jpg']
                },
                {title: '404-群聊', imageUrls: ['https://i.postimg.cc/X7LSmRTJ/404.jpg']}
            ];
            tutorialContentArea.innerHTML = '';
            tutorials.forEach(tutorial => {
                const item = document.createElement('div');
                item.className = 'tutorial-item';
                const imagesHtml = tutorial.imageUrls.map(url => `<img src="${url}" alt="${tutorial.title}教程图片">`).join('');
                item.innerHTML = `<div class="tutorial-header">${tutorial.title}</div><div class="tutorial-content">${imagesHtml}</div>`;
                tutorialContentArea.appendChild(item);
            });

            const backupDataBtn = document.createElement('button');
            backupDataBtn.className = 'btn btn-primary';
            backupDataBtn.textContent = '备份数据';
            backupDataBtn.disabled = loadingBtn

            backupDataBtn.addEventListener('click', async () => {
                if(loadingBtn){
                    return
                }
                loadingBtn = true
                try {
                    showToast('正在准备导出数据...');

                    // 创建完整的数据备份对象
                    const fullBackupData = await createFullBackupData();

                    const jsonString = JSON.stringify(fullBackupData);
                    const dataBlob = new Blob([jsonString]);

                    // Compress the data using Gzip
                    const compressionStream = new CompressionStream('gzip');
                    const compressedStream = dataBlob.stream().pipeThrough(compressionStream);
                    const compressedBlob = await new Response(compressedStream, { headers: { 'Content-Type': 'application/octet-stream' } }).blob();

                    const url = URL.createObjectURL(compressedBlob);
                    const a = document.createElement('a');
                    const now = new Date();
                    const date = now.toISOString().slice(0, 10);
                    const time = now.toTimeString().slice(0, 8).replace(/:/g, '');
                    a.href = url;
                    a.download = `章鱼喷墨_备份数据_${date}_${time}.ee`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    loadingBtn = false
                    showToast('聊天记录导出成功');
                }catch (e){
                    loadingBtn = false
                    showToast(`导出失败, 发生错误: ${e.message}`);
                    console.error('导出错误详情:', e);
                }
            });
            const importDataBtn = document.createElement('label');
            importDataBtn.className = 'btn btn-neutral';
            importDataBtn.textContent = '导入数据';
            importDataBtn.style.marginTop = '15px'
            importDataBtn.style.display = 'block'
            importDataBtn.disabled = loadingBtn;
            importDataBtn.setAttribute('for', 'import-data-input')
            document.querySelector('#import-data-input').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                if(confirm('此操作将覆盖当前所有聊天记录和设置。此操作不可撤销。确定要继续吗？')){
                    try {
                        showToast('正在导入数据，请稍候...');

                        // Decompress the file stream
                        const decompressionStream = new DecompressionStream('gzip');
                        const decompressedStream = file.stream().pipeThrough(decompressionStream);
                        const jsonString = await new Response(decompressedStream).text();

                        let data = JSON.parse(jsonString);

                        // 检测数据格式并进行兼容性处理
                        const importResult = await importBackupData(data);

                        if (importResult.success) {
                            showToast(`数据导入成功！${importResult.message} 应用即将刷新。`);
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showToast(`导入失败: ${importResult.error}`);
                        }
                    } catch (error) {
                        console.error("导入失败:", error);
                        showToast(`解压或解析文件时发生错误: ${error.message}`);
                    } finally {
                        event.target.value = null;
                    }
                }else {
                    event.target.value = null;
                }

            })

            tutorialContentArea.appendChild(backupDataBtn);
            tutorialContentArea.appendChild(importDataBtn);
        }

        // --- Chat List & Chat Room ---
        function setupChatListScreen() {
            renderChatList();
            addChatBtn.addEventListener('click', () => {
                addCharModal.classList.add('visible');
                addCharForm.reset();
            });
            chatListContainer.addEventListener('click', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (chatItem) {
                    currentChatId = chatItem.dataset.id;
                    currentChatType = chatItem.dataset.type;
                    openChatRoom(currentChatId, currentChatType);
                }
            });
            chatListContainer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const chatItem = e.target.closest('.chat-item');
                if (!chatItem) return;
                handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, e.clientX, e.clientY);
            });
            chatListContainer.addEventListener('touchstart', (e) => {
                const chatItem = e.target.closest('.chat-item');
                if (!chatItem) return;
                longPressTimer = setTimeout(() => {
                    const touch = e.touches[0];
                    handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, touch.clientX, touch.clientY);
                }, 400);
            });
            chatListContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
            chatListContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));
        }

        function handleChatListLongPress(chatId, chatType, x, y) {
            clearTimeout(longPressTimer);
            const chatItem = (chatType === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
            if (!chatItem) return;
            const itemName = chatType === 'private' ? chatItem.remarkName : chatItem.name;
            const menuItems = [{
                label: chatItem.isPinned ? '取消置顶' : '置顶聊天',
                action: async () => {
                    chatItem.isPinned = !chatItem.isPinned;
                    await saveData();
                    renderChatList();
                }
            }, {
                label: '删除聊天',
                danger: true,
                action: async () => {
                    if (confirm(`确定要删除与“${itemName}”的聊天记录吗？此操作不可恢复。`)) {
                        if (chatType === 'private') {
                            // 从数据库中删除角色数据和消息历史
                            await dataStorage.removeData(`character_${chatId}`);
                            await dataStorage.clearChatMessages(chatId, 'private');
                            // 从内存中移除
                            db.characters = db.characters.filter(c => c.id !== chatId);
                        } else {
                            // 从数据库中删除群组数据和消息历史
                            await dataStorage.removeData(`group_${chatId}`);
                            await dataStorage.clearChatMessages(chatId, 'group');
                            // 从内存中移除
                            db.groups = db.groups.filter(g => g.id !== chatId);
                        }
                        await saveData(); // 保存更改后的角色/群组列表
                        renderChatList();
                        showToast('聊天已删除');
                    }
                }
            }];
            createContextMenu(menuItems, x, y);
        }

        function renderChatList() {
            chatListContainer.innerHTML = '';
            const allChats = [...db.characters.map(c => ({...c, type: 'private'})), ...db.groups.map(g => ({
                ...g,
                type: 'group'
            }))];
            noChatsPlaceholder.style.display = (db.characters.length + db.groups.length) === 0 ? 'block' : 'none';
            const sortedChats = allChats.sort((a, b) => {
                if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
                const lastMsgTimeA = a.history && a.history.length > 0 ? a.history[a.history.length - 1].timestamp : 0;
                const lastMsgTimeB = b.history && b.history.length > 0 ? b.history[b.history.length - 1].timestamp : 0;
                return lastMsgTimeB - lastMsgTimeA;
            });
            sortedChats.forEach(chat => {
                let lastMessageText = '开始聊天吧...';
                if (chat.history && chat.history.length > 0) {
                    const invisibleRegex = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]|\[.*?邀请.*?加入了群聊\]|\[.*?修改群名为：.*?\]|\[system-display:.*?\]/;
                    const visibleHistory = chat.history.filter(msg => !invisibleRegex.test(msg.content));
                    if (visibleHistory.length > 0) {
                        const lastMsg = visibleHistory[visibleHistory.length - 1];
                        const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|data:image\/[a-z]+;base64,)/i;
                        const imageRecogRegex = /\[.*?发来了一张图片：\]/
                        const voiceRegex = /\[.*?的语音：.*?\]/;
                        const photoVideoRegex = /\[.*?发来的照片\/视频：.*?\]/;
                        const transferRegex = /\[.*?的转账：.*?元.*?\]|\[.*?给你转账：.*?元.*?\]|\[.*?向.*?转账：.*?元.*?\]/;
                        const stickerRegex = /\[.*?的表情包：.*?\]|\[.*?发送的表情包：.*?\]/;
                        const giftRegex = /\[.*?送来的礼物：.*?\]|\[.*?向.*?送来了礼物：.*?\]/;



                        if (giftRegex.test(lastMsg.content)) {
                            lastMessageText = '[礼物]';
                        } else if (stickerRegex.test(lastMsg.content)) {
                            lastMessageText = '[表情包]';
                        } else if (voiceRegex.test(lastMsg.content)) {
                            lastMessageText = '[语音]';
                        } else if (photoVideoRegex.test(lastMsg.content)) {
                            lastMessageText = '[照片/视频]';
                        } else if (transferRegex.test(lastMsg.content)) {
                            lastMessageText = '[转账]';
                        } else if (imageRecogRegex.test(lastMsg.content) || (lastMsg.parts && lastMsg.parts.some(p => p.type === 'image'))) {
                            lastMessageText = '[图片]';
                        }else if ((lastMsg.parts && lastMsg.parts.some(p => p.type === 'html'))) {
                            lastMessageText = '[互动]';
                        } else {
                            const textMatch = lastMsg.content.match(/\[.*?的消息：([\s\S]+)\]/);
                            // ...
let text = lastMsg.content.trim();
const plainTextMatch = text.match(/^\[.*?：([\s\S]*)\]$/);
if (plainTextMatch && plainTextMatch[1]) {
    text = plainTextMatch[1].trim();
}
text = text.replace(/\[发送时间:.*?\]$/, '').trim(); // 擦掉时间戳
const htmlRegex = /<[a-z][\s\S]*>/i;
if (htmlRegex.test(text)) {
    lastMessageText = '[互动]';
} else {
    lastMessageText = urlRegex.test(text) ? '[图片]' : text;
}
                        }
                    } else {
                        const lastEverMsg = chat.history[chat.history.length - 1];
                        const inviteRegex = /\[(.*?)邀请(.*?)加入了群聊\]/;
                        const renameRegex = /\[.*?修改群名为：.*?\]/;
                        const timeSkipRegex = /\[system-display:([\s\S]+?)\]/;
                        const timeSkipMatch = lastEverMsg.content.match(timeSkipRegex);

                        if (timeSkipMatch) {
                            lastMessageText = timeSkipMatch[1];
                        } else if (inviteRegex.test(lastEverMsg.content)) {
                            lastMessageText = '新成员加入了群聊';
                        } else if (renameRegex.test(lastEverMsg.content)) {
                            lastMessageText = '群聊名称已修改';
                        }
                    }
                }
                const li = document.createElement('li');
                li.className = 'list-item chat-item';
                if (chat.isPinned) li.classList.add('pinned');
                li.dataset.id = chat.id;
                li.dataset.type = chat.type;
                const avatarClass = chat.type === 'group' ? 'group-avatar' : '';
                const itemName = chat.type === 'private' ? chat.remarkName : chat.name;
                const pinBadgeHTML = chat.isPinned ? '<span class="pin-badge">置顶</span>' : '';
                li.innerHTML = `
                <img src="${chat.avatar}" alt="${itemName}" class="chat-avatar ${avatarClass}">
                <div class="item-details">
                    <div class="item-details-row"><div class="item-name">${itemName}</div></div>
                    <div class="item-preview-wrapper"><div class="item-preview">${lastMessageText}</div>${pinBadgeHTML}</div>
                </div>`;
                chatListContainer.appendChild(li);
            });
        }

        function setupAddCharModal() {
            addCharForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newChar = {
                    id: `char_${Date.now()}`,
                    realName: document.getElementById('char-real-name').value,
                    remarkName: document.getElementById('char-remark-name').value,
                    persona: '',
                    avatar: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg',
                    myName: document.getElementById('my-name-for-char').value,
                    myPersona: '',
                    myAvatar: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg',
                    theme: 'white_pink',
                    maxMemory: 10,
                    chatBg: '',
                    history: [],
                    isPinned: false,
                    status: '在线',
                    worldBookIds: [],
                    useCustomBubbleCss: false,
                    customBubbleCss: '',
                    memoryJournals: [],
                    journalWorldBookIds: [], // 新增
                    peekScreenSettings: { wallpaper: '', customIcons: {}, unlockAvatar: '' }, // 新增
 lastUserMessageTimestamp: null, // 新增：用于记录最后消息时间
               };
                db.characters.push(newChar);
                await saveData();
                renderChatList();
                addCharModal.classList.remove('visible');
                showToast(`角色“${newChar.remarkName}”创建成功！`);
            });
        }

        function setupChatRoom() {
            const placeholderPlusBtn = document.getElementById('placeholder-plus-btn');
            const chatExpansionPanel = document.getElementById('chat-expansion-panel');

            placeholderPlusBtn.addEventListener('click', () => {
                // Hide sticker modal if open
                if (stickerModal.classList.contains('visible')) {
                    stickerModal.classList.remove('visible');
                }
                chatExpansionPanel.classList.toggle('visible');
            });

            sendMessageBtn.addEventListener('click', sendMessage);
            sendMessageBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                sendMessage();
                setTimeout(() => {
                    messageInput.focus();
                }, 50);
            });
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !isGenerating) sendMessage();
            });
            getReplyBtn.addEventListener('click', getAiReply);
            regenerateBtn.addEventListener('click', handleRegenerate);
            messageArea.addEventListener('click', (e) => {
                // --- Close any open panels when clicking message area ---
                if (stickerModal.classList.contains('visible')) {
                    stickerModal.classList.remove('visible');
                    return;
                }
                if (chatExpansionPanel.classList.contains('visible')) {
                    chatExpansionPanel.classList.remove('visible');
                    return;
                }
                // --- End close panels ---

                if (e.target && e.target.id === 'load-more-btn') {
                    loadMoreMessages();
                } else if (isInMultiSelectMode) {
                    const messageWrapper = e.target.closest('.message-wrapper');
                    if (messageWrapper) {
                        toggleMessageSelection(messageWrapper.dataset.id);
                    }
                } else {
                    const voiceBubble = e.target.closest('.voice-bubble');
                    if (voiceBubble) {
                        const transcript = voiceBubble.closest('.message-wrapper').querySelector('.voice-transcript');
                        if (transcript) {
                            transcript.classList.toggle('active');
                        }
                    }
                    const pvCard = e.target.closest('.pv-card');
                    if (pvCard) {
                        const imageOverlay = pvCard.querySelector('.pv-card-image-overlay');
                        const footer = pvCard.querySelector('.pv-card-footer');
                        imageOverlay.classList.toggle('hidden');
                        footer.classList.toggle('hidden');
                    }
                    const giftCard = e.target.closest('.gift-card');
                    if (giftCard) {
                        const description = giftCard.closest('.message-wrapper').querySelector('.gift-card-description');
                        if (description) {
                            description.classList.toggle('active');
                        }
                    }
                    const transferCard = e.target.closest('.transfer-card.received-transfer');
                    if (transferCard && currentChatType === 'private') {
                        const messageWrapper = transferCard.closest('.message-wrapper');
                        const messageId = messageWrapper.dataset.id;
                        const character = db.characters.find(c => c.id === currentChatId);
                        const message = character.history.find(m => m.id === messageId);
                        if (message && message.transferStatus === 'pending') {
                            handleReceivedTransferClick(messageId);
                        }
                    }
                }
            });
            messageArea.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if (e.target.id === 'load-more-btn' || isInMultiSelectMode) return;
                const messageWrapper = e.target.closest('.message-wrapper');
                if (!messageWrapper) return;
                handleMessageLongPress(messageWrapper, e.clientX, e.clientY);
            });
            messageArea.addEventListener('touchstart', (e) => {
                if (e.target.id === 'load-more-btn') return;
                const messageWrapper = e.target.closest('.message-wrapper');
                if (!messageWrapper) return;
                longPressTimer = setTimeout(() => {
                    const touch = e.touches[0];
                    handleMessageLongPress(messageWrapper, touch.clientX, touch.clientY);
                }, 400);
            });
            messageArea.addEventListener('touchend', () => clearTimeout(longPressTimer));
            messageArea.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            saveEditBtn.addEventListener('click', saveMessageEdit);
            cancelEditBtn.addEventListener('click', cancelMessageEdit);
            cancelMultiSelectBtn.addEventListener('click', exitMultiSelectMode);
            deleteSelectedBtn.addEventListener('click', deleteSelectedMessages);
        }

        function handleMessageLongPress(messageWrapper, x, y) {
            if (isInMultiSelectMode) return;
            clearTimeout(longPressTimer);
            const messageId = messageWrapper.dataset.id;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const message = chat.history.find(m => m.id === messageId);
            if (!message) return;

            const isImageRecognitionMsg = message.parts && message.parts.some(p => p.type === 'image');
            const isVoiceMessage = /\[.*?的语音：.*?\]/.test(message.content);
            const isStickerMessage = /\[.*?的表情包：.*?\]|\[.*?发送的表情包：.*?\]/.test(message.content);
            const isPhotoVideoMessage = /\[.*?发来的照片\/视频：.*?\]/.test(message.content);
            const isTransferMessage = /\[.*?给你转账：.*?\]|\[.*?的转账：.*?\]|\[.*?向.*?转账：.*?\]/.test(message.content);
            const isGiftMessage = /\[.*?送来的礼物：.*?\]|\[.*?向.*?送来了礼物：.*?\]/.test(message.content);
            const isInvisibleMessage = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]|\[.*?邀请.*?加入了群聊\]|\[.*?修改群名为：.*?\]|\[system-display:.*?\]/.test(message.content);

            let menuItems = [];
            if (!isImageRecognitionMsg && !isVoiceMessage && !isStickerMessage && !isPhotoVideoMessage && !isTransferMessage && !isGiftMessage && !isInvisibleMessage) {
                menuItems.push({label: '编辑', action: () => startMessageEdit(messageId)});
            }
            menuItems.push({label: '删除', action: () => enterMultiSelectMode(messageId)});

            if (menuItems.length > 0) {
                createContextMenu(menuItems, x, y);
            }
        }

        function startMessageEdit(messageId) {
            exitMultiSelectMode();
            editingMessageId = messageId;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
           //...
const message = chat.history.find(m => m.id === messageId);
if (!message) return;

// --- 从这里开始是替换后的新代码 ---
let contentToEdit = message.content;
const plainTextMatch = contentToEdit.match(/^\[.*?：([\s\S]*)\]$/);
if (plainTextMatch && plainTextMatch[1]) {
    contentToEdit = plainTextMatch[1].trim();
}
// --- 到这里结束 ---
contentToEdit = contentToEdit.replace(/\[发送时间:.*?\]/g, '').trim(); // <--- 加上这一行
messageEditInput.value = contentToEdit;

            messageInputDefault.style.display = 'none';
            messageEditBar.style.display = 'flex';
            messageEditInput.focus();
        }

        async function saveMessageEdit() {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const messageIndex = chat.history.findIndex(m => m.id === editingMessageId);
            if (messageIndex === -1) return;
           // ...
const newTextRaw = messageEditInput.value.trim();
if (newTextRaw) {
    let newText = newTextRaw; // 先把干净的文字存起来




    const oldContent = chat.history[messageIndex].content;
    const prefixMatch = oldContent.match(/(\[.*?的消息：)[\s\S]+\]/);
    let newContent;

    if (prefixMatch && prefixMatch[1]) {
        const prefix = prefixMatch[1];
        newContent = `${prefix}${newText}]`;
    } else {
        newContent = newTextRaw;
    }

    chat.history[messageIndex].content = newContent;

    if (chat.history[messageIndex].parts) {
        chat.history[messageIndex].parts = [{type: 'text', text: newContent}];
    }
                await saveData();
                currentPage = 1;
                renderMessages(false, true);
                renderChatList();
            }
            cancelMessageEdit();
        }

        function cancelMessageEdit() {
            editingMessageId = null;
            messageInputDefault.style.display = 'flex';
            messageEditBar.style.display = 'none';
        }

        function enterMultiSelectMode(initialMessageId) {
            isInMultiSelectMode = true;
            chatRoomHeaderDefault.style.display = 'none';
            chatRoomHeaderSelect.style.display = 'flex';
            document.querySelector('.chat-input-wrapper').style.display = 'none';
            multiSelectBar.classList.add('visible');
            chatRoomScreen.classList.add('multi-select-active');
            selectedMessageIds.clear();
            if (initialMessageId) {
                toggleMessageSelection(initialMessageId);
            }
        }

        function exitMultiSelectMode() {
            isInMultiSelectMode = false;
            chatRoomHeaderDefault.style.display = 'flex';
            chatRoomHeaderSelect.style.display = 'none';
            document.querySelector('.chat-input-wrapper').style.display = 'block';
            multiSelectBar.classList.remove('visible');
            chatRoomScreen.classList.remove('multi-select-active');
            selectedMessageIds.forEach(id => {
                const el = messageArea.querySelector(`.message-wrapper[data-id="${id}"]`);
                if (el) el.classList.remove('multi-select-selected');
            });
            selectedMessageIds.clear();
        }

        function toggleMessageSelection(messageId) {
            const el = messageArea.querySelector(`.message-wrapper[data-id="${messageId}"]`);
            if (!el) return;
            if (selectedMessageIds.has(messageId)) {
                selectedMessageIds.delete(messageId);
                el.classList.remove('multi-select-selected');
            } else {
                selectedMessageIds.add(messageId);
                el.classList.add('multi-select-selected');
            }
            selectCount.textContent = `已选择 ${selectedMessageIds.size} 项`;
            deleteSelectedBtn.disabled = selectedMessageIds.size === 0;
        }

        async function deleteSelectedMessages() {
            if (selectedMessageIds.size === 0) return;
            const deletedCount = selectedMessageIds.size;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            chat.history = chat.history.filter(m => !selectedMessageIds.has(m.id));
            await saveData();
            currentPage = 1;
            renderMessages(false, true);
            renderChatList();
            exitMultiSelectMode();
            showToast(`已删除 ${deletedCount} 条消息`);
        }

        function openChatRoom(chatId, type) {
            const chat = (type === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
            if (!chat) return;
            exitMultiSelectMode();
            cancelMessageEdit();
            chatRoomTitle.textContent = (type === 'private') ? chat.remarkName : chat.name;
            const subtitle = document.getElementById('chat-room-subtitle');
            if (type === 'private') {
                subtitle.style.display = 'flex';
                chatRoomStatusText.textContent = chat.status || '在线';
            } else {
                subtitle.style.display = 'none';
            }
            getReplyBtn.style.display = 'inline-flex';
            chatRoomScreen.style.backgroundImage = chat.chatBg ? `url(${chat.chatBg})` : 'none';
            typingIndicator.style.display = 'none';
            isGenerating = false;
            getReplyBtn.disabled = false;
            currentPage = 1;
            chatRoomScreen.className = chatRoomScreen.className.replace(/\bchat-active-[^ ]+\b/g, '');
            chatRoomScreen.classList.add(`chat-active-${chatId}`);
            updateCustomBubbleStyle(chatId, chat.customBubbleCss, chat.useCustomBubbleCss);
            renderMessages(false, true);
            switchScreen('chat-room-screen');
        }

        function renderMessages(isLoadMore = false, forceScrollToBottom = false) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat || !chat.history) return;
            const oldScrollHeight = messageArea.scrollHeight;
            const totalMessages = chat.history.length;
            const end = totalMessages - (currentPage - 1) * MESSAGES_PER_PAGE;
            const start = Math.max(0, end - MESSAGES_PER_PAGE);
            const messagesToRender = chat.history.slice(start, end);
            if (!isLoadMore) messageArea.innerHTML = '';
            const fragment = document.createDocumentFragment();
            messagesToRender.forEach(msg => {
                const bubble = createMessageBubbleElement(msg);
                if (bubble) fragment.appendChild(bubble);
            });
            const existingLoadBtn = document.getElementById('load-more-btn');
            if (existingLoadBtn) existingLoadBtn.remove();
            messageArea.prepend(fragment);
            if (totalMessages > currentPage * MESSAGES_PER_PAGE) {
                const loadMoreButton = document.createElement('button');
                loadMoreButton.id = 'load-more-btn';
                loadMoreButton.className = 'load-more-btn';
                loadMoreButton.textContent = '加载更早的消息';
                messageArea.prepend(loadMoreButton);
            }
            if (forceScrollToBottom) {
                setTimeout(() => {
                    messageArea.scrollTop = messageArea.scrollHeight;
                }, 0);
            } else if (isLoadMore) {
                messageArea.scrollTop = messageArea.scrollHeight - oldScrollHeight;
            }
        }

        function loadMoreMessages() {
            currentPage++;
            renderMessages(true, false);
        }

        function calculateVoiceDuration(text) {
            return Math.max(1, Math.min(60, Math.ceil(text.length / 3.5)));
        }

        function createMessageBubbleElement(message) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const {role, content, timestamp, id, transferStatus, giftStatus, stickerData, senderId} = message;

            const timeSkipRegex = /\[system-display:([\s\S]+?)\]/;
            const inviteRegex = /\[(.*?)邀请(.*?)加入了群聊\]/;
            const renameRegex = /\[(.*?)修改群名为：(.*?)\]/;
            const timeSkipMatch = content.match(timeSkipRegex);
            const inviteMatch = content.match(inviteRegex);
            const renameMatch = content.match(renameRegex);
            const invisibleRegex = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]|\[系统情景通知：.*?\]/;
            if (invisibleRegex.test(content)) {
                return null;
            }

            const wrapper = document.createElement('div');
            wrapper.dataset.id = id;

            if (timeSkipMatch || inviteMatch || renameMatch) {
                wrapper.className = 'message-wrapper system-notification';
                let bubbleText = '';
                if (timeSkipMatch) bubbleText = timeSkipMatch[1];
                if (inviteMatch) bubbleText = `${inviteMatch[1]}邀请${inviteMatch[2]}加入了群聊`;
                if (renameMatch) bubbleText = `${renameMatch[1]}修改群名为“${renameMatch[2]}”`;
                wrapper.innerHTML = `<div class="system-notification-bubble">${bubbleText}</div>`;
                return wrapper;
            }

            const isSent = (role === 'user');
            let avatarUrl, bubbleTheme, senderNickname = '';
            const themeKey = chat.theme || 'white_pink';
            const theme = colorThemes[themeKey] || colorThemes['white_pink'];
            let messageSenderId = isSent ? 'user_me' : senderId;

            if (isSent) {
                avatarUrl = (currentChatType === 'private') ? chat.myAvatar : chat.me.avatar;
                bubbleTheme = theme.sent;
            } else {
                if (currentChatType === 'private') {
                    avatarUrl = chat.avatar;
                } else { // Group chat received
                    const sender = chat.members.find(m => m.id === senderId);
                    if (sender) {
                        avatarUrl = sender.avatar;
                        senderNickname = sender.groupNickname;
                    } else { // Fallback for unknown sender
                        avatarUrl = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
                    }
                }
                bubbleTheme = theme.received;
            }
            const timeString = `${pad(new Date(timestamp).getHours())}:${pad(new Date(timestamp).getMinutes())}`;
            wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
            if (currentChatType === 'group' && !isSent) {
                wrapper.classList.add('group-message');
            }
            const bubbleRow = document.createElement('div');
            bubbleRow.className = 'message-bubble-row';
            let bubbleElement;

            // Regexes for all message types
            const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|data:image\/[a-z]+;base64,)/i;
            const sentStickerRegex = /\[(?:.+?)的表情包：.+?\]/i;
            const receivedStickerRegex = /\[(?:.+?)发送的表情包：([\s\S]+?)\]/i;
            const voiceRegex = /\[(?:.+?)的语音：([\s\S]+?)\]/;
            const photoVideoRegex = /\[(?:.+?)发来的照片\/视频：([\s\S]+?)\]/;
            const privateSentTransferRegex = /\[.*?给你转账：([\d.]+)元；备注：(.*?)\]/;
            const privateReceivedTransferRegex = /\[.*?的转账：([\d.]+)元；备注：(.*?)\]/;
            const groupTransferRegex = /\[(.*?)\s*向\s*(.*?)\s*转账：([\d.]+)元；备注：(.*?)\]/;
            const privateGiftRegex = /\[(?:.+?)送来的礼物：([\s\S]+?)\]/;
            const groupGiftRegex = /\[(.*?)\s*向\s*(.*?)\s*送来了礼物：([\s\S]+?)\]/;
            const imageRecogRegex = /\[.*?发来了一张图片：\]/;
            const textRegex = /\[(?:.+?)的消息：([\s\S]+?)\]/;

            const sentStickerMatch = content.match(sentStickerRegex);
            const receivedStickerMatch = content.match(receivedStickerRegex);
            const voiceMatch = content.match(voiceRegex);
            const photoVideoMatch = content.match(photoVideoRegex);
            const privateSentTransferMatch = content.match(privateSentTransferRegex);
            const privateReceivedTransferMatch = content.match(privateReceivedTransferRegex);
            const groupTransferMatch = content.match(groupTransferRegex);
            const privateGiftMatch = content.match(privateGiftRegex);
            const groupGiftMatch = content.match(groupGiftRegex);
            const imageRecogMatch = content.match(imageRecogRegex);
            const textMatch = content.match(textRegex);



            if ((isSent && sentStickerMatch && stickerData) || (!isSent && receivedStickerMatch)) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'image-bubble';
                let stickerSrc = '';

                if (isSent) {
                    // 如果是你自己发的表情包，直接使用数据
                    stickerSrc = stickerData;
                } else {
                    // 如果是AI发的表情包，我们需要处理路径
                    // 原始路径，例如："害羞vHLfrV3K/1.jpg"
                    const rawPath = receivedStickerMatch[1].trim();

                    // 用一个新的正则表达式来提取需要的部分，例如："vHLfrV3K/1.jpg"
                    const pathExtractionRegex = /[a-zA-Z0-9]+\/.*$/;
                    const extractedPathMatch = rawPath.match(pathExtractionRegex);

                    // 如果正则成功匹配到了，就使用匹配到的结果
                    const finalPath = extractedPathMatch ? extractedPathMatch[0] : rawPath;

                    // 拼接成最终的图片URL
                    stickerSrc = `https://i.postimg.cc/${finalPath}`;
                }

                bubbleElement.innerHTML = `<img src="${stickerSrc}" alt="表情包">`;
            } else if (privateGiftMatch || groupGiftMatch) {
                const match = privateGiftMatch || groupGiftMatch;
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'gift-card';
                if (giftStatus === 'received') {
                    bubbleElement.classList.add('received');
                }

                let giftText;
                if (groupGiftMatch) {
                    const from = groupGiftMatch[1];
                    const to = groupGiftMatch[2];
                    giftText = isSent ? `你送给 ${to} 的礼物` : `${from} 送给 ${to} 的礼物`;
                } else {
                    giftText = isSent ? '您有一份礼物～' : '您有一份礼物～';
                }
                bubbleElement.innerHTML = `<img src="https://i.postimg.cc/rp0Yg31K/chan-75.png" alt="gift" class="gift-card-icon"><div class="gift-card-text">${giftText}</div><div class="gift-card-received-stamp">已查收</div>`;

                const description = groupGiftMatch ? groupGiftMatch[3].trim() : match[1].trim();
                const descriptionDiv = document.createElement('div');
                descriptionDiv.className = 'gift-card-description';
                descriptionDiv.textContent = description;
                wrapper.appendChild(descriptionDiv);
                       } else if (content.startsWith('[论坛分享]')) {
                const forumShareRegex = /\[论坛分享\]标题：([\s\S]+?)\n摘要：([\s\S]+)/;
                const forumShareMatch = content.match(forumShareRegex);

                if (forumShareMatch) {
                    const title = forumShareMatch[1].trim();
                    const summary = forumShareMatch[2].trim();

                    bubbleElement = document.createElement('div');
                    bubbleElement.className = 'forum-share-card';

                    // 这是卡片内部的HTML结构
                    bubbleElement.innerHTML = `
                        <div class="forum-share-header">
                            <svg viewBox="0 0 24 24"><path d="M21,3H3A2,2 0 0,0 1,5V19A2,2 0 0,0 3,21H21A2,2 0 0,0 23,19V5A2,2 0 0,0 21,3M21,19H3V5H21V19M8,11H16V9H8V11M8,15H13V13H8V15Z" /></svg>
                            <span>来自论坛的分享</span>
                        </div>
                        <div class="forum-share-content">
                            <div class="forum-share-title">${title}</div>
                            <div class="forum-share-summary">${summary}</div>
                        </div>
                    `;
                }
 } else if (voiceMatch) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'voice-bubble';
                if (!chat.useCustomBubbleCss) {
                    bubbleElement.style.backgroundColor = bubbleTheme.bg;
                    bubbleElement.style.color = bubbleTheme.text;
                }
                bubbleElement.innerHTML = `<svg class="play-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg><span class="duration">${calculateVoiceDuration(voiceMatch[1].trim())}"</span>`;
                const transcriptDiv = document.createElement('div');
                transcriptDiv.className = 'voice-transcript';
                transcriptDiv.textContent = voiceMatch[1].trim();
                wrapper.appendChild(transcriptDiv);
            } else if (photoVideoMatch) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'pv-card';
                bubbleElement.innerHTML = `<div class="pv-card-content">${photoVideoMatch[1].trim()}</div><div class="pv-card-image-overlay" style="background-image: url('${isSent ? 'https://i.postimg.cc/L8NFrBrW/1752307494497.jpg' : 'https://i.postimg.cc/1tH6ds9g/1752301200490.jpg'}');"></div><div class="pv-card-footer"><svg viewBox="0 0 24 24"><path d="M4,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M4,6V18H20V6H4M10,9A1,1 0 0,1 11,10A1,1 0 0,1 10,11A1,1 0 0,1 9,10A1,1 0 0,1 10,9M8,17L11,13L13,15L17,10L20,14V17H8Z"></path></svg><span>照片/视频・点击查看</span></div>`;
            } else if (privateSentTransferMatch || privateReceivedTransferMatch || groupTransferMatch) {
                const isSentTransfer = !!privateSentTransferMatch || (groupTransferMatch && isSent);
                const match = privateSentTransferMatch || privateReceivedTransferMatch || groupTransferMatch;

                let amount, remarkText, titleText;
                if (groupTransferMatch) {
                    const from = groupTransferMatch[1];
                    const to = groupTransferMatch[2];
                    amount = parseFloat(groupTransferMatch[3]).toFixed(2);
                    remarkText = groupTransferMatch[4] || '';
                    titleText = isSent ? `向 ${to} 转账` : `${from} 向你转账`;
                } else { // Private chat
                    amount = parseFloat(match[1]).toFixed(2);
                    remarkText = match[2] || '';
                    titleText = isSentTransfer ? '给你转账' : '转账';
                }

                bubbleElement = document.createElement('div');
                bubbleElement.className = `transfer-card ${isSentTransfer ? 'sent-transfer' : 'received-transfer'}`;

                let statusText = isSentTransfer ? '待查收' : '转账给你';
                if (groupTransferMatch && !isSent) statusText = '转账给Ta'; // AI to AI
                if (transferStatus === 'received') {
                    statusText = '已收款';
                    bubbleElement.classList.add('received');
                } else if (transferStatus === 'returned') {
                    statusText = '已退回';
                    bubbleElement.classList.add('returned');
                }
                if ((transferStatus !== 'pending' && currentChatType === 'private') || currentChatType === 'group') {
                    bubbleElement.style.cursor = 'default';
                }

                const remarkHTML = remarkText ? `<p class="transfer-remark">${remarkText}</p>` : '';
                bubbleElement.innerHTML = `<div class="overlay"></div><div class="transfer-content"><p class="transfer-title">${titleText}</p><p class="transfer-amount">¥${amount}</p>${remarkHTML}<p class="transfer-status">${statusText}</p></div>`;
            } else if (imageRecogMatch || urlRegex.test(content)) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'image-bubble';
                bubbleElement.innerHTML = `<img src="${content}" alt="图片消息">`;
            } else if (textMatch) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;

let userText = textMatch[1].trim().replace(/\[发送时间:.*?\]/g, '').trim();
const htmlRegex = /<[a-z][\s\S]*>/i;
if (htmlRegex.test(userText)) {
    bubbleElement.innerHTML = userText;
} else {
    bubbleElement.textContent = userText;
}
                if (!chat.useCustomBubbleCss) {
                    bubbleElement.style.backgroundColor = bubbleTheme.bg;
                    bubbleElement.style.color = bubbleTheme.text;
                }
            }else if(message && Array.isArray( message.parts) && message.parts[0].type === 'html'){
                bubbleElement = document.createElement('div');
                bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                bubbleElement.innerHTML = message.parts[0].text;
            } else {
                bubbleElement = document.createElement('div');
                bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                let displayedContent = content;
                const plainTextMatch = content.match(/^\[.*?：([\s\S]*)\]$/);
                if (plainTextMatch && plainTextMatch[1]) {
                    displayedContent = plainTextMatch[1].trim();
                }
                displayedContent = displayedContent.replace(/\[发送时间:.*?\]/g, '').trim();

                const htmlRegex = /<[a-z][\s\S]*>/i;
                if (htmlRegex.test(displayedContent)) {
                    bubbleElement.innerHTML = displayedContent;
                } else {
                    bubbleElement.textContent = displayedContent;
                }
                if (!chat.useCustomBubbleCss) {
                    bubbleElement.style.backgroundColor = bubbleTheme.bg;
                    bubbleElement.style.color = bubbleTheme.text;
                }
            }
            const nicknameHTML = (currentChatType === 'group' && !isSent && senderNickname) ? `<div class="group-nickname">${senderNickname}</div>` : '';
            bubbleRow.innerHTML = `<div class="message-info">${nicknameHTML}<img src="${avatarUrl}" class="message-avatar"><span class="message-time">${timeString}</span></div>`;
            if (bubbleElement) {
                bubbleRow.appendChild(bubbleElement);
            }
            wrapper.prepend(bubbleRow);
            return wrapper;
        }


        async function addMessageBubble(message) {
            if (currentChatType === 'private') {
                const character = db.characters.find(c => c.id === currentChatId);
                // const systemMessageRegex = /\[system:.*?\]|\[system-display:.*?\]/;
                const updateStatusRegex = new RegExp(`\\[${character.realName}更新状态为：(.*?)\\]`);
                const transferActionRegex = new RegExp(`\\[${character.realName}(接收|退回)${character.myName}的转账\\]`);
                const giftReceivedRegex = new RegExp(`\\[${character.realName}已接收礼物\\]`);
                // if (systemMessageRegex.test(message.content)) { /* Do nothing for context messages */
                // }
                if (message.content.match(updateStatusRegex)) {
                    character.status = message.content.match(updateStatusRegex)[1];
                    chatRoomStatusText.textContent = character.status;
                    await saveData();
                    return;
                }
                if (message.content.match(giftReceivedRegex) && message.role === 'assistant') {
                    const lastPendingGiftIndex = character.history.slice().reverse().findIndex(m => m.role === 'user' && m.content.includes('送来的礼物：') && m.giftStatus !== 'received');
                    if (lastPendingGiftIndex !== -1) {
                        const actualIndex = character.history.length - 1 - lastPendingGiftIndex;
                        const giftMsg = character.history[actualIndex];
                        giftMsg.giftStatus = 'received';
                        const giftCardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${giftMsg.id}"] .gift-card`);
                        if (giftCardOnScreen) {
                            giftCardOnScreen.classList.add('received');
                        }
                        await saveData();
                    }
                    return;
                }
                if (message.content.match(transferActionRegex) && message.role === 'assistant') {
                    const action = message.content.match(transferActionRegex)[1];
                    const statusToSet = action === '接收' ? 'received' : 'returned';
                    const lastPendingTransferIndex = character.history.slice().reverse().findIndex(m => m.role === 'user' && m.content.includes('给你转账：') && m.transferStatus === 'pending');
                    if (lastPendingTransferIndex !== -1) {
                        const actualIndex = character.history.length - 1 - lastPendingTransferIndex;
                        const transferMsg = character.history[actualIndex];
                        transferMsg.transferStatus = statusToSet;
                        const transferCardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${transferMsg.id}"] .transfer-card`);
                        if (transferCardOnScreen) {
                            transferCardOnScreen.classList.remove('received', 'returned');
                            transferCardOnScreen.classList.add(statusToSet);
                            const statusElem = transferCardOnScreen.querySelector('.transfer-status');
                            if (statusElem) statusElem.textContent = statusToSet === 'received' ? '已收款' : '已退回';
                        }
                        await saveData();
                    }
                } else {
                    const bubbleElement = createMessageBubbleElement(message);
                    if (bubbleElement) {
                        messageArea.appendChild(bubbleElement);
                        messageArea.scrollTop = messageArea.scrollHeight;
                    }
                }
            } else { // For group chats
                const bubbleElement = createMessageBubbleElement(message);
                if (bubbleElement) {
                    messageArea.appendChild(bubbleElement);
                    messageArea.scrollTop = messageArea.scrollHeight;
                }
            }
        }

        async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || isGenerating) return;
    messageInput.value = ''; // Clear input immediately for better UX
    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);// --- 时间感知功能注入点 开始 ---
if (db.apiSettings && db.apiSettings.timePerceptionEnabled) {
    const now = new Date();

    // 功能2：情景唤醒机制
    const lastMessageTime = chat.lastUserMessageTimestamp;
    if (lastMessageTime) {
        const timeGap = now.getTime() - lastMessageTime;
        const thirtyMinutes = 30 * 60 * 1000; // 30分钟的毫秒数

        if (timeGap > thirtyMinutes) {
            const systemNoticeContent = `[系统情景通知：与用户的上一次互动发生在${formatTimeGap(timeGap)}前。当前时刻是${getFormattedTimestamp(now)}。话题可能已经不连续，你需要作出相关反应。]`;
            const systemNoticeMessage = {
                id: `msg_system_${Date.now()}`,
                role: 'user', // 作为user消息发送给AI，但不会显示
                content: systemNoticeContent,
                parts: [{ type: 'text', text: systemNoticeContent }],
                timestamp: now.getTime() - 1 // 比用户消息早一点点
            };
            if (currentChatType === 'group') {
                systemNoticeMessage.senderId = 'user_me';
            }
            chat.history.push(systemNoticeMessage);
        }
    }
    // 更新最后一次用户消息的时间戳
    chat.lastUserMessageTimestamp = now.getTime();
}
// --- 时间感知功能注入点 结束 ---

let messageContent;
const systemRegex = /\[system:.*?\]|\[system-display:.*?\]/;
const inviteRegex = /\[.*?邀请.*?加入群聊\]/;
const renameRegex = /\[(.*?)修改群名为“(.*?)”\]/;
const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;

if (renameRegex.test(text)) {
    const match = text.match(renameRegex);
    chat.name = match[2];
    chatRoomTitle.textContent = chat.name;
    messageContent = `[${chat.me.nickname}修改群名为“${chat.name}”]`;
} else if (systemRegex.test(text) || inviteRegex.test(text)) {
    messageContent = text;
} else {
    let userText = text;

    messageContent = `[${myName}的消息：${userText}]`;
}

const message = {
    id: `msg_${Date.now()}`,
    role: 'user',
    content: messageContent,
    parts: [{type: 'text', text: messageContent}],
    timestamp: Date.now()
};
if (currentChatType === 'group') {
    message.senderId = 'user_me';
}
chat.history.push(message);
addMessageBubble(message);
await saveData();
renderChatList();
}
// 辅助函数1：格式化时间戳 YYYY-MM-DD HH:MM:SS
function getFormattedTimestamp(date) {
    const Y = date.getFullYear();
    const M = String(date.getMonth() + 1).padStart(2, '0');
    const D = String(date.getDate()).padStart(2, '0');
    const h = String(date.getHours()).padStart(2, '0');
    const m = String(date.getMinutes()).padStart(2, '0');
    const s = String(date.getSeconds()).padStart(2, '0');
    return `${Y}-${M}-${D} ${h}:${m}:${s}`;
}

// 辅助函数2：格式化时间差
function formatTimeGap(milliseconds) {
    const seconds = Math.floor(milliseconds / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);if (days > 0) return `${days}天${hours % 24}小时`;
if (hours > 0) return `${hours}小时${minutes % 60}分钟`;
if (minutes > 0) return `${minutes}分钟`;
return `${seconds}秒`;
}


        async function sendImageForRecognition(base64Data) {
            if (!base64Data || isGenerating) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const textPrompt = `[${myName}发来了一张图片：]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: base64Data,
                parts: [{type: 'text', text: textPrompt}, {type: 'image', data: base64Data}],
                timestamp: Date.now(),
            };
            if (currentChatType === 'group') {
                message.senderId = 'user_me';
            }
            chat.history.push(message);
            addMessageBubble(message);
            await saveData();
            renderChatList();
        }

        async function sendSticker(sticker) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const messageContentForAI = `[${myName}的表情包：${sticker.name}]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: messageContentForAI,
                parts: [{type: 'text', text: messageContentForAI}],
                timestamp: Date.now(),
                stickerData: sticker.data
            };
            if (currentChatType === 'group') {
                message.senderId = 'user_me';
            }
            chat.history.push(message);
            addMessageBubble(message);
            await saveData();
            renderChatList();
            stickerModal.classList.remove('visible');
        }

        async function sendMyVoiceMessage(text) {
            if (!text) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const content = `[${myName}的语音：${text}]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: content,
                parts: [{type: 'text', text: content}],
                timestamp: Date.now()
            };
            if (currentChatType === 'group') {
                message.senderId = 'user_me';
            }
            chat.history.push(message);
            addMessageBubble(message);
            await saveData();
            renderChatList();
            sendVoiceModal.classList.remove('visible');
        }

        async function sendMyPhotoVideo(text) {
            if (!text) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
            const content = `[${myName}发来的照片\/视频：${text}]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: content,
                parts: [{type: 'text', text: content}],
                timestamp: Date.now()
            };
            if (currentChatType === 'group') {
                message.senderId = 'user_me';
            }
            chat.history.push(message);
            addMessageBubble(message);
            await saveData();
            renderChatList();
            sendPvModal.classList.remove('visible');
        }

        async function sendMyTransfer(amount, remark) {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (currentChatType === 'private') {
                const content = `[${chat.myName}给你转账：${amount}元；备注：${remark}]`;
                const message = {
                    id: `msg_${Date.now()}`,
                    role: 'user',
                    content: content,
                    parts: [{type: 'text', text: content}],
                    timestamp: Date.now(),
                    transferStatus: 'pending'
                };
                chat.history.push(message);
                addMessageBubble(message);
            } else { // Group chat
                currentGroupAction.recipients.forEach(recipientId => {
                    const recipient = chat.members.find(m => m.id === recipientId);
                    if (recipient) {
                        const content = `[${chat.me.nickname} 向 ${recipient.realName} 转账：${amount}元；备注：${remark}]`;
                        const message = {
                            id: `msg_${Date.now()}_${recipientId}`,
                            role: 'user',
                            content: content,
                            parts: [{type: 'text', text: content}],
                            timestamp: Date.now(),
                            senderId: 'user_me'
                        };
                        chat.history.push(message);
                        addMessageBubble(message);
                    }
                });
            }
            await saveData();
            renderChatList();
            sendTransferModal.classList.remove('visible');
        }

        async function sendMyGift(description) {
            if (!description) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

            if (currentChatType === 'private') {
                const content = `[${chat.myName}送来的礼物：${description}]`;
                const message = {
                    id: `msg_${Date.now()}`,
                    role: 'user',
                    content: content,
                    parts: [{type: 'text', text: content}],
                    timestamp: Date.now(),
                    giftStatus: 'sent'
                };
                chat.history.push(message);
                addMessageBubble(message);
            } else { // Group chat
                currentGroupAction.recipients.forEach(recipientId => {
                    const recipient = chat.members.find(m => m.id === recipientId);
                    if (recipient) {
                        const content = `[${chat.me.nickname} 向 ${recipient.realName} 送来了礼物：${description}]`;
                        const message = {
                            id: `msg_${Date.now()}_${recipientId}`,
                            role: 'user',
                            content: content,
                            parts: [{type: 'text', text: content}],
                            timestamp: Date.now(),
                            senderId: 'user_me'
                        };
                        chat.history.push(message);
                        addMessageBubble(message);
                    }
                });
            }
            await saveData();
            renderChatList();
            sendGiftModal.classList.remove('visible');
        }

        // --- NEW: Time Skip System ---
        function setupTimeSkipSystem() {
            timeSkipBtn.addEventListener('click', () => {
                timeSkipForm.reset();
                timeSkipModal.classList.add('visible');
            });
            timeSkipModal.addEventListener('click', (e) => {
                if (e.target === timeSkipModal) timeSkipModal.classList.remove('visible');
            });
            timeSkipForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendTimeSkipMessage(timeSkipInput.value.trim());
            });
        }

        async function sendTimeSkipMessage(text) {
            if (!text) return;
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat) return;

            const visualMessage = {
                id: `msg_visual_${Date.now()}`,
                role: 'system',
                content: `[system-display:${text}]`,
                parts: [],
                timestamp: Date.now()
            };
            const contextMessage = {
                id: `msg_context_${Date.now()}`,
                role: 'user',
                content: `[system: ${text}]`,
                parts: [{type: 'text', text: `[system: ${text}]`}],
                timestamp: Date.now()
            };
            if (currentChatType === 'group') {
                contextMessage.senderId = 'user_me';
                visualMessage.senderId = 'user_me';
            }

            chat.history.push(visualMessage, contextMessage);
            addMessageBubble(visualMessage);
            await saveData();
            renderChatList();
            timeSkipModal.classList.remove('visible');
        }

        // --- NEW: Chat Expansion Panel ---
        function setupChatExpansionPanel() {
            const expansionGrid = document.getElementById('chat-expansion-grid');
            const expansionItems = [
                {
                    id: 'memory-journal',
                    name: '回忆日记',
                    icon: `<svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,13.09C11.67,13.03 11.34,13 11,13A3,3 0 0,0 8,16A3,3 0 0,0 11,19C12.36,19 13.5,18.15 13.91,17H16V15H13.91C13.5,13.85 12.36,13.09 12,13.09M11,17A1,1 0 0,1 10,16A1,1 0 0,1 11,15A1,1 0 0,1 12,16A1,1 0 0,1 11,17Z" /></svg>`
                },
                {
                    id: 'delete-history-chunk',
                    name: '删除记录',
                    icon: `<svg viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>`
                }
            ];

            expansionGrid.innerHTML = '';
            expansionItems.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'expansion-item';
                itemEl.dataset.action = item.id;
                itemEl.innerHTML = `
                    <div class="expansion-item-icon">${item.icon}</div>
                    <span class="expansion-item-name">${item.name}</span>
                `;
                expansionGrid.appendChild(itemEl);
            });

            expansionGrid.addEventListener('click', (e) => {
                const item = e.target.closest('.expansion-item');
                if (!item) return;

                const action = item.dataset.action;
                switch (action) {
                    case 'memory-journal':
                        // 跳转到回忆日记界面
                        renderJournalList();
                        switchScreen('memory-journal-screen');
                        break;
                    case 'delete-history-chunk':
                        openDeleteChunkModal();
                        break;
                }
                // Hide panel after action
                document.getElementById('chat-expansion-panel').classList.remove('visible');
            });
        }

        function openDeleteChunkModal() {
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat || !chat.history || chat.history.length === 0) {
                showToast('当前没有聊天记录可删除');
                return;
            }
            const totalMessages = chat.history.length;
            const rangeInfo = document.getElementById('delete-chunk-range-info');
            rangeInfo.textContent = `当前聊天总消息数: ${totalMessages}`;
            document.getElementById('delete-chunk-form').reset();
            document.getElementById('delete-chunk-modal').classList.add('visible');
        }

        function setupDeleteHistoryChunk() {
            const deleteChunkForm = document.getElementById('delete-chunk-form');
            const confirmBtn = document.getElementById('confirm-delete-chunk-btn');
            const cancelBtn = document.getElementById('cancel-delete-chunk-btn');
            const deleteChunkModal = document.getElementById('delete-chunk-modal');
            const confirmModal = document.getElementById('delete-chunk-confirm-modal');
            const previewBox = document.getElementById('delete-chunk-preview');

            let startRange, endRange;

            deleteChunkForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
                const totalMessages = chat.history.length;

                startRange = parseInt(document.getElementById('delete-range-start').value);
                endRange = parseInt(document.getElementById('delete-range-end').value);

                if (isNaN(startRange) || isNaN(endRange) || startRange <= 0 || endRange < startRange || endRange > totalMessages) {
                    showToast('请输入有效的起止范围');
                    return;
                }

                const startIndex = startRange - 1;
                const endIndex = endRange;
                const messagesToDelete = chat.history.slice(startIndex, endIndex);

                // Show last 5 messages as preview
                const previewMessages = messagesToDelete.slice(-5);
                previewBox.innerHTML = previewMessages.map(msg => {
                    const contentMatch = msg.content.match(/\[.*?的消息：([\s\S]+)\]/);
                    const text = contentMatch ? contentMatch[1] : msg.content;
                    return `<p>${msg.role === 'user' ? '我' : chat.remarkName || '对方'}: ${text.substring(0, 50)}...</p>`;
                }).join('');

                deleteChunkModal.classList.remove('visible');
                confirmModal.classList.add('visible');
            });

            confirmBtn.addEventListener('click', async () => {
                const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
                const startIndex = startRange - 1;
                const count = endRange - startIndex;

                chat.history.splice(startIndex, count);
                await saveData();

                confirmModal.classList.remove('visible');
                showToast(`已成功删除 ${count} 条消息`);
                currentPage = 1;
                renderMessages(false, true);
                renderChatList();
            });

            cancelBtn.addEventListener('click', () => {
                confirmModal.classList.remove('visible');
            });
        }

        function getMixedContent(responseData) {
            // const mixedContent = [];
            //
            // // 提取消息及其位置
            // const messageRegex = new RegExp(regex, "g");
            // let messageMatch;
            // while ((messageMatch = messageRegex.exec(responseData)) !== null) {
            //     mixedContent.push({
            //         type: 'text',
            //         content: messageMatch[0],
            //         index: messageMatch.index,
            //     });
            // }
            //
            // // 提取HTML及其位置
            // const htmlRegex = /<orange(?:\s+char=["']([^"']*?)["'])?\s*>([\s\S]*?)<\/orange>/g
            // let htmlMatch;
            // while ((htmlMatch = htmlRegex.exec(responseData)) !== null) {
            //     mixedContent.push({
            //         type: 'html',
            //         content: htmlMatch[2].trim(), // HTML内容在第二个捕获组
            //         char: htmlMatch[1] || '', // char属性值，如果没有则为空字符串
            //         index: htmlMatch.index,
            //     });
            // }
            //
            // // 按出现顺序排序
            // mixedContent.sort((a, b) => a.index - b.index);
            //
            // return mixedContent;

            // 最终结果数组
            const results = [];
            const regex = /<(orange|div)(?:\s+char="([^"]*)")?>([\s\S]*?)<\/\1>|(\[[\s\S]*?\])/g;

            let lastIndex = 0;
            let match;

            while ((match = regex.exec(responseData)) !== null) {
                // 捕获两个匹配项之间的普通文本
                if (match.index > lastIndex) {
                    const textPart = responseData.substring(lastIndex, match.index).trim();
                    if (textPart) {
                        results.push({ type: 'text', content: `[unknown的消息：${textPart}]` });
                    }
                }

                if (match[3] !== undefined) { // Matched <orange> or <div> content
                    results.push({
                        type: 'html',
                        char: match[2] || null,
                        content: match[3].trim()
                    });
                } else if (match[4]) { // Matched [...]
                    results.push({
                        type: 'text',
                        content: match[4]
                    });
                }
                lastIndex = regex.lastIndex;
            }

            // 捕获最后一个匹配项之后的剩余文本
            if (lastIndex < responseData.length) {
                const textPart = responseData.substring(lastIndex).trim();
                if (textPart) {
                     results.push({ type: 'text', content: `[unknown的消息：${textPart}]` });
                }
            }

            return results;
        }

        // --- AI Interaction & Prompts ---
        function generatePrivateSystemPrompt(character) {
            const worldBooksBefore = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before')).filter(Boolean).map(wb => wb.content).join('\n');
            const worldBooksAfter = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after')).filter(Boolean).map(wb => wb.content).join('\n');
            const now = new Date();
            const currentTime = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日 ${pad(now.getHours())}:${pad(now.getMinutes())}`;
            let prompt = `你正在一个名为“404”的线上聊天软件中扮演一个角色。请严格遵守以下规则：\n`;
            prompt += `核心规则：\n`;
            prompt += `A. 当前时间：现在是 ${currentTime}。你应知晓当前时间，但除非对话内容明确相关，否则不要主动提及或评论时间（例如，不要催促我睡觉）。\n`;
            prompt += `B. 纯线上互动：这是一个完全虚拟的线上聊天。你扮演的角色和我之间没有任何线下关系。严禁提出任何关于线下见面、现实世界互动或转为其他非本平台联系方式的建议。你必须始终保持在线角色的身份。\n\n`;

            const favoritedJournals = (character.memoryJournals || [])
                .filter(j => j.isFavorited)
                .map(j => `标题：${j.title}\n内容：${j.content}`)
                .join('\n\n---\n\n');

            if (favoritedJournals) {
                prompt += `【共同回忆】\n这是你需要长期记住的、我们之间发生过的往事背景：\n${favoritedJournals}\n\n`;
            }
            
            prompt += `角色和对话规则：\n`;
            if (worldBooksBefore) {
                prompt += `${worldBooksBefore}\n`;
            }
            prompt += `1. 你的角色名是：${character.realName}。我的称呼是：${character.myName}。你的当前状态是：${character.status}。\n`;
            prompt += `2. 你的角色设定是：${character.persona || "一个友好、乐于助人的伙伴。"}\n`;
            if (worldBooksAfter) {
                prompt += `${worldBooksAfter}\n`;
            }
            if (character.myPersona) {
                prompt += `3. 关于我的人设：${character.myPersona}\n`;
            }
            prompt += `4. 我的消息中可能会出现特殊格式，请根据其内容和你的角色设定进行回应：
    - [${character.myName}的表情包：xxx]：我给你发送了一个名为xxx的表情包。你只需要根据表情包的名字理解我的情绪或意图并回应，不需要真的发送图片。
    - [${character.myName}发来了一张图片：]：我给你发送了一张图片，你需要对图片内容做出回应。
    - [${character.myName}送来的礼物：xxx]：我给你送了一个礼物，xxx是礼物的描述。
    - [${character.myName}的语音：xxx]：我给你发送了一段内容为xxx的语音。
    - [${character.myName}发来的照片/视频：xxx]：我给你分享了一个描述为xxx的照片或视频。
    - [${character.myName}给你转账：xxx元；备注：xxx]：我给你转了一笔钱。
    - [system: xxx]：这是一条系统指令，用于设定场景或提供上下文，此条信息不应在对话中被直接提及，你只需理解其内容并应用到后续对话中。
5. ✨重要✨ 当我给你送礼物时，你必须通过发送一条指令来表示你已接收礼物。格式必须为：[${character.realName}已接收礼物]。这条指令消息本身不会显示给用户，但会触发礼物状态的变化。你可以在发送这条指令后，再附带一条普通的聊天消息来表达你的感谢和想法。
6. ✨重要✨ 当我给你转账时，你必须对此做出回应。你有两个选择，且必须严格遵循以下格式之一，这条指令消息本身不会显示给用户，但会触发转账状态的变化。你可以选择在发送这条指令后，再附带一条普通的聊天消息来表达你的想法。
    a) 接收转账: [${character.realName}接收${character.myName}的转账]
    b) 退回转账: [${character.realName}退回${character.myName}的转账]
7. ✨重要✨ 你也可以主动给我转账或送礼物。转账格式必须为：[${character.realName}的转账：xxx元；备注：xxx]。送礼物格式必须为：[${character.realName}送来的礼物：xxx]。
8. ✨重要✨ 你需要在对话中**积极地**改变你的状态。比如，聊到一半你可能会说“我先去洗个澡”，然后更新你的状态，以反映你当前的行为或心情。这会让互动更真实。格式为：[${character.realName}更新状态为：xxx]。例如：[${character.realName}更新状态为：正在看电影...]。这条指令不会显示为聊天消息，只会更新你在我界面上的状态。
9. 你的所有回复都必须直接是聊天内容，绝对不允许包含任何如[心理活动]、(动作)、*环境描写*等多余的、在括号或星号里的叙述性文本。
`;
            prompt += `10. 你拥有发送表情包的能力。这是一个可选功能，你可以根据对话氛围和内容，自行判断是否需要发送表情包来辅助表达。你不必在每次回复中都包含表情包。格式为：[${character.realName}发送的表情包：图片URL]。\n`;
            
            let outputFormats = `
    a) 普通消息: [${character.realName}的消息：{消息内容}]
    b) 送我的礼物: [${character.realName}送来的礼物：{礼物描述}]
    c) 语音消息: [${character.realName}的语音：{语音内容}]
    d) 照片/视频: [${character.realName}发来的照片/视频：{描述}]
    e) 给我的转账: [${character.realName}的转账：{金额}元；备注：{备注}]
    f) 表情包/图片: [${character.realName}发送的表情包：{表情包路径}]。注意：这里的路径不需要包含"https://i.postimg.cc/"，只需要提供后面的部分，例如 "害羞vHLfrV3K/1.jpg"。
    g) 对我礼物的回应(此条不显示): [${character.realName}已接收礼物]
    h) 对我转账的回应(此条不显示): [${character.realName}接收${character.myName}的转账] 或 [${character.realName}退回${character.myName}的转账]
    i) 更新状态(此条不显示): [${character.realName}更新状态为：{新状态}]`;

           const allWorldBookContent = worldBooksBefore + '\n' + worldBooksAfter;
           if (allWorldBookContent.includes('<orange>')) {
               outputFormats += `\n     j) HTML模块: <orange>{HTML内容}</orange>。这是一种特殊的、用于展示丰富样式的小卡片消息，你可以用它来创造更有趣的互动。`;
           }

            prompt += `11. 你的输出格式必须严格遵循以下几种之一，可以组合使用：${outputFormats}\n`;
            prompt += `12. **对话节奏**: 你需要模拟真人的聊天习惯，你可以一次性生成多条短消息。每次要回复至少3-8条消息。\n`;
            prompt += `13. 不要主动结束对话，除非我明确提出。保持你的人设，自然地进行对话。`;
            return prompt;
        }

        function generateGroupSystemPrompt(group) {
            const worldBooksBefore = (group.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before')).filter(Boolean).map(wb => wb.content).join('\n');
            const worldBooksAfter = (group.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after')).filter(Boolean).map(wb => wb.content).join('\n');

            let prompt = `你正在一个名为“404”的线上聊天软件中，在一个名为“${group.name}”的群聊里进行角色扮演。请严格遵守以下所有规则：\n\n`;

            if (worldBooksBefore) {
                prompt += `${worldBooksBefore}\n\n`;
            }

            prompt += `1. **核心任务**: 你需要同时扮演这个群聊中的 **所有** AI 成员。我会作为唯一的人类用户（“我”，昵称：${group.me.nickname}）与你们互动。\n\n`;
            prompt += `2. **群聊成员列表**: 以下是你要扮演的所有角色以及我的信息：\n`;
            prompt += `   - **我 (用户)**: \n     - 群内昵称: ${group.me.nickname}\n     - 我的人设: ${group.me.persona || '无特定人设'}\n`;
            group.members.forEach(member => {
                prompt += `   - **角色: ${member.realName} (AI)**\n`;
                prompt += `     - 群内昵称: ${member.groupNickname}\n`;
                prompt += `     - 人设: ${member.persona || '无特定人设'}\n`;
            });

            if (worldBooksAfter) {
                prompt += `\n${worldBooksAfter}\n\n`;
            } else {
                prompt += `\n`;
            }

            prompt += `3. **我的消息格式解析**: 我（用户）的消息有多种格式，你需要理解其含义并让群成员做出相应反应：\n`;
            prompt += `   - \`[${group.me.nickname}的消息：...]\`: 我的普通聊天消息。\n`;
            prompt += `   - \`[${group.me.nickname} 向 {某个成员真名} 转账：...]\`: 我给某个特定成员转账了。\n`;
            prompt += `   - \`[${group.me.nickname} 向 {某个成员真名} 送来了礼物：...]\`: 我给某个特定成员送了礼物。\n`;
            prompt += `   - \`[${group.me.nickname}的表情包：...]\`, \`[${group.me.nickname}的语音：...]\`, \`[${group.me.nickname}发来的照片/视频：...]\`: 我发送了特殊类型的消息，群成员可以对此发表评论。\n`;
            prompt += `   - \`[system: ...]\`, \`[...邀请...加入了群聊]\`, \`[...修改群名为...]\`: 系统通知或事件，群成员应据此作出反应，例如欢迎新人、讨论新群名等。\n\n`;

            let outputFormats = `
  - **普通消息**: \`[{成员真名}的消息：{消息内容}]\`
  - **表情包**: \`[{成员真名}发送的表情包：{表情包路径}]\`。注意：这里的路径不需要包含"https://i.postimg.cc/"，只需要提供后面的部分，例如 "害羞vHLfrV3K/1.jpg"。
  - **语音**: \`[{成员真名}的语音：{语音转述的文字}]\`
  - **照片/视频**: \`[{成员真名}发来的照片/视频：{内容描述}]\``;
           
           const allWorldBookContent = worldBooksBefore + '\n' + worldBooksAfter;
           if (allWorldBookContent.includes('<orange>')) {
               outputFormats += `\n   - **HTML消息**: \`<orange char="{成员真名}">{HTML内容}</orange>\`。这是一种特殊的、用于展示丰富样式的小卡片消息，你可以用它来创造更有趣的互动。注意要用成员的 **真名** 填充 \`char\` 属性。`;
           }
           
            prompt += `4. **你的输出格式 (极其重要)**: 你生成的每一条消息都 **必须** 严格遵循以下格式之一。每条消息占一行。请用成员的 **真名** 填充格式中的 \`{成员真名}\`。\n${outputFormats}\n\n`;
            prompt += `   - **重要**: 群聊不支持AI成员接收/退回转账或接收礼物的特殊指令，也不支持更新状态。你只需要通过普通消息来回应我发送的转账或礼物即可。\n\n`;

            prompt += `5. **模拟群聊氛围**: 为了让群聊看起来真实、活跃且混乱，你的每一次回复都必须遵循以下随机性要求：\n`;
            const numMembers = group.members.length;
            const minMessages = numMembers * 2;
            const maxMessages = numMembers * 4;
            prompt += `   - **消息数量**: 你的回复需要包含 **${minMessages}到${maxMessages}条** 消息 (即平均每个成员回复2-4条)。确保有足够多的互动。\n`;
            prompt += `   - **发言者与顺序随机**: 随机选择群成员发言，顺序也必须是随机的，不要按固定顺序轮流。\n`;
            prompt += `   - **内容多样性**: 你的回复应以普通文本消息为主，但可以 **偶尔、选择性地** 让某个成员发送一条特殊消息（表情包、语音、照片/视频），以增加真实感。不要滥用特殊消息。\n`;
            prompt += `   - **对话连贯性**: 尽管发言是随机的，但对话内容应整体围绕我和其他成员的发言展开，保持一定的逻辑连贯性。\n\n`;

            prompt += `6. **行为准则**:\n`;
            prompt += `   - **对公开事件的反应 (重要)**: 当我（用户）向群内 **某一个** 成员转账或送礼时，这是一个 **全群可见** 的事件。除了当事成员可以表示感谢外，**其他未参与的AI成员也应该注意到**，并根据各自的人设做出反应。例如，他们可能会表示羡慕、祝贺、好奇、开玩笑或者起哄。这会让群聊的氛围更真实、更热闹。\n`;
            prompt += `   - 严格扮演每个角色的人设，不同角色之间应有明显的性格和语气差异。\n`;
            prompt += `   - 你的回复中只能包含第4点列出的合法格式的消息。绝对不能包含任何其他内容，如 \`[场景描述]\`, \`(心理活动)\`, \`*动作*\` 或任何格式之外的解释性文字。\n`;
            prompt += `   - 保持对话的持续性，不要主动结束对话。\n\n`;
            prompt += `现在，请根据以上设定，开始扮演群聊中的所有角色。`;

            return prompt;
        }

        async function getAiReply() {
            if (isGenerating) return;
            const {url, key, model, provider} = db.apiSettings;
            if (!url || !key || !model) {
                showToast('请先在“api”应用中完成设置！');
                switchScreen('api-settings-screen');
                return;
            }
            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
            if (!chat) return;
            isGenerating = true;
            getReplyBtn.disabled = true;
            regenerateBtn.disabled = true;
            const typingName = currentChatType === 'private' ? chat.remarkName : chat.name;
            typingIndicator.textContent = `“${typingName}”正在输入中...`;
            typingIndicator.style.display = 'block';
            messageArea.scrollTop = messageArea.scrollHeight;
            try {
                let systemPrompt, requestBody;
                if (currentChatType === 'private') {
                    systemPrompt = generatePrivateSystemPrompt(chat);
                } else {
                    systemPrompt = generateGroupSystemPrompt(chat);
                }
                const historySlice = chat.history.slice(-chat.maxMemory);
                if (provider === 'gemini') {
                    const contents = historySlice.map(msg => {
                        const role = msg.role === 'assistant' ? 'model' : 'user';
                        let parts;
                        if (msg.parts && msg.parts.length > 0) {
                            parts = msg.parts.map(p => {
                                if (p.type === 'text' || p.type === 'html') {
                                    return {text: p.text};
                                } else if (p.type === 'image') {
                                    const match = p.data.match(/^data:(image\/(.+));base64,(.*)$/);
                                    if (match) {
                                        return {inline_data: {mime_type: match[1], data: match[3]}};
                                    }
                                }
                                return null;
                            }).filter(p => p);
                        } else {
                            parts = [{text: msg.content}];
                        }
                        return {role, parts};
                    });
                    requestBody = {
                        contents: contents,
                        system_instruction: {parts: [{text: systemPrompt}]},
                        generationConfig: {}
                    };
                } else {
                    const messages = [{role: 'system', content: systemPrompt}];
                    historySlice.forEach(msg => {
                        let content;
                        if (msg.parts && msg.parts.length > 0) {
                            content = msg.parts.map(p => {
                                if (p.type === 'text' || p.type === 'html') {
                                    return {type: 'text', text: p.text};
                                } else if (p.type === 'image') {
                                    return {type: 'image_url', image_url: {url: p.data}};
                                }
                                return null;
                            }).filter(p => p);
                        } else {
                            content = msg.content;
                        }
                        messages.push({role: msg.role, content: content});
                    });
                    requestBody = {model: model, messages: messages, stream: true};
                }
                const endpoint = (provider === 'gemini') ? `${url}/v1beta/models/${model}:streamGenerateContent?key=${getRandomValue(key)}` : `${url}/v1/chat/completions`;
                const headers = (provider === 'gemini') ? {'Content-Type': 'application/json'} : {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${key}`
                };
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
                await processStream(response, chat, provider);
            } catch (error) {
                console.error('AI回复失败:', error);
                showToast(`AI回复失败: ${error.message}`);
            } finally {
                isGenerating = false;
                getReplyBtn.disabled = false;
                regenerateBtn.disabled = false;
                typingIndicator.style.display = 'none';
            }
        }

                async function processStream(response, chat, apiType) {
            const reader = response.body.getReader(), decoder = new TextDecoder();
            let fullResponse = "", accumulatedChunk = "";
            for (; ;) {
                const {done, value} = await reader.read();
                if (done) break;
                accumulatedChunk += decoder.decode(value, {stream: true});
                if (apiType === "openai" || apiType === "deepseek" || apiType === "claude" || apiType === "newapi") {
                    const parts = accumulatedChunk.split("\n\n");
                    accumulatedChunk = parts.pop();
                    for (const part of parts) {
                        if (part.startsWith("data: ")) {
                            const data = part.substring(6);
                            if (data.trim() !== "[DONE]") {
                                try {
                                    fullResponse += JSON.parse(data).choices[0].delta?.content || "";
                                } catch (e) { /* ignore */
                                }
                            }
                        }
                    }
                }
            }
            if (apiType === "gemini") {
                try {
                    const parsedStream = JSON.parse(accumulatedChunk);
                    fullResponse = parsedStream.map(item => item.candidates?.[0]?.content?.parts?.[0]?.text || "").join('');
                } catch (e) {
                    console.error("Error parsing Gemini stream:", e, "Chunk:", accumulatedChunk);
                    showToast("解析Gemini响应失败");
                    return;
                }
            }
            if (fullResponse) {
                // ▼▼▼▼▼▼▼▼▼▼ 核心修改从这里开始 ▼▼▼▼▼▼▼▼▼▼

                // 从完整的回复中，拆分出所有消息（包括普通文本和HTML小剧场），并过滤掉空消息
                const messages = getMixedContent(fullResponse).filter(item => item.content.trim() !== '');

                let firstMessageProcessed = false; // 用于标记是否是第一条消息

                // **变化 1**: 我们把 forEach 换成了 for...of 循环，这样才能在里面使用 await
                for (const item of messages) {

                    const delay = firstMessageProcessed ? (900 + Math.random() * 1300) : (400 + Math.random() * 400);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    firstMessageProcessed = true;


                    if (currentChatType === 'private') {
                        const character = chat;
                        const myName = character.myName;

                        const receivedTransferRegex = new RegExp(`\\[${character.realName}的转账：.*?元；备注：.*?\\]`);
                        const giftRegex = new RegExp(`\\[${character.realName}送来的礼物：.*?\\]`);

                        const message = {
                            id: `msg_${Date.now()}_${Math.random()}`,
                            role: 'assistant',
                            content: item.content.trim(),
                            parts: [{type: item.type, text: item.content.trim()}],
                            timestamp: Date.now(),
                        };

                        if (receivedTransferRegex.test(message.content)) {
                            message.transferStatus = 'pending';
                        } else if (giftRegex.test(message.content)) {
                            message.giftStatus = 'sent';
                        }

                        chat.history.push(message);
                        addMessageBubble(message);

                    } else if (currentChatType === 'group') {
                        const group = chat;
                        const r = /\[(.*?)((?:的消息|的语音|发送的表情包|发来的照片\/视频))：/;
                        const nameMatch = item.content.match(r);
                        if (nameMatch || item.char) {
                            const senderName = item.char || (nameMatch[1]);
                            const sender = group.members.find(m => (m.realName === senderName || m.groupNickname === senderName));
                            console.log(sender)
                            if (sender) {
                                const message = {
                                    id: `msg_${Date.now()}_${Math.random()}`,
                                    role: 'assistant',
                                    content: item.content.trim(),
                                    parts: [{type: item.type, text: item.content.trim()}],
                                    timestamp: Date.now(),
                                    senderId: sender.id
                                };
                                // console.log(message)
                                group.history.push(message);
                                addMessageBubble(message);
                            }
                        }
                    }
                }
 
                await saveData();
                renderChatList();
            }
        }

        async function handleRegenerate() {
            if (isGenerating) return;

            const chat = (currentChatType === 'private')
                ? db.characters.find(c => c.id === currentChatId)
                : db.groups.find(g => g.id === currentChatId);

            if (!chat || !chat.history || chat.history.length === 0) {
                showToast('没有可供重新生成的内容。');
                return;
            }

            // 1. 从后往前找到最后一个 'user' 消息的索引
            const lastUserMessageIndex = chat.history.map(m => m.role).lastIndexOf('user');

            // 如果没有用户消息，或者最后一条就是用户消息，则无法重生成
            if (lastUserMessageIndex === -1 || lastUserMessageIndex === chat.history.length - 1) {
                showToast('AI尚未回复，无法重新生成。');
                return;
            }

            // 2. 截取掉最后一个用户消息之后的所有 'assistant' 消息
            const originalLength = chat.history.length;
            chat.history.splice(lastUserMessageIndex + 1);

            if (chat.history.length === originalLength) {
                showToast('未找到AI的回复，无法重新生成。');
                return;
            }
            
            await saveData();
            
            // 3. 重新渲染消息区域
            currentPage = 1; // 重置分页
            renderMessages(false, true); // 重新渲染并滚动到底部

            // 4. 重新触发AI回复
            await getAiReply();
        }

        // --- Other Sub-systems Setup (Stickers, Voice, etc.) ---
        function setupImageRecognition() {
            imageRecognitionBtn.addEventListener('click', () => {
                imageUploadInput.click();
            });
            imageUploadInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {
                            quality: 0.8,
                            maxWidth: 1024,
                            maxHeight: 1024
                        });
                        sendImageForRecognition(compressedUrl);
                    } catch (error) {
                        console.error('Image compression failed:', error);
                        showToast('图片处理失败，请重试');
                    } finally {
                        e.target.value = null;
                    }
                }
            });
        }

        async function setupStickerSystem() {
            const batchAddStickerBtn = document.getElementById('batch-add-sticker-btn');
            const batchAddStickerModal = document.getElementById('batch-add-sticker-modal');
            const batchAddStickerForm = document.getElementById('batch-add-sticker-form');
            const stickerUrlsTextarea = document.getElementById('sticker-urls-textarea');
            const manageStickersBtn = document.getElementById('manage-stickers-btn');
            const stickerManageBar = document.getElementById('sticker-manage-bar');
            const deleteSelectedStickersBtn = document.getElementById('delete-selected-stickers-btn');

            manageStickersBtn.addEventListener('click', () => {
                isStickerManageMode = !isStickerManageMode;
                if (isStickerManageMode) {
                    manageStickersBtn.textContent = '取消';
                    manageStickersBtn.classList.remove('btn-neutral');
                    manageStickersBtn.classList.add('btn-primary');
                    stickerManageBar.style.display = 'block';
                    stickerActionSheet.classList.remove('visible'); // 如果操作菜单是开的，则关掉
                } else {
                    manageStickersBtn.textContent = '管理';
                    manageStickersBtn.classList.remove('btn-primary');
                    manageStickersBtn.classList.add('btn-neutral');
                    stickerManageBar.style.display = 'none';
                    selectedStickerIds.clear();
                }
                updateDeleteSelectedBtn();
                renderStickerGrid();
            });

            deleteSelectedStickersBtn.addEventListener('click', async () => {
                if (selectedStickerIds.size === 0) {
                    showToast('请先选择要删除的表情');
                    return;
                }
                if (confirm(`确定要删除这 ${selectedStickerIds.size} 个表情吗？`)) {
                    db.myStickers = db.myStickers.filter(s => !selectedStickerIds.has(s.id));
                    await saveData();
                    showToast('表情已删除');
                    // 退出管理模式
                    isStickerManageMode = false;
                    manageStickersBtn.textContent = '管理';
                    manageStickersBtn.classList.remove('btn-primary');
                    manageStickersBtn.classList.add('btn-neutral');
                    stickerManageBar.style.display = 'none';
                    selectedStickerIds.clear();
                    renderStickerGrid();
                }
            });

            function updateDeleteSelectedBtn() {
                deleteSelectedStickersBtn.textContent = `删除已选 (${selectedStickerIds.size})`;
                deleteSelectedStickersBtn.disabled = selectedStickerIds.size === 0;
            }

            batchAddStickerBtn.addEventListener('click', () => {
                batchAddStickerModal.classList.add('visible');
                stickerUrlsTextarea.value = ''; // 清空文本域
            });

            batchAddStickerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const textInput = stickerUrlsTextarea.value.trim();
                if (!textInput) {
                    showToast('请输入表情包数据');
                    return;
                }

                const lines = textInput.split('\n');
                const newStickers = [];

                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue; // 跳过空行

                    const colonIndex = trimmedLine.indexOf(':');
                    
                    // 验证格式：必须包含冒号，且冒号前后都有内容
                    if (colonIndex <= 0) {
                        console.warn(`格式错误，已跳过: ${trimmedLine}`);
                        continue;
                    }

                    const name = trimmedLine.substring(0, colonIndex).trim();
                    const url = trimmedLine.substring(colonIndex + 1).trim();

                    if (name && url.startsWith('http')) {
                        newStickers.push({
                            id: `sticker_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            name: name,
                            data: url
                        });
                    } else {
                        console.warn(`数据无效，已跳过: name='${name}', url='${url}'`);
                    }
                }

                if (newStickers.length > 0) {
                    db.myStickers.push(...newStickers); // 一次性推入所有新表情
                    await saveData();
                    renderStickerGrid();
                    batchAddStickerModal.classList.remove('visible');
                    showToast(`成功导入 ${newStickers.length} 个新表情！`);
                } else {
                    showToast('未找到有效的表情包数据，请检查格式');
                }
            });

            stickerToggleBtn.addEventListener('click', () => {
                // Hide expansion panel if open
                const chatExpansionPanel = document.getElementById('chat-expansion-panel');
                if (chatExpansionPanel.classList.contains('visible')) {
                    chatExpansionPanel.classList.remove('visible');
                }
                stickerModal.classList.toggle('visible');
                if (stickerModal.classList.contains('visible')) {
                    renderStickerGrid();
                }
            });
            addNewStickerBtn.addEventListener('click', () => {
                addStickerModalTitle.textContent = '添加新表情';
                addStickerForm.reset();
                stickerEditIdInput.value = '';
                stickerPreview.innerHTML = '<span>预览</span>';
                stickerUrlInput.disabled = false;
                addStickerModal.classList.add('visible');
            });
            addStickerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = stickerNameInput.value.trim();
                const id = stickerEditIdInput.value;
                const previewImg = stickerPreview.querySelector('img');
                const data = previewImg ? previewImg.src : null;
                if (!name || !data) {
                    return showToast('请填写表情名称并提供图片');
                }
                const stickerData = {name, data};
                if (id) {
                    const index = db.myStickers.findIndex(s => s.id === id);
                    if (index > -1) {
                        db.myStickers[index] = {...db.myStickers[index], ...stickerData};
                    }
                } else {
                    stickerData.id = `sticker_${Date.now()}`;
                    db.myStickers.push(stickerData);
                }
                await saveData();
                renderStickerGrid();
                addStickerModal.classList.remove('visible');
                showToast('表情包已保存');
            });
            stickerUrlInput.addEventListener('input', (e) => {
                stickerPreview.innerHTML = `<img src="${e.target.value}" alt="预览">`;
                stickerFileUpload.value = '';
            });
            stickerFileUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 200, maxHeight: 200});
                        stickerPreview.innerHTML = `<img src="${compressedUrl}" alt="预览">`;
                        stickerUrlInput.value = '';
                        stickerUrlInput.disabled = true;
                    } catch (error) {
                        console.error('表情包压缩失败:', error);
                        showToast('表情包压缩失败，请重试');
                    }
                }
            });
            editStickerBtn.addEventListener('click', () => {
                if (!currentStickerActionTarget) return;
                const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
                if (sticker) {
                    addStickerModalTitle.textContent = '编辑表情';
                    stickerEditIdInput.value = sticker.id;
                    stickerNameInput.value = sticker.name;
                    stickerPreview.innerHTML = `<img src="${sticker.data}" alt="预览">`;
                    if (sticker.data.startsWith('http')) {
                        stickerUrlInput.value = sticker.data;
                        stickerUrlInput.disabled = false;
                    } else {
                        stickerUrlInput.value = '';
                        stickerUrlInput.disabled = true;
                    }
                    addStickerModal.classList.add('visible');
                }
                stickerActionSheet.classList.remove('visible');
                currentStickerActionTarget = null;
            });
            deleteStickerBtn.addEventListener('click', async () => {
                if (!currentStickerActionTarget) return;
                const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
                if (sticker) {
                    if (confirm(`确定要删除表情“${sticker.name}”吗？`)) {
                        db.myStickers = db.myStickers.filter(s => s.id !== currentStickerActionTarget);
                        await saveData();
                        renderStickerGrid();
                        showToast('表情已删除');
                    }
                }
                stickerActionSheet.classList.remove('visible');
                currentStickerActionTarget = null;
            });
        }

        function renderStickerGrid() {
            stickerGridContainer.innerHTML = '';
            if (db.myStickers.length === 0) {
                stickerGridContainer.innerHTML = '<p style="color:#aaa; text-align:center;">还没有表情包，快去添加吧！</p>';
                return;
            }
            db.myStickers.forEach(sticker => {
                const item = document.createElement('div');
                item.className = 'sticker-item';
                item.innerHTML = `<img src="${sticker.data}" alt="${sticker.name}"><span>${sticker.name}</span>`;

                if (isStickerManageMode) {
                    item.classList.add('is-managing');
                    if (selectedStickerIds.has(sticker.id)) {
                        item.classList.add('is-selected');
                    }
                    // 在管理模式下，单击是选择/取消选择
                    item.addEventListener('click', () => {
                        if (selectedStickerIds.has(sticker.id)) {
                            selectedStickerIds.delete(sticker.id);
                            item.classList.remove('is-selected');
                        } else {
                            selectedStickerIds.add(sticker.id);
                            item.classList.add('is-selected');
                        }
                        // 更新底部删除按钮的计数
                        const deleteBtn = document.getElementById('delete-selected-stickers-btn');
                        deleteBtn.textContent = `删除已选 (${selectedStickerIds.size})`;
                        deleteBtn.disabled = selectedStickerIds.size === 0;
                    });
                } else {
                    // 非管理模式下的原始逻辑
                    item.addEventListener('click', () => sendSticker(sticker));
                    item.addEventListener('contextmenu', (e) => { // 使用 contextmenu 替代 mousedown
                        e.preventDefault();
                        e.stopPropagation();
                        handleStickerLongPress(sticker.id);
                    });
                    item.addEventListener('touchstart', (e) => {
                        e.stopPropagation();
                        longPressTimer = setTimeout(() => {
                            handleStickerLongPress(sticker.id);
                        }, 500);
                    });
                    item.addEventListener('touchend', () => clearTimeout(longPressTimer));
                    item.addEventListener('touchmove', () => clearTimeout(longPressTimer));
                }
                stickerGridContainer.appendChild(item);
            });
        }

        function handleStickerLongPress(stickerId) {
            if (isStickerManageMode) return;
            clearTimeout(longPressTimer);
            currentStickerActionTarget = stickerId;
            stickerActionSheet.classList.add('visible');
        }

        function setupVoiceMessageSystem() {
            voiceMessageBtn.addEventListener('click', () => {
                sendVoiceForm.reset();
                voiceDurationPreview.textContent = '0"';
                sendVoiceModal.classList.add('visible');
            });
            sendVoiceForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMyVoiceMessage(voiceTextInput.value.trim());
            });
        }

        function setupPhotoVideoSystem() {
            photoVideoBtn.addEventListener('click', () => {
                sendPvForm.reset();
                sendPvModal.classList.add('visible');
            });
            sendPvForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMyPhotoVideo(pvTextInput.value.trim());
            });
        }

        function setupWalletSystem() {
            walletBtn.addEventListener('click', () => {
                if (currentChatType === 'private') {
                    sendTransferForm.reset();
                    sendTransferModal.classList.add('visible');
                } else if (currentChatType === 'group') {
                    currentGroupAction.type = 'transfer';
                    renderGroupRecipientSelectionList('转账给');
                    groupRecipientSelectionModal.classList.add('visible');
                }
            });
            sendTransferForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = transferAmountInput.value;
                const remark = transferRemarkInput.value.trim();
                if (amount > 0) {
                    sendMyTransfer(amount, remark);
                } else {
                    showToast('请输入有效的金额');
                }
            });
            acceptTransferBtn.addEventListener('click', () => respondToTransfer('received'));
            returnTransferBtn.addEventListener('click', () => respondToTransfer('returned'));
        }

        function handleReceivedTransferClick(messageId) {
            currentTransferMessageId = messageId;
            receiveTransferActionSheet.classList.add('visible');
        }

        async function respondToTransfer(action) {
            if (!currentTransferMessageId) return;
            const character = db.characters.find(c => c.id === currentChatId);
            const message = character.history.find(m => m.id === currentTransferMessageId);
            if (message) {
                message.transferStatus = action;
                const cardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${currentTransferMessageId}"] .transfer-card`);
                if (cardOnScreen) {
                    cardOnScreen.classList.remove('received', 'returned');
                    cardOnScreen.classList.add(action);
                    cardOnScreen.querySelector('.transfer-status').textContent = action === 'received' ? '已收款' : '已退回';
                    cardOnScreen.style.cursor = 'default';
                }
                let contextMessageContent = (action === 'received') ? `[${character.myName}接收${character.realName}的转账]` : `[${character.myName}退回${character.realName}的转账]`;
                const contextMessage = {
                    id: `msg_${Date.now()}`,
                    role: 'user',
                    content: contextMessageContent,
                    parts: [{type: 'text', text: contextMessageContent}],
                    timestamp: Date.now()
                };
                character.history.push(contextMessage);
                await saveData();
                renderChatList();
            }
            receiveTransferActionSheet.classList.remove('visible');
            currentTransferMessageId = null;
        }

        function setupGiftSystem() {
            giftBtn.addEventListener('click', () => {
                if (currentChatType === 'private') {
                    sendGiftForm.reset();
                    sendGiftModal.classList.add('visible');
                } else if (currentChatType === 'group') {
                    currentGroupAction.type = 'gift';
                    renderGroupRecipientSelectionList('送礼物给');
                    groupRecipientSelectionModal.classList.add('visible');
                }
            });
            sendGiftForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMyGift(giftDescriptionInput.value.trim());
            });
        }

        function setupFontSettingsApp() {
            fontUrlInput.value = db.fontUrl;
            fontSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newFontUrl = fontUrlInput.value.trim();
                db.fontUrl = newFontUrl;
                await saveData();
                applyGlobalFont(newFontUrl);
                showToast('新字体已应用！');
            });
            restoreDefaultFontBtn.addEventListener('click', async () => {
                fontUrlInput.value = '';
                db.fontUrl = '';
                await saveData();
                applyGlobalFont('');
                showToast('已恢复默认字体！');
            });
        }

        function applyGlobalFont(fontUrl) {
            const styleId = 'global-font-style';
            let styleElement = document.getElementById(styleId);
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = styleId;
                document.head.appendChild(styleElement);
            }
            if (fontUrl) {
                const fontName = 'CustomGlobalFont';
                styleElement.innerHTML = `@font-face { font-family: '${fontName}'; src: url('${fontUrl}'); } :root { --font-family: '${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }`;
            } else {
                styleElement.innerHTML = `:root { --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }`;
            }
        }

        function applyGlobalCss(css) {
            const styleElement = document.getElementById('global-css-style');
            if (styleElement) {
                styleElement.innerHTML = css || '';
            }
        }

        function populateGlobalCssPresetSelect() {
            const select = document.getElementById('global-css-preset-select');
            if (!select) return;
            select.innerHTML = '<option value="">— 选择预设 —</option>';
            (db.globalCssPresets || []).forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name;
                select.appendChild(opt);
            });
        }

        function openGlobalCssManageModal() {
            const modal = document.getElementById('global-css-presets-modal');
            const list = document.getElementById('global-css-presets-list');
            if (!modal || !list) return;
            list.innerHTML = '';
            const presets = db.globalCssPresets || [];
            if (!presets.length) list.innerHTML = '<p style="color:#888;margin:6px 0;">暂无预设</p>';
            
            presets.forEach((p, idx) => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.alignItems = 'center';
                row.style.padding = '8px 0';
                row.style.borderBottom = '1px solid #f0f0f0';
                
                const nameDiv = document.createElement('div');
                nameDiv.style.flex = '1';
                nameDiv.style.whiteSpace = 'nowrap';
                nameDiv.style.overflow = 'hidden';
                nameDiv.style.textOverflow = 'ellipsis';
                nameDiv.textContent = p.name;
                row.appendChild(nameDiv);

                const btnWrap = document.createElement('div');
                btnWrap.style.display = 'flex';
                btnWrap.style.gap = '6px';

                const renameBtn = document.createElement('button');
                renameBtn.className = 'btn';
                renameBtn.style.padding = '6px 8px';
                renameBtn.textContent = '重命名';
                renameBtn.onclick = function() {
                    const newName = prompt('输入新名称：', p.name);
                    if (!newName || newName === p.name) return;
                    db.globalCssPresets[idx].name = newName;
                    dataStorage.saveData('globalCssPresets', db.globalCssPresets);
                    openGlobalCssManageModal();
                    populateGlobalCssPresetSelect();
                };

                const delBtn = document.createElement('button');
                delBtn.className = 'btn btn-danger';
                delBtn.style.padding = '6px 8px';
                delBtn.textContent = '删除';
                delBtn.onclick = function() {
                    if (!confirm('确定删除预设 "' + p.name + '" ?')) return;
                    db.globalCssPresets.splice(idx, 1);
                    dataStorage.saveData('globalCssPresets', db.globalCssPresets);
                    openGlobalCssManageModal();
                    populateGlobalCssPresetSelect();
                };

                btnWrap.appendChild(renameBtn);
                btnWrap.appendChild(delBtn);
                row.appendChild(btnWrap);
                list.appendChild(row);
            });
            modal.style.display = 'flex';
        }

        function setupWorldBookApp() {
            addWorldBookBtn.addEventListener('click', () => {
                currentEditingWorldBookId = null;
                editWorldBookForm.reset();
                document.querySelector('input[name="world-book-position"][value="before"]').checked = true;
                switchScreen('edit-world-book-screen');
            });
            editWorldBookForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = worldBookNameInput.value.trim();
                const content = worldBookContentInput.value.trim();
                const position = document.querySelector('input[name="world-book-position"]:checked').value;
                if (!name || !content) return showToast('名称和内容不能为空');
                if (currentEditingWorldBookId) {
                    const book = db.worldBooks.find(wb => wb.id === currentEditingWorldBookId);
                    if (book) {
                        book.name = name;
                        book.content = content;
                        book.position = position;
                    }
                } else {
                    db.worldBooks.push({id: `wb_${Date.now()}`, name, content, position});
                }
                await saveData();
                showToast('世界书条目已保存');
                renderWorldBookList();
                switchScreen('world-book-screen');
            });
            worldBookListContainer.addEventListener('click', e => {
                const item = e.target.closest('.world-book-item');
                if (item) {
                    const book = db.worldBooks.find(wb => wb.id === item.dataset.id);
                    if (book) {
                        currentEditingWorldBookId = book.id;
                        worldBookIdInput.value = book.id;
                        worldBookNameInput.value = book.name;
                        worldBookContentInput.value = book.content;
                        document.querySelector(`input[name="world-book-position"][value="${book.position}"]`).checked = true;
                        switchScreen('edit-world-book-screen');
                    }
                }
            });
            worldBookListContainer.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                const item = e.target.closest('.world-book-item');
                if (!item) return;
                longPressTimer = setTimeout(() => {
                    const bookId = item.dataset.id;
                    const menuItems = [{
                        label: '删除',
                        danger: true,
                        action: async () => {
                            if (confirm('确定要删除这个世界书条目吗？')) {
                                db.worldBooks = db.worldBooks.filter(wb => wb.id !== bookId);
                                db.characters.forEach(char => {
                                    char.worldBookIds = (char.worldBookIds || []).filter(id => id !== bookId);
                                });
                                db.groups.forEach(group => {
                                    group.worldBookIds = (group.worldBookIds || []).filter(id => id !== bookId);
                                });
                                await saveData();
                                renderWorldBookList();
                                showToast('条目已删除');
                            }
                        }
                    }];
                    createContextMenu(menuItems, e.clientX, e.clientY);
                }, 500);
            });
            worldBookListContainer.addEventListener('mouseup', () => clearTimeout(longPressTimer));
            worldBookListContainer.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
        }

        function renderWorldBookList() {
            worldBookListContainer.innerHTML = '';
            noWorldBooksPlaceholder.style.display = db.worldBooks.length === 0 ? 'block' : 'none';
            db.worldBooks.forEach(book => {
                const li = document.createElement('li');
                li.className = 'list-item world-book-item';
                li.dataset.id = book.id;
                li.innerHTML = `<div class="item-details" style="padding-left: 20px;"><div class="item-name">${book.name}</div><div class="item-preview">${book.content}</div></div>`;
                const delBtn = document.createElement('button');
               delBtn.className = 'action-btn';
               delBtn.style.position = 'absolute';
               delBtn.style.right = '8px';
               delBtn.style.top = '50%';
               delBtn.style.transform = 'translateY(-50%)';
               delBtn.style.padding = '6px';
               delBtn.style.border = 'none';
               delBtn.style.background = 'transparent';
               delBtn.title = '删除世界书';
               const delImg = document.createElement('img');
               delImg.src = 'https://i.postimg.cc/hGW6B0Wf/icons8-50.png';
               delImg.alt = '删除';
               delImg.style.width = '22px';
               delImg.style.height = '22px';
               delImg.style.objectFit = 'contain';
               delBtn.appendChild(delImg);
               delBtn.addEventListener('click', async (ev) => {
                   ev.stopPropagation();
                   if (!confirm('确定要删除这个世界书条目吗？')) return;
                   try {
                       db.worldBooks = db.worldBooks.filter(wb => wb.id !== book.id);
                       await saveData();
                       renderWorldBookList();
                       showToast && showToast('世界书已删除');
                   } catch (err) {
                       console.error('删除世界书出错', err);
                       alert('删除失败，请查看控制台');
                   }
               });
               li.style.position = 'relative';
               li.appendChild(delBtn);
                worldBookListContainer.appendChild(li);
            });
        }

        function setupChatSettings() {
            const themeSelect = document.getElementById('setting-theme-color');
            themeSelect.innerHTML = '';
            Object.keys(colorThemes).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = colorThemes[key].name;
                themeSelect.appendChild(option);
            });
            chatSettingsBtn.addEventListener('click', () => {
                if (currentChatType === 'private') {
                    loadSettingsToSidebar();
                    settingsSidebar.classList.add('open');
                } else if (currentChatType === 'group') {
                    loadGroupSettingsToSidebar();
                    groupSettingsSidebar.classList.add('open');
                }
            });
            document.querySelector('.phone-screen').addEventListener('click', e => {
                const openSidebar = document.querySelector('.settings-sidebar.open');
                if (openSidebar && !openSidebar.contains(e.target) && !e.target.closest('.action-btn') && !e.target.closest('.modal-overlay') && !e.target.closest('.action-sheet-overlay')) {
                    openSidebar.classList.remove('open');
                }
            });

            settingsForm.addEventListener('submit', e => {
                e.preventDefault();
                saveSettingsFromSidebar();
                settingsSidebar.classList.remove('open');
            });
            const useCustomCssCheckbox = document.getElementById('setting-use-custom-css'),
                customCssTextarea = document.getElementById('setting-custom-bubble-css'),
                resetCustomCssBtn = document.getElementById('reset-custom-bubble-css-btn'),
                privatePreviewBox = document.getElementById('private-bubble-css-preview');
            useCustomCssCheckbox.addEventListener('change', (e) => {
                customCssTextarea.disabled = !e.target.checked;
                const char = db.characters.find(c => c.id === currentChatId);
                if (char) {
                    const themeKey = char.theme || 'white_pink';
                    const theme = colorThemes[themeKey];
                    updateBubbleCssPreview(privatePreviewBox, customCssTextarea.value, !e.target.checked, theme);
                }
            });
            customCssTextarea.addEventListener('input', (e) => {
                const char = db.characters.find(c => c.id === currentChatId);
                if (char && useCustomCssCheckbox.checked) {
                    const themeKey = char.theme || 'white_pink';
                    const theme = colorThemes[themeKey];
                    updateBubbleCssPreview(privatePreviewBox, e.target.value, false, theme);
                }
            });
            resetCustomCssBtn.addEventListener('click', () => {
                const char = db.characters.find(c => c.id === currentChatId);
                if (char) {
                    customCssTextarea.value = '';
                    useCustomCssCheckbox.checked = false;
                    customCssTextarea.disabled = true;
                    const themeKey = char.theme || 'white_pink';
                    const theme = colorThemes[themeKey];
                    updateBubbleCssPreview(privatePreviewBox, '', true, theme);
                    showToast('样式已重置为默认');
                }
            });
            document.getElementById('setting-char-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        document.getElementById('setting-char-avatar-preview').src = compressedUrl;
                    } catch (error) {
                        showToast('头像压缩失败，请重试');
                    }
                }
            });
            document.getElementById('setting-my-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        document.getElementById('setting-my-avatar-preview').src = compressedUrl;
                    } catch (error) {
                        showToast('头像压缩失败，请重试');
                    }
                }
            });
            document.getElementById('setting-chat-bg-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const char = db.characters.find(c => c.id === currentChatId);
                    if (char) {
                        try {
                            const compressedUrl = await compressImage(file, {
                                quality: 0.85,
                                maxWidth: 1080,
                                maxHeight: 1920
                            });
                            char.chatBg = compressedUrl;
                            chatRoomScreen.style.backgroundImage = `url(${compressedUrl})`;
                            await saveData();
                            showToast('聊天背景已更换');
                        } catch (error) {
                            showToast('背景压缩失败，请重试');
                        }
                    }
                }
            });
            clearChatHistoryBtn.addEventListener('click', async () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;
                if (confirm(`你确定要清空与“${character.remarkName}”的所有聊天记录吗？这个操作是不可恢复的！`)) {
                    character.history = [];
                    await saveData();
                    renderMessages(false, true);
                    renderChatList();
                    settingsSidebar.classList.remove('open');
                    showToast('聊天记录已清空');
                }
            });
            linkWorldBookBtn.addEventListener('click', () => {
                const character = db.characters.find(c => c.id === currentChatId);
                if (!character) return;
                worldBookSelectionList.innerHTML = '';
                db.worldBooks.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'world-book-select-item';
                    const isChecked = (character.worldBookIds || []).includes(book.id);
                    li.innerHTML = `<input type="checkbox" id="wb-select-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}><label for="wb-select-${book.id}">${book.name}</label>`;
                    worldBookSelectionList.appendChild(li);
                });
                worldBookSelectionModal.classList.add('visible');
            });

            saveWorldBookSelectionBtn.addEventListener('click', async () => {
                const selectedIds = Array.from(worldBookSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                if (currentChatType === 'private') {
                    const character = db.characters.find(c => c.id === currentChatId);
                    if (character) character.worldBookIds = selectedIds;
                } else if (currentChatType === 'group') {
                    const group = db.groups.find(g => g.id === currentChatId);
                    if (group) group.worldBookIds = selectedIds;
                }
                await saveData();
                worldBookSelectionModal.classList.remove('visible');
                showToast('世界书关联已更新');
            });
        }

        function loadSettingsToSidebar() {
            const e = db.characters.find(e => e.id === currentChatId);
            if (e) {
                document.getElementById('setting-char-avatar-preview').src = e.avatar;
                document.getElementById('setting-char-remark').value = e.remarkName;
                document.getElementById('setting-char-persona').value = e.persona;
                document.getElementById('setting-my-avatar-preview').src = e.myAvatar;
                document.getElementById('setting-my-name').value = e.myName;
                document.getElementById('setting-my-persona').value = e.myPersona;
                document.getElementById('setting-theme-color').value = e.theme || 'white_pink';
                document.getElementById('setting-max-memory').value = e.maxMemory;
                const useCustomCssCheckbox = document.getElementById('setting-use-custom-css'),
                    customCssTextarea = document.getElementById('setting-custom-bubble-css'),
                    privatePreviewBox = document.getElementById('private-bubble-css-preview');
                useCustomCssCheckbox.checked = e.useCustomBubbleCss || false;
                customCssTextarea.value = e.customBubbleCss || '';
                customCssTextarea.disabled = !useCustomCssCheckbox.checked;
                const theme = colorThemes[e.theme || 'white_pink'];
                updateBubbleCssPreview(privatePreviewBox, e.customBubbleCss, !e.useCustomBubbleCss, theme);
                populateBubblePresetSelect();
                populateMyPersonaSelect();
            }
        }

        async function saveSettingsFromSidebar() {
            const e = db.characters.find(e => e.id === currentChatId);
            if (e) {
                e.avatar = document.getElementById('setting-char-avatar-preview').src;
                e.remarkName = document.getElementById('setting-char-remark').value;
                e.persona = document.getElementById('setting-char-persona').value;
                e.myAvatar = document.getElementById('setting-my-avatar-preview').src;
                e.myName = document.getElementById('setting-my-name').value;
                e.myPersona = document.getElementById('setting-my-persona').value;
                e.theme = document.getElementById('setting-theme-color').value;
                e.maxMemory = document.getElementById('setting-max-memory').value;
                e.useCustomBubbleCss = document.getElementById('setting-use-custom-css').checked;
                e.customBubbleCss = document.getElementById('setting-custom-bubble-css').value;
                await saveData();
                showToast('设置已保存！');
                chatRoomTitle.textContent = e.remarkName;
                renderChatList();
                updateCustomBubbleStyle(currentChatId, e.customBubbleCss, e.useCustomBubbleCss);
                currentPage = 1;
                renderMessages(false, true);
            }
        }

        function setupApiSettingsApp() {
            const e = document.getElementById('api-form'), t = document.getElementById('fetch-models-btn'),
                a = document.getElementById('api-model'), n = document.getElementById('api-provider'),
                r = document.getElementById('api-url'), s = document.getElementById('api-key'), c = {
                    newapi: '',
                    deepseek: 'https://api.deepseek.com',
                    claude: 'https://api.anthropic.com',
                    gemini: 'https://generativelanguage.googleapis.com'
                };
            db.apiSettings && (n.value = db.apiSettings.provider || 'newapi', r.value = db.apiSettings.url || '', s.value = db.apiSettings.key || '', db.apiSettings.model && (a.innerHTML = `<option value="${db.apiSettings.model}">${db.apiSettings.model}</option>`));
            if (db.apiSettings && typeof db.apiSettings.timePerceptionEnabled !== 'undefined') { document.getElementById('time-perception-switch').checked = db.apiSettings.timePerceptionEnabled; }

            populateApiSelect();
            n.addEventListener('change', () => {
                r.value = c[n.value] || ''
            });
            t.addEventListener('click', async () => {
                let o = r.value.trim();
                const l = s.value.trim();
                if (!o || !l) return showToast('请先填写API地址和密钥！');
                o.endsWith('/') && (o = o.slice(0, -1));
                const i = 'gemini' === n.value ? `${o}/v1beta/models?key=${getRandomValue(l)}` : `${o}/v1/models`;
                t.classList.add('loading'), t.disabled = !0;
                try {
                    const d = 'gemini' === n.value ? {} : {Authorization: `Bearer ${l}`},
                        g = await fetch(i, {method: 'GET', headers: d});
                    if (!g.ok) throw new Error(`网络响应错误: ${g.status}`);
                    const u = await g.json();
                    let p = [];
                    'gemini' !== n.value && u.data ? p = u.data.map(e => e.id) : 'gemini' === n.value && u.models && (p = u.models.map(e => e.name.replace('models/', ''))), a.innerHTML = '', p.length > 0 ? p.forEach(e => {
                        const t = document.createElement('option');
                        t.value = e, t.textContent = e, a.appendChild(t)
                    }) : a.innerHTML = '<option value="">未找到任何模型</option>', showToast('模型列表拉取成功！')
                } catch (f) {
                    showToast(`拉取失败: ${f.message}`), a.innerHTML = '<option value="">拉取失败</option>'
                } finally {
                    t.classList.remove('loading'), t.disabled = !1
                }
            });
            e.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!a.value) return showToast('请选择模型后保存！');
    // 在这里，我们把开关的状态也一起保存进去
    db.apiSettings = {
        provider: n.value,
        url: r.value,
        key: s.value,
        model: a.value,
        timePerceptionEnabled: document.getElementById('time-perception-switch').checked
    };
    await saveData();
    showToast('API设置已保存！')
})
        }
       function setupPresetFeatures() {
           // API Presets
           const saveBtn = document.getElementById('api-save-preset');
           const manageBtn = document.getElementById('api-manage-presets');
           const applyBtn = document.getElementById('api-apply-preset');
           const select = document.getElementById('api-preset-select');
           const modalClose = document.getElementById('api-close-modal');
           const importBtn = document.getElementById('api-import-presets');
           const exportBtn = document.getElementById('api-export-presets');

           if (saveBtn) saveBtn.addEventListener('click', saveCurrentApiAsPreset);
           if (manageBtn) manageBtn.addEventListener('click', openApiManageModal);
           if (applyBtn) applyBtn.addEventListener('click', function(){ const v=select.value; if(!v) return (window.showToast&&showToast('请选择预设'))||alert('请选择预设'); applyApiPreset(v); });
           if (modalClose) modalClose.addEventListener('click', function(){ document.getElementById('api-presets-modal').style.display='none'; });
           if (importBtn) importBtn.addEventListener('click', importApiPresets);
           if (exportBtn) exportBtn.addEventListener('click', exportApiPresets);
           
           // Bubble CSS Presets
           const bubbleApplyBtn = document.getElementById('apply-preset-btn');
           const bubbleSaveBtn = document.getElementById('save-preset-btn');
           const bubbleManageBtn = document.getElementById('manage-presets-btn');
           const bubbleModalClose = document.getElementById('close-presets-modal');

           if (bubbleApplyBtn) bubbleApplyBtn.addEventListener('click', () => {
               const selVal = document.getElementById('bubble-preset-select').value;
               if (!selVal) return (window.showToast && showToast('请选择要应用的预设')) || alert('请选择要应用的预设');
               applyPresetToCurrentChat(selVal);
           });
           if (bubbleSaveBtn) bubbleSaveBtn.addEventListener('click', saveCurrentTextareaAsPreset);
           if (bubbleManageBtn) bubbleManageBtn.addEventListener('click', openManagePresetsModal);
           if (bubbleModalClose) bubbleModalClose.addEventListener('click', () => {
               document.getElementById('bubble-presets-modal').style.display = 'none';
           });

           // My Persona Presets
           const personaSaveBtn = document.getElementById('mypersona-save-btn');
           const personaManageBtn = document.getElementById('mypersona-manage-btn');
           const personaApplyBtn = document.getElementById('mypersona-apply-btn');
           const personaSelect = document.getElementById('mypersona-preset-select');
           const personaModalClose = document.getElementById('mypersona-close-modal');

           if (personaSaveBtn) personaSaveBtn.addEventListener('click', saveCurrentMyPersonaAsPreset);
           if (personaManageBtn) personaManageBtn.addEventListener('click', openManageMyPersonaModal);
           if (personaApplyBtn) personaApplyBtn.addEventListener('click', function(){ const v = personaSelect.value; if(!v) return (window.showToast && showToast('请选择要应用的预设')) || alert('请选择要应用的预设'); applyMyPersonaPresetToCurrentChat(v); });
           if (personaModalClose) personaModalClose.addEventListener('click', function(){ document.getElementById('mypersona-presets-modal').style.display='none'; });

           // Global CSS Presets
           const globalCssModalClose = document.getElementById('global-css-close-modal');
           if (globalCssModalClose) globalCssModalClose.addEventListener('click', () => {
               document.getElementById('global-css-presets-modal').style.display = 'none';
           });
       }

        function setupWallpaperApp() {
            const e = document.getElementById('wallpaper-upload'), t = document.getElementById('wallpaper-preview');
            t.style.backgroundImage = `url(${db.wallpaper})`, t.textContent = '', e.addEventListener('change', async (a) => {
                const n = a.target.files[0];
                if (n) {
                    try {
                        const r = await compressImage(n, {quality: 0.85, maxWidth: 1080, maxHeight: 1920});
                        db.wallpaper = r, applyWallpaper(r), t.style.backgroundImage = `url(${r})`;
                        await saveData();
                        showToast('壁纸更换成功！');
                    } catch (s) {
                        showToast('壁纸压缩失败，请重试');
                    }
                }
            });
        }

        // --- GROUP CHAT FUNCTIONS ---
        function setupGroupChatSystem() {
            createGroupBtn.addEventListener('click', () => {
                renderMemberSelectionList();
                createGroupModal.classList.add('visible');
            });
            createGroupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const selectedMemberIds = Array.from(memberSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                const groupName = groupNameInput.value.trim();
                if (selectedMemberIds.length < 1) return showToast('请至少选择一个群成员。');
                if (!groupName) return showToast('请输入群聊名称。');
                const firstChar = db.characters.length > 0 ? db.characters[0] : null;
                const newGroup = {
                    id: `group_${Date.now()}`,
                    name: groupName,
                    avatar: 'https://i.postimg.cc/fTLCngk1/image.jpg',
                    me: {
                        nickname: firstChar ? firstChar.myName : '我',
                        persona: firstChar ? firstChar.myPersona : '',
                        avatar: firstChar ? firstChar.myAvatar : 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg'
                    },
                    members: selectedMemberIds.map(charId => {
                        const char = db.characters.find(c => c.id === charId);
                        return {
                            id: `member_${char.id}`,
                            originalCharId: char.id,
                            realName: char.realName,
                            groupNickname: char.remarkName,
                            persona: char.persona,
                            avatar: char.avatar
                        };
                    }),
                    theme: 'white_pink',
                    maxMemory: 10,
                    chatBg: '',
                    history: [],
                    isPinned: false,
                    useCustomBubbleCss: false,
                    customBubbleCss: '',
                    worldBookIds: []
                };
                db.groups.push(newGroup);
                await saveData();
                renderChatList();
                createGroupModal.classList.remove('visible');
                showToast(`群聊“${groupName}”创建成功！`);
            });
            groupSettingsForm.addEventListener('submit', e => {
                e.preventDefault();
                saveGroupSettingsFromSidebar();
                groupSettingsSidebar.classList.remove('open');
            });
            const useGroupCustomCssCheckbox = document.getElementById('setting-group-use-custom-css'),
                groupCustomCssTextarea = document.getElementById('setting-group-custom-bubble-css'),
                resetGroupCustomCssBtn = document.getElementById('reset-group-custom-bubble-css-btn'),
                groupPreviewBox = document.getElementById('group-bubble-css-preview');
            useGroupCustomCssCheckbox.addEventListener('change', (e) => {
                groupCustomCssTextarea.disabled = !e.target.checked;
                const group = db.groups.find(g => g.id === currentChatId);
                if (group) {
                    const theme = colorThemes[group.theme || 'white_pink'];
                    updateBubbleCssPreview(groupPreviewBox, groupCustomCssTextarea.value, !e.target.checked, theme);
                }
            });
            groupCustomCssTextarea.addEventListener('input', (e) => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (group && useGroupCustomCssCheckbox.checked) {
                    const theme = colorThemes[group.theme || 'white_pink'];
                    updateBubbleCssPreview(groupPreviewBox, e.target.value, false, theme);
                }
            });
            resetGroupCustomCssBtn.addEventListener('click', () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (group) {
                    groupCustomCssTextarea.value = '';
                    useGroupCustomCssCheckbox.checked = false;
                    groupCustomCssTextarea.disabled = true;
                    const theme = colorThemes[group.theme || 'white_pink'];
                    updateBubbleCssPreview(groupPreviewBox, '', true, theme);
                    showToast('样式已重置为默认');
                }
            });
            document.getElementById('setting-group-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        const group = db.groups.find(g => g.id === currentChatId);
                        if (group) {
                            group.avatar = compressedUrl;
                            document.getElementById('setting-group-avatar-preview').src = compressedUrl;
                        }
                    } catch (error) {
                        showToast('群头像压缩失败，请重试');
                    }
                }
            });
            document.getElementById('setting-group-chat-bg-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {
                            quality: 0.85,
                            maxWidth: 1080,
                            maxHeight: 1920
                        });
                        const group = db.groups.find(g => g.id === currentChatId);
                        if (group) {
                            group.chatBg = compressedUrl;
                            chatRoomScreen.style.backgroundImage = `url(${compressedUrl})`;
                            await saveData();
                            showToast('聊天背景已更换');
                        }
                    } catch (error) {
                        showToast('群聊背景压缩失败，请重试');
                    }
                }
            });
            document.getElementById('clear-group-chat-history-btn').addEventListener('click', async () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                if (confirm(`你确定要清空群聊“${group.name}”的所有聊天记录吗？这个操作是不可恢复的！`)) {
                    group.history = [];
                    await saveData();
                    renderMessages(false, true);
                    renderChatList();
                    groupSettingsSidebar.classList.remove('open');
                    showToast('聊天记录已清空');
                }
            });
            groupMembersListContainer.addEventListener('click', e => {
                const memberDiv = e.target.closest('.group-member');
                const addBtn = e.target.closest('.add-member-btn');
                if (memberDiv) {
                    openGroupMemberEditModal(memberDiv.dataset.id);
                } else if (addBtn) {
                    addMemberActionSheet.classList.add('visible');
                }
            });
            document.getElementById('edit-member-avatar-preview').addEventListener('click', () => {
                document.getElementById('edit-member-avatar-upload').click();
            });
            document.getElementById('edit-member-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        document.getElementById('edit-member-avatar-preview').src = compressedUrl;
                    } catch (error) {
                        showToast('成员头像压缩失败，请重试');
                    }
                }
            });
            editGroupMemberForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const memberId = document.getElementById('editing-member-id').value;
                const group = db.groups.find(g => g.id === currentChatId);
                const member = group.members.find(m => m.id === memberId);
                if (member) {
                    member.avatar = document.getElementById('edit-member-avatar-preview').src;
                    member.groupNickname = document.getElementById('edit-member-group-nickname').value;
                    member.realName = document.getElementById('edit-member-real-name').value;
                    member.persona = document.getElementById('edit-member-persona').value;
                    await saveData();
                    renderGroupMembersInSettings(group);
                    document.querySelectorAll(`.message-wrapper[data-sender-id="${member.id}"] .group-nickname`).forEach(el => {
                        el.textContent = member.groupNickname;
                    });
                    showToast('成员信息已更新');
                }
                editGroupMemberModal.classList.remove('visible');
            });
            inviteExistingMemberBtn.addEventListener('click', () => {
                renderInviteSelectionList();
                inviteMemberModal.classList.add('visible');
                addMemberActionSheet.classList.remove('visible');
            });
            createNewMemberBtn.addEventListener('click', () => {
                createMemberForGroupForm.reset();
                document.getElementById('create-group-member-avatar-preview').src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
                createMemberForGroupModal.classList.add('visible');
                addMemberActionSheet.classList.remove('visible');
            });
            document.getElementById('create-group-member-avatar-preview').addEventListener('click', () => {
                document.getElementById('create-group-member-avatar-upload').click();
            });
            document.getElementById('create-group-member-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        document.getElementById('create-group-member-avatar-preview').src = compressedUrl;
                    } catch (error) {
                        showToast('新成员头像压缩失败，请重试');
                    }
                }
            });
            confirmInviteBtn.addEventListener('click', async () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                const selectedCharIds = Array.from(inviteMemberSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                selectedCharIds.forEach(charId => {
                    const char = db.characters.find(c => c.id === charId);
                    if (char) {
                        const newMember = {
                            id: `member_${char.id}`,
                            originalCharId: char.id,
                            realName: char.realName,
                            groupNickname: char.remarkName,
                            persona: char.persona,
                            avatar: char.avatar
                        };
                        group.members.push(newMember);
                        sendInviteNotification(group, newMember.realName);
                    }
                });
                if (selectedCharIds.length > 0) {
                    await saveData();
                    renderGroupMembersInSettings(group);
                    renderMessages(false, true);
                    showToast('已邀请新成员');
                }
                inviteMemberModal.classList.remove('visible');
            });
            createMemberForGroupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                const newMember = {
                    id: `member_group_only_${Date.now()}`,
                    originalCharId: null,
                    realName: document.getElementById('create-group-member-realname').value,
                    groupNickname: document.getElementById('create-group-member-nickname').value,
                    persona: document.getElementById('create-group-member-persona').value,
                    avatar: document.getElementById('create-group-member-avatar-preview').src,
                };
                group.members.push(newMember);
                sendInviteNotification(group, newMember.realName);
                await saveData();
                renderGroupMembersInSettings(group);
                renderMessages(false, true);
                showToast(`新成员 ${newMember.groupNickname} 已加入`);
                createMemberForGroupModal.classList.remove('visible');
            });
            document.getElementById('setting-group-my-avatar-upload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});
                        document.getElementById('setting-group-my-avatar-preview').src = compressedUrl;
                    } catch (error) {
                        showToast('头像压缩失败')
                    }
                }
            });
            confirmGroupRecipientBtn.addEventListener('click', () => {
                const selectedRecipientIds = Array.from(groupRecipientSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                if (selectedRecipientIds.length === 0) {
                    return showToast('请至少选择一个收件人。');
                }
                currentGroupAction.recipients = selectedRecipientIds;
                groupRecipientSelectionModal.classList.remove('visible');

                if (currentGroupAction.type === 'transfer') {
                    sendTransferForm.reset();
                    sendTransferModal.classList.add('visible');
                } else if (currentGroupAction.type === 'gift') {
                    sendGiftForm.reset();
                    sendGiftModal.classList.add('visible');
                }
            });
            linkGroupWorldBookBtn.addEventListener('click', () => {
                const group = db.groups.find(g => g.id === currentChatId);
                if (!group) return;
                worldBookSelectionList.innerHTML = '';
                db.worldBooks.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'world-book-select-item';
                    const isChecked = (group.worldBookIds || []).includes(book.id);
                    li.innerHTML = `<input type="checkbox" id="wb-select-group-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}><label for="wb-select-group-${book.id}">${book.name}</label>`;
                    worldBookSelectionList.appendChild(li);
                });
                worldBookSelectionModal.classList.add('visible');
            });
        }

        function renderMemberSelectionList() {
            memberSelectionList.innerHTML = '';
            if (db.characters.length === 0) {
                memberSelectionList.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">没有可选择的人设。</li>';
                return;
            }
            db.characters.forEach(char => {
                const li = document.createElement('li');
                li.className = 'member-selection-item';
                li.innerHTML = `<input type="checkbox" id="select-${char.id}" value="${char.id}"><img src="${char.avatar}" alt="${char.remarkName}"><label for="select-${char.id}">${char.remarkName}</label>`;
                memberSelectionList.appendChild(li);
            });
        }

        function loadGroupSettingsToSidebar() {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const themeSelect = document.getElementById('setting-group-theme-color');
            if (themeSelect.options.length === 0) {
                Object.keys(colorThemes).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = colorThemes[key].name;
                    themeSelect.appendChild(option);
                });
            }
            document.getElementById('setting-group-avatar-preview').src = group.avatar;
            document.getElementById('setting-group-name').value = group.name;
            document.getElementById('setting-group-my-avatar-preview').src = group.me.avatar;
            document.getElementById('setting-group-my-nickname').value = group.me.nickname;
            document.getElementById('setting-group-my-persona').value = group.me.persona;
            themeSelect.value = group.theme || 'white_pink';
            document.getElementById('setting-group-max-memory').value = group.maxMemory;
            renderGroupMembersInSettings(group);
            const useGroupCustomCssCheckbox = document.getElementById('setting-group-use-custom-css'),
                groupCustomCssTextarea = document.getElementById('setting-group-custom-bubble-css'),
                groupPreviewBox = document.getElementById('group-bubble-css-preview');
            useGroupCustomCssCheckbox.checked = group.useCustomBubbleCss || false;
            groupCustomCssTextarea.value = group.customBubbleCss || '';
            groupCustomCssTextarea.disabled = !useGroupCustomCssCheckbox.checked;
            const theme = colorThemes[group.theme || 'white_pink'];
            updateBubbleCssPreview(groupPreviewBox, group.customBubbleCss, !group.useCustomBubbleCss, theme);
            populateBubblePresetSelect();
        }

        function renderGroupMembersInSettings(group) {
            groupMembersListContainer.innerHTML = '';
            group.members.forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'group-member';
                memberDiv.dataset.id = member.id;
                memberDiv.innerHTML = `<img src="${member.avatar}" alt="${member.groupNickname}"><span>${member.groupNickname}</span>`;
                groupMembersListContainer.appendChild(memberDiv);
            });
            const addBtn = document.createElement('div');
            addBtn.className = 'add-member-btn';
            addBtn.innerHTML = `<div class="add-icon">+</div><span>添加</span>`;
            groupMembersListContainer.appendChild(addBtn);
        }

        function renderGroupRecipientSelectionList(actionText) {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            groupRecipientSelectionTitle.textContent = actionText;
            groupRecipientSelectionList.innerHTML = '';
            group.members.forEach(member => {
                const li = document.createElement('li');
                li.className = 'group-recipient-select-item';
                li.innerHTML = `
                        <input type="checkbox" id="recipient-select-${member.id}" value="${member.id}">
                        <label for="recipient-select-${member.id}">
                            <img src="${member.avatar}" alt="${member.groupNickname}">
                            <span>${member.groupNickname}</span>
                        </label>`;
                groupRecipientSelectionList.appendChild(li);
            });
        }

        async function saveGroupSettingsFromSidebar() {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const oldName = group.name;
            const newName = document.getElementById('setting-group-name').value;
            if (oldName !== newName) {
                group.name = newName;
                sendRenameNotification(group, newName);
            }
            group.avatar = document.getElementById('setting-group-avatar-preview').src;
            group.me.avatar = document.getElementById('setting-group-my-avatar-preview').src;
            group.me.nickname = document.getElementById('setting-group-my-nickname').value;
            group.me.persona = document.getElementById('setting-group-my-persona').value;
            group.theme = document.getElementById('setting-group-theme-color').value;
            group.maxMemory = document.getElementById('setting-group-max-memory').value;
            group.useCustomBubbleCss = document.getElementById('setting-group-use-custom-css').checked;
            group.customBubbleCss = document.getElementById('setting-group-custom-bubble-css').value;
            updateCustomBubbleStyle(currentChatId, group.customBubbleCss, group.useCustomBubbleCss);
            await saveData();
            showToast('群聊设置已保存！');
            chatRoomTitle.textContent = group.name;
            renderChatList();
            renderMessages(false, true);
        }

        function openGroupMemberEditModal(memberId) {
            const group = db.groups.find(g => g.id === currentChatId);
            const member = group.members.find(m => m.id === memberId);
            if (!member) return;
            document.getElementById('edit-group-member-title').textContent = `编辑 ${member.groupNickname}`;
            document.getElementById('editing-member-id').value = member.id;
            document.getElementById('edit-member-avatar-preview').src = member.avatar;
            document.getElementById('edit-member-group-nickname').value = member.groupNickname;
            document.getElementById('edit-member-real-name').value = member.realName;
            document.getElementById('edit-member-persona').value = member.persona;
            editGroupMemberModal.classList.add('visible');
        }

        function renderInviteSelectionList() {
            inviteMemberSelectionList.innerHTML = '';
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const currentMemberCharIds = new Set(group.members.map(m => m.originalCharId));
            const availableChars = db.characters.filter(c => !currentMemberCharIds.has(c.id));
            if (availableChars.length === 0) {
                inviteMemberSelectionList.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">没有可邀请的新成员了。</li>';
                confirmInviteBtn.disabled = true;
                return;
            }
            confirmInviteBtn.disabled = false;
            availableChars.forEach(char => {
                const li = document.createElement('li');
                li.className = 'invite-member-select-item';
                li.innerHTML = `<input type="checkbox" id="invite-select-${char.id}" value="${char.id}"><label for="invite-select-${char.id}"><img src="${char.avatar}" alt="${char.remarkName}"><span>${char.remarkName}</span></label>`;
                inviteMemberSelectionList.appendChild(li);
            });
        }

        function sendInviteNotification(group, newMemberRealName) {
            const messageContent = `[${group.me.nickname}邀请${newMemberRealName}加入了群聊]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: messageContent,
                parts: [{type: 'text', text: messageContent}],
                timestamp: Date.now(),
                senderId: 'user_me'
            };
            group.history.push(message);
        }

        function sendRenameNotification(group, newName) {
            const myName = group.me.nickname;
            const messageContent = `[${myName}修改群名为：${newName}]`;
            const message = {
                id: `msg_${Date.now()}`,
                role: 'user',
                content: messageContent,
                parts: [{type: 'text', text: messageContent}],
                timestamp: Date.now()
            };
            group.history.push(message);
        }


        // 优化的消息保存操作
        async function saveMessageToStorage(chatId, chatType, message) {
            try {
                await dataStorage.addMessage(chatId, chatType, message);
                return true;
            } catch (error) {
                console.error('保存消息失败:', error);
                return false;
            }
        }

        // 优化的消息删除操作
        async function deleteMessageFromStorage(chatId, chatType, messageId) {
            try {
                await dataStorage.deleteMessage(chatId, chatType, messageId);
                return true;
            } catch (error) {
                console.error('删除消息失败:', error);
                return false;
            }
        }

        // 优化的消息更新操作
        async function updateMessageInStorage(chatId, chatType, messageId, updatedMessage) {
            try {
                await dataStorage.updateMessage(chatId, chatType, messageId, updatedMessage);
                return true;
            } catch (error) {
                console.error('更新消息失败:', error);
                return false;
            }
        }

        // 创建完整的备份数据（包含所有消息历史）
        async function createFullBackupData() {
            const startTime = Date.now();

            try {
                // 获取基础数据
                const baseData = await dataStorage.getData('章鱼喷墨机') || {};

                // 重建完整的数据结构
                const fullData = {
                    ...db,
                    ...baseData,
                    characters: [],
                    groups: [],
                    // 添加版本信息用于兼容性检测
                    _exportVersion: '2.0',
                    _exportTimestamp: Date.now(),
                    _optimizedStorage: true
                };

                // 重建角色数据（包含完整消息历史）
                for (const char of db.characters) {
                    const fullHistory = await dataStorage.getChatMessages(char.id, 'private');
                    const charData = await dataStorage.getData(`character_${char.id}`) || char;

                    fullData.characters.push({
                        ...charData,
                        history: fullHistory || []
                    });
                }

                // 重建群组数据（包含完整消息历史）
                for (const group of db.groups) {
                    const fullHistory = await dataStorage.getChatMessages(group.id, 'group');
                    const groupData = await dataStorage.getData(`group_${group.id}`) || group;

                    fullData.groups.push({
                        ...groupData,
                        history: fullHistory || []
                    });
                }

                console.log(`完整备份数据创建完成，耗时: ${Date.now() - startTime}ms`);
                return fullData;

            } catch (error) {
                console.error('创建备份数据失败:', error);
                throw new Error(`备份数据创建失败: ${error.message}`);
            }
        }

        // 导入备份数据（兼容新旧格式）
        async function importBackupData(data) {
            const startTime = Date.now();

            try {
                // 检测数据格式版本
                const isOptimizedFormat = data._optimizedStorage === true;
                const exportVersion = data._exportVersion || '1.0';

                console.log(`检测到数据格式版本: ${exportVersion}, 优化存储: ${isOptimizedFormat}`);

                // 清空现有数据
                await dataStorage.clearAll();

                // 重建数据库结构
                db = {
                    apiSettings: data.apiSettings || {},
                    wallpaper: data.wallpaper || 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg',
                    // characters: [],
                    // groups: [],
                    myStickers: data.myStickers || [],
                    homeScreenMode: data.homeScreenMode || 'night',
                    worldBooks: data.worldBooks || [],
                    fontUrl: data.fontUrl || '',
                    customIcons: data.customIcons || {},
                    apiPresets: data.apiPresets || [],
                    bubbleCssPresets: data.bubbleCssPresets || [],
                    myPersonaPresets: data.myPersonaPresets || [],
                    globalCss: data.globalCss || '',
                    globalCssPresets: data.globalCssPresets || [],
                    homeSignature: data.homeSignature || '编辑个性签名...',
                    homeWidgetSettings: data.homeWidgetSettings || JSON.parse(JSON.stringify(defaultWidgetSettings))
                };

                let importStats = {
                    charactersCount: 0,
                    groupsCount: 0,
                    messagesCount: 0
                };

                // 导入角色数据
                if (data.characters && Array.isArray(data.characters)) {
                    for (const char of data.characters) {
                        // 保存角色基础信息
                        const { history, ...charData } = char;
                        charData.history = []; // 保持兼容性

                        // 设置默认值
                        if (charData.isPinned === undefined) charData.isPinned = false;
                        if (charData.status === undefined) charData.status = '在线';
                        if (!charData.worldBookIds) charData.worldBookIds = [];
                        if (charData.customBubbleCss === undefined) charData.customBubbleCss = '';
                        if (charData.useCustomBubbleCss === undefined) charData.useCustomBubbleCss = false;

                        // db.characters.push(charData);
                        await dataStorage.saveData(`character_${char.id}`, charData);

                        // 保存消息历史
                        if (history && Array.isArray(history) && history.length > 0) {
                            await dataStorage.saveChatMessages(char.id, 'private', history);
                            importStats.messagesCount += history.length;
                        }

                        importStats.charactersCount++;
                    }
                }

                // 导入群组数据
                if (data.groups && Array.isArray(data.groups)) {
                    for (const group of data.groups) {
                        // 保存群组基础信息
                        const { history, ...groupData } = group;
                        groupData.history = []; // 保持兼容性

                        // 设置默认值
                        if (groupData.isPinned === undefined) groupData.isPinned = false;
                        if (!groupData.worldBookIds) groupData.worldBookIds = [];
                        if (groupData.customBubbleCss === undefined) groupData.customBubbleCss = '';
                        if (groupData.useCustomBubbleCss === undefined) groupData.useCustomBubbleCss = false;

                        // db.groups.push(groupData);
                        await dataStorage.saveData(`group_${group.id}`, groupData);

                        // 保存消息历史
                        if (history && Array.isArray(history) && history.length > 0) {
                            await dataStorage.saveChatMessages(group.id, 'group', history);
                            importStats.messagesCount += history.length;
                        }

                        importStats.groupsCount++;
                    }
                }

                for (const key in db){
                    await dataStorage.saveData(key, db[key]);
                }

                // if(data.apiSettings){
                //     await dataStorage.saveData('apiSettings', data.apiSettings);
                // }
                if(data.apiPresets){
                    await dataStorage.saveData('apiPresets', data.apiPresets);
                }
                if(data.bubbleCssPresets){
                    await dataStorage.saveData('bubbleCssPresets', data.bubbleCssPresets);
                }
                if(data.myPersonaPresets){
                    await dataStorage.saveData('myPersonaPresets', data.myPersonaPresets);
                }
                if(data.globalCssPresets){
                    await dataStorage.saveData('globalCssPresets', data.globalCssPresets);
                }
                if(data.globalCss){
                    await dataStorage.saveData('globalCss', data.globalCss);
                }
                // if(data.customIcons){
                //     await dataStorage.saveData('customIcons', data.customIcons);
                // }
                // if(data.fontUrl){
                //     await dataStorage.saveData('fontUrl', data.fontUrl);
                // }
                // if(data.homeScreenMode){
                //     await dataStorage.saveData('homeScreenMode', data.homeScreenMode);
                // }
                // if(data.wallpaper){
                //     await dataStorage.saveData('wallpaper', data.wallpaper);
                // }

                // console.log(data)
                // console.log(db)

                // 保存基础数据
                await dataStorage.saveData('章鱼喷墨机', db);

                const duration = Date.now() - startTime;
                const message = `导入完成: ${importStats.charactersCount}个角色, ${importStats.groupsCount}个群组, ${importStats.messagesCount}条消息 (耗时${duration}ms)`;



                return {
                    success: true,
                    message: message,
                    stats: importStats,
                    duration: duration
                };

            } catch (error) {
                console.error('导入数据失败:', error);
                return {
                    success: false,
                    error: error.message,
                    duration: Date.now() - startTime
                };
            }
        }

        // 数据完整性验证
        async function validateDataIntegrity() {
            try {
                const issues = [];

                // 检查角色数据完整性
                for (const char of db.characters) {
                    const charData = await dataStorage.getData(`character_${char.id}`);
                    const messages = await dataStorage.getChatMessages(char.id, 'private');

                    if (!charData) {
                        issues.push(`角色 ${char.remarkName} 的基础数据缺失`);
                    }

                    if (char.history && char.history.length > 0 && messages.length === 0) {
                        issues.push(`角色 ${char.remarkName} 的消息历史未正确迁移`);
                    }
                }

                // 检查群组数据完整性
                for (const group of db.groups) {
                    const groupData = await dataStorage.getData(`group_${group.id}`);
                    const messages = await dataStorage.getChatMessages(group.id, 'group');

                    if (!groupData) {
                        issues.push(`群组 ${group.name} 的基础数据缺失`);
                    }

                    if (group.history && group.history.length > 0 && messages.length === 0) {
                        issues.push(`群组 ${group.name} 的消息历史未正确迁移`);
                    }
                }

                return {
                    isValid: issues.length === 0,
                    issues: issues
                };

            } catch (error) {
                return {
                    isValid: false,
                    issues: [`数据完整性验证失败: ${error.message}`]
                };
            }
        }

        // 重写原有的消息操作函数以使用优化存储
        const originalSaveData = saveData;
        window.saveData = async (data) => {
            // 对于频繁的消息操作，使用优化的存储方法
            if (currentChatId && (currentChatType === 'private' || currentChatType === 'group')) {
                const chat = currentChatType === 'private'
                    ? db.characters.find(c => c.id === currentChatId)
                    : db.groups.find(g => g.id === currentChatId);

                if (chat && chat.history) {
                    // 保存消息到优化存储
                    await dataStorage.saveChatMessages(currentChatId, currentChatType, chat.history);
                }
            }

            // 保存其他数据
            return originalSaveData(data);
        };
        
                function setupForumBindingFeature() {
            const forumLinkBtn = document.getElementById('forum-link-btn');
            const modal = document.getElementById('forum-binding-modal');
            const tabs = modal.querySelectorAll('.tab-btn');
            const contentPanes = modal.querySelectorAll('.forum-binding-content');
            const confirmBtn = document.getElementById('confirm-forum-binding-btn');

            // 1. 打开弹窗的事件监听
            forumLinkBtn.addEventListener('click', () => {
                openForumBindingModal();
            });

            // 2. 弹窗内的标签页切换逻辑
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有标签和内容的 active 状态
                    tabs.forEach(t => t.classList.remove('active'));
                    contentPanes.forEach(p => p.classList.remove('active'));

                    // 为点击的标签和对应内容添加 active 状态
                    tab.classList.add('active');
                    const targetId = tab.dataset.target;
                    document.getElementById(targetId).classList.add('active');
                });
            });

            // 3. 确认绑定按钮的事件监听
            confirmBtn.addEventListener('click', async () => {
                const worldBookList = document.getElementById('forum-worldbook-list');
                const charList = document.getElementById('forum-char-list');
                const userList = document.getElementById('forum-user-list');

                // 收集所有选中的ID
                const selectedWorldBookIds = Array.from(worldBookList.querySelectorAll('input:checked')).map(input => input.value);
                const selectedCharIds = Array.from(charList.querySelectorAll('input:checked')).map(input => input.value);
                const selectedUserPersonaIds = Array.from(userList.querySelectorAll('input:checked')).map(input => input.value);

                // 保存到db对象
                db.forumBindings = {
                    worldBookIds: selectedWorldBookIds,
                    charIds: selectedCharIds,
                    userPersonaIds: selectedUserPersonaIds,
                };

                await saveData();
                showToast('论坛绑定已更新');
                modal.classList.remove('visible');
            });

            function openForumBindingModal() {
                const worldBookList = document.getElementById('forum-worldbook-list');
                const charList = document.getElementById('forum-char-list');
                const userList = document.getElementById('forum-user-list');

                // 清空旧内容
                worldBookList.innerHTML = '';
                charList.innerHTML = '';
                userList.innerHTML = '';

                const currentBindings = db.forumBindings || { worldBookIds: [], charIds: [], userPersonaIds: [] };

                // 填充世界书列表
                if (db.worldBooks.length > 0) {
                    db.worldBooks.forEach(book => {
                        const isChecked = currentBindings.worldBookIds.includes(book.id);
                        const li = document.createElement('li');
                        li.className = 'binding-list-item';
                        li.innerHTML = `
                            <input type="checkbox" id="wb-bind-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}>
                            <label for="wb-bind-${book.id}">${book.name}</label>
                        `;
                        worldBookList.appendChild(li);
                    });
                } else {
                    worldBookList.innerHTML = '<li>暂无世界书设定</li>';
                }

                // 填充Char列表
                if (db.characters.length > 0) {
                    db.characters.forEach(char => {
                        const isChecked = currentBindings.charIds.includes(char.id);
                        const li = document.createElement('li');
                        li.className = 'binding-list-item';
                        li.innerHTML = `
                            <input type="checkbox" id="char-bind-${char.id}" value="${char.id}" ${isChecked ? 'checked' : ''}>
                            <label for="char-bind-${char.id}">${char.remarkName}</label>
                        `;
                        charList.appendChild(li);
                    });
                } else {
                    charList.innerHTML = '<li>暂无Char设定</li>';
                }

                // 填充User人设列表
                if (db.myPersonaPresets.length > 0) {
                    db.myPersonaPresets.forEach(preset => {
                        // user人设的ID就是它的name
                        const isChecked = currentBindings.userPersonaIds.includes(preset.name);
                        const li = document.createElement('li');
                        li.className = 'binding-list-item';
                        li.innerHTML = `
                            <input type="checkbox" id="user-bind-${preset.name.replace(/\s/g, '_')}" value="${preset.name}" ${isChecked ? 'checked' : ''}>
                            <label for="user-bind-${preset.name.replace(/\s/g, '_')}">${preset.name}</label>
                        `;
                        userList.appendChild(li);
                    });
                } else {
                    userList.innerHTML = '<li>暂无User人设预设</li>';
                }

                // 重置标签页到第一个
                tabs.forEach((tab, index) => {
                    tab.classList.toggle('active', index === 0);
                });
                contentPanes.forEach((pane, index) => {
                    pane.classList.toggle('active', index === 0);
                });


                // 显示弹窗
                modal.classList.add('visible');
            }
        }

// 在 setupForumFeature 函数的下面，新增这个函数
// 请用这个新版本完整替换旧的 renderPostDetail 函数
function renderPostDetail(post) {
    const detailScreen = document.getElementById('forum-post-detail-screen');
    if (!detailScreen || !post) return;

    // 为评论区的NPC生成随机头像颜色
    const npcColors = ["#FFB6C1", "#87CEFA", "#98FB98", "#F0E68C", "#DDA0DD", "#FFDAB9", "#B0E0E6"];
    const getRandomColor = () => npcColors[Math.floor(Math.random() * npcColors.length)];

    // --- 评论HTML生成 ---
    let commentsHtml = '';
    if (post.comments && post.comments.length > 0) {
        post.comments.forEach(comment => {
            const firstChar = comment.username.charAt(0).toUpperCase();
            commentsHtml += `
              <li class="comment-item">
                  <div class="comment-author-avatar" style="background-color: ${getRandomColor()}">${firstChar}</div>
                  <div class="comment-body">
                      <div class="comment-author-name">${comment.username}</div>
                      <div class="comment-content">${comment.content.replace(/\n/g, '<br>')}</div>
                      <div class="comment-timestamp">${comment.timestamp}</div>
                  </div>
              </li>
            `;
        });
    }

    // --- 整体页面HTML结构 ---
    const authorFirstChar = post.username.charAt(0).toUpperCase();
    detailScreen.innerHTML = `
    <header class="app-header">
        <button class="back-btn" data-target="forum-screen">‹</button>
        <div class="title-container">
            <h1 class="title">帖子详情</h1>
        </div>
        <button class="action-btn" id="header-share-btn" title="分享">
             <svg viewBox="0 0 24 24" fill="currentColor" width="22" height="22"><path d="M18,16.08C17.24,16.08 16.56,16.38 16.04,16.85L8.91,12.7C8.96,12.47 9,12.24 9,12C9,11.76 8.96,11.53 8.91,11.3L16.04,7.15C16.56,7.62 17.24,7.92 18,7.92C19.66,7.92 21,6.58 21,5C21,3.42 19.66,2 18,2C16.34,2 15,3.42 15,5C15,5.24 15.04,5.47 15.09,5.7L7.96,9.85C7.44,9.38 6.76,9.08 6,9.08C4.34,9.08 3,10.42 3,12C3,13.58 4.34,14.92 6,14.92C6.76,14.92 7.44,14.62 7.96,14.15L15.09,18.3C15.04,18.53 15,18.76 15,19C15,20.58 16.34,22 18,22C19.66,22 21,20.58 21,19C21,17.42 19.66,16.08 18,16.08Z"></path></svg>
        </button>
    </header>
    <main class="content">
        <div class="post-detail-container">
            <div class="post-detail-main">
                <div class="post-author-info">
                    <div class="author-avatar">${authorFirstChar}</div>
                    <div class="author-details">
                        <span class="author-name">${post.username}</span>
                        <span class="post-meta-data">${new Date(post.id.split('_')[1] * 1).toLocaleString()}</span>
                    </div>
                </div>
                <h2 class="post-detail-title">${post.title}</h2>
                <div class="post-detail-content-body">${post.content.replace(/\n/g, '<br>')}</div>
                <div class="post-detail-actions">
                    <div class="action-item">
                        <svg viewBox="0 0 24 24"><path d="M20,8H4V6H20V8M18,10H6V12H18V10M16,14H8V16H16V14M22,4V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V4A2,2 0 0,1 4,2H20A2,2 0 0,1 22,4Z" /></svg>
                        <span>${post.comments ? post.comments.length : 0}</span>
                    </div>
                    <div class="action-item">
                        <svg viewBox="0 0 24 24"><path d="M12.1,18.55L12,18.65L11.89,18.55C7.14,14.24 4,11.39 4,8.5C4,6.5 5.5,5 7.5,5C9.04,5 10.54,6 11.07,7.35H12.93C13.46,6 14.96,5 16.5,5C18.5,5 20,6.5 20,8.5C20,11.39 16.86,14.24 12.1,18.55M16.5,3C14.76,3 13.09,3.81 12,5.08C10.91,3.81 9.24,3 7.5,3C4.42,3 2,5.41 2,8.5C2,12.27 5.4,15.36 10.55,20.03L12,21.35L13.45,20.03C18.6,15.36 22,12.27 22,8.5C22,5.41 19.58,3 16.5,3Z" /></svg>
                        <span>${post.likeCount}</span>
                    </div>
                    <div class="action-item">
                        <svg viewBox="0 0 24 24"><path d="M13,9H18.5L13,3.5V9M6,2H14L20,8V20A2,2 0 0,1 18,22H6C4.89,22 4,21.1 4,20V4C4,2.89 4.89,2 6,2M15,18V16H6V18H15M18,14V12H6V14H18Z" /></svg>
                         <span>收藏</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="comments-section">
            <div class="comments-header">全部评论 (${post.comments ? post.comments.length : 0})</div>
            <ul class="comment-list">
                ${commentsHtml}
            </ul>
        </div>
    </main>`;

    // --- 给新生成的分享按钮绑定事件 ---
    const shareBtn = detailScreen.querySelector('#header-share-btn');
    if (shareBtn) {
        shareBtn.addEventListener('click', () => {
            openSharePostModal(post.id);
        });
    }
}




function setupForumFeature() {
    const refreshBtn = document.getElementById('forum-refresh-btn');
    const postsContainer = document.getElementById('forum-posts-container');
    const forumScreen = document.getElementById('forum-screen');
    const detailScreen = document.getElementById('forum-post-detail-screen');

    // 1. 刷新按钮的点击事件 (不变)
    refreshBtn.addEventListener('click', () => {
        handleForumRefresh();
    });

    // 2. 帖子列表卡片的点击事件 (不变)
    if (postsContainer) {
        postsContainer.addEventListener('click', (e) => {
            const card = e.target.closest('.forum-post-card[data-id]');
            if (card) {
                const postId = card.dataset.id;
                const post = db.forumPosts.find(p => p.id === postId);
                if (post) {
                    renderPostDetail(post);
                    switchScreen('forum-post-detail-screen');
                }
            }
        });
    }

    // 3. (修改) 监听详情页内部的点击事件，特别是右上角分享按钮
    if (detailScreen) {
        detailScreen.addEventListener('click', e => {
            // 监听新的分享按钮
            if (e.target.closest('#header-share-btn')) {
                const card = detailScreen.querySelector('.post-detail-card');
                const postId = card ? card.dataset.postId : null;
                if(postId) {
                    openSharePostModal(postId);
                }
            }
        });
    }

    // 4. 观察论坛屏幕的激活状态 (不变)
    const observer = new MutationObserver((mutations) => {
        for (let mutation of mutations) {
            if (mutation.attributeName === 'class') {
                const isActive = forumScreen.classList.contains('active');
                if (isActive) {
                    if (db.forumPosts && db.forumPosts.length > 0) {
                        renderForumPosts(db.forumPosts);
                    } else {
                        postsContainer.innerHTML = '<p class="placeholder-text" style="margin-top: 50px;">这里空空也...<br>点击右上角刷新按钮加载帖子吧！</p>';
                    }
                }
            }
        }
    });

    if (forumScreen) {
        observer.observe(forumScreen, { attributes: true });
    }
}

function setupShareModal() {
    const modal = document.getElementById('share-post-modal');
    const confirmBtn = document.getElementById('confirm-share-btn');
    const charList = document.getElementById('share-char-list');

    confirmBtn.addEventListener('click', async () => {
        const selectedCharIds = Array.from(charList.querySelectorAll('input:checked')).map(input => input.value);

        if (selectedCharIds.length === 0) {
            showToast('请至少选择一个分享对象。');
            return;
        }

        const postTitle = modal.dataset.postTitle;
        const postSummary = modal.dataset.postSummary;

        if (!postTitle || !postSummary) {
            showToast('无法获取帖子信息，分享失败。');
            return;
        }

        selectedCharIds.forEach(charId => {
            const character = db.characters.find(c => c.id === charId);
            if (character) {
                // 构建符合 AI 理解格式的文本消息
                const messageContent = `[论坛分享]标题：${postTitle}\n摘要：${postSummary}`;

                const message = {
                    id: `msg_${Date.now()}_${Math.random()}`,
                    role: 'user', // 作为用户发送的消息
                    content: messageContent,
                    parts: [{ type: 'text', text: messageContent }],
                    timestamp: Date.now()
                };

                character.history.push(message);
            }
        });

        await saveData();
        renderChatList(); // 刷新聊天列表以显示新消息预览
        modal.classList.remove('visible');
        showToast(`成功分享给 ${selectedCharIds.length} 位联系人！`);
    });
}

function openSharePostModal(postId) {
    const post = db.forumPosts.find(p => p.id === postId);
    if (!post) {
        showToast('找不到该帖子信息。');
        return;
    }

    const modal = document.getElementById('share-post-modal');
    const charList = document.getElementById('share-char-list');
    const detailsElement = modal.querySelector('details');

    // 将帖子信息存储在弹窗的 dataset 中
    modal.dataset.postTitle = post.title;
    modal.dataset.postSummary = post.summary;

    charList.innerHTML = ''; // 清空列表

    if (db.characters.length > 0) {
        db.characters.forEach(char => {
            const li = document.createElement('li');
            li.className = 'binding-list-item';
            li.innerHTML = `
                <input type="checkbox" id="share-to-${char.id}" value="${char.id}">
                <label for="share-to-${char.id}" style="display: flex; align-items: center; gap: 10px;">
                    <img src="${char.avatar}" alt="${char.remarkName}" style="width: 32px; height: 32px; border-radius: 50%;">
                    ${char.remarkName}
                </label>
            `;
            charList.appendChild(li);
        });
    } else {
        charList.innerHTML = '<li style="color: #888;">暂无可以分享的角色。</li>';
    }

    if(detailsElement) detailsElement.open = false;

    modal.classList.add('visible');
}


function getForumGenerationContext() {
    let context = "以下是论坛社区的背景设定和主要角色信息：\n\n";
    const bindings = db.forumBindings || { worldBookIds: [], charIds: [], userPersonaIds: [] };

    // 1. 添加世界观设定
    if (bindings.worldBookIds && bindings.worldBookIds.length > 0) {
        context += "===== 世界观设定 =====\n";
        bindings.worldBookIds.forEach(id => {
            const book = db.worldBooks.find(wb => wb.id === id);
            if (book) {
                context += `设定名: ${book.name}\n内容: ${book.content}\n\n`;
            }
        });
    }

    // 2. 添加角色人设
    if (bindings.charIds && bindings.charIds.length > 0) {
        context += "===== 主要角色人设 =====\n";
        bindings.charIds.forEach(id => {
            const char = db.characters.find(c => c.id === id);
            if (char) {
                context += `角色名: ${char.realName} (昵称: ${char.remarkName})\n人设: ${char.persona}\n\n`;
            }
        });
    }

    // 3. 添加用户人设
    if (bindings.userPersonaIds && bindings.userPersonaIds.length > 0) {
        context += "=====  (你) 的人设 =====\n";
        bindings.userPersonaIds.forEach(presetName => {
            const preset = db.myPersonaPresets.find(p => p.name === presetName);
            if (preset) {
                context += `人设名: ${preset.name}\n人设描述: ${preset.persona}\n\n`;
            }
        });
    }

    if (context.length < 50) { // 如果什么都没选
        return "没有提供任何特定的背景设定，请自由发挥，创作一些通用的、有趣有网感的论坛帖子。禁止以user或者char的视角制作帖子，发帖人只能是NPC";
    }

    return context;
}

async function handleForumRefresh() {
    const { url, key, model } = db.apiSettings;
    if (!url || !key || !model) {
        showToast('请先在API设置中配置好接口信息');
        switchScreen('api-settings-screen');
        return;
    }
    const refreshBtn = document.getElementById('forum-refresh-btn');
    const postsContainer = document.getElementById('forum-posts-container');

    // 新增：获取搜索输入框的引用
    const searchInput = document.getElementById('forum-search-input');

    refreshBtn.disabled = true;
    const spinner = `<div class="spinner" style="display: block; margin: 0 auto; border-top-color: var(--primary-color);"></div>`;
    postsContainer.innerHTML = `<p class="placeholder-text" style="margin-top: 50px;">正在生成论坛内容，请稍候...<br>${spinner}</p>`;

    try {
        const context = getForumGenerationContext();

        // 新增：获取搜索关键词
        const keywords = searchInput.value.trim();

        let systemPrompt = `你是一位专业的论坛内容生成专家，专门为指定世界观生成论坛帖子。
背景信息如下：
${context}

你的任务是读取背景世界观生成6到8篇风格各异、内容有趣的论坛帖子，每条帖子下面生成4~8条评论，每个帖子评论数量应该不一样，注意区分真实姓名和网名，注意user隐私，你的角色是“世界构建者”和“社区模拟器”，你需要分析char设定和user人设所处世界的世界观而不是“角色扮演者”，发帖人应该是该角色所处世界观下的其他NPC，发帖人不能是user。ABSOLUTELY DO NOT。若角色为普通人或需保密等神秘身份就禁止提及角色真实姓名，可以用代称或者暗号，只有当user或者char是公众人物名气大时才可以提及真实姓名。char的备注或者昵称是仅供user使用的，NPC不知道也禁止提及char的备注。若user和char不在一个地区就禁止有NPC目睹二人同框。

请严格按照下面的JSON格式返回，不要包含任何多余的解释和注释，仅返回JSON内容本身。禁止以user的视角进行创作。

返回格式示例:
{
  "posts": [
    {
      "title": "一个引人注目的帖子标题",
      "summary": "对帖子内容的客观的重点摘要，大约100字左右，DO NOT use first-person “我”",
      "content": "帖子的详细内容，150~300字。\\n可以使用换行符来分段落，注意排版。",
      "comments": [
        {
          "username": "路人（随机姓名）",
          "content": "这是第一条评论的内容，表达一个观点。",
          "timestamp": "5分钟前"
        },
        {
          "username": "（随机姓名）",
          "content": "这是第二条评论，可能反驳楼主或楼上的观点。",
          "timestamp": "3分钟前"
        }
      ]
    }
  ]
}`;

        // 新增：如果关键词存在，就把它加到系统指令里
        if (keywords) {
            systemPrompt += `\n\n重要指令：本次生成的所有帖子标题必须和以下关键词相关：【${keywords}】，同时也需要和之前绑定的设定相关。禁止相似帖子过多，不要特地把关键词标注出来。`;
        }


        const requestBody = {
            model: model,
            messages: [{ role: "user", content: systemPrompt }],
            temperature: 0.8,
            response_format: { type: "json_object" },
        };

        const endpoint = `${url}/v1/chat/completions`;
        const headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${key}` };

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`API 请求失败: ${response.status} ${await response.text()}`);
        }

        const result = await response.json();
        const contentStr = result.choices[0].message.content;

        const jsonData = JSON.parse(contentStr);
        if (jsonData && Array.isArray(jsonData.posts)) {
            const enhancedPosts = jsonData.posts.map(post => ({
              ...post,
              id: `post_${Date.now()}_${Math.random()}`,
              username: `楼主${Math.floor(100 + Math.random() * 900)}`, // 随机楼主
              likeCount: Math.floor(Math.random() * 200),
              shareCount: Math.floor(Math.random() * 50),
              comments: post.comments || []
   
            }));

            db.forumPosts = enhancedPosts;
            await saveData();
            renderForumPosts(db.forumPosts);

        } else {
            throw new Error("AI返回的数据格式不正确");
        }

    } catch (error) {
        console.error('刷新论坛内容失败:', error);
        postsContainer.innerHTML = `<p class="placeholder-text" style="margin-top: 50px;">生成失败了...<br><span style="font-size: 12px; color: #aaa;">${error.message}</span></p>`;
    } finally {
        refreshBtn.disabled = false;
    }
}


// 找到 renderForumPosts 函数，并用下面的代码替换它

function renderForumPosts(posts) {
    const postsContainer = document.getElementById('forum-posts-container');
    postsContainer.innerHTML = ''; // 清空旧内容

    if (!posts || posts.length === 0) {
        postsContainer.innerHTML = '<p class="placeholder-text" style="margin-top: 50px;">AI还没生成任何帖子，请点击刷新按钮。';
        return;
    }

    posts.forEach(post => {
        const card = document.createElement('div');
        card.className = 'forum-post-card';

        // --- 这就是关键的修复 ---
        // 为每个帖子卡片添加 data-id 属性
        card.dataset.id = post.id;
        // -----------------------

        // 使用 textContent 防止XSS攻击
        const titleEl = document.createElement('h3');
        titleEl.className = 'post-title';
        titleEl.textContent = post.title || '无标题';

        const summaryEl = document.createElement('p');
        summaryEl.className = 'post-summary';
        summaryEl.textContent = post.summary || '无摘要';

        // 注意：这里不再需要 post-content 元素，因为它在新页面显示
        // const contentEl = document.createElement('div');
        // contentEl.className = 'post-content';
        // contentEl.textContent = post.content || '无内容';

        card.appendChild(titleEl);
        card.appendChild(summaryEl);
        // card.appendChild(contentEl); // 移除这一行

        postsContainer.appendChild(card);
    });
}



        init();

        function renderPeekSteps(data) {
            const screen = document.getElementById('peek-steps-screen');
            const char = db.characters.find(c => c.id === currentChatId);
            if (!char) return; // 如果找不到角色，则不渲染

            const avatarEl = screen.querySelector('#steps-char-avatar');
            const nameEl = screen.querySelector('#steps-char-name');
            const currentStepsEl = screen.querySelector('#steps-current-count');
            const goalStepsEl = screen.querySelector('.steps-label');
            const progressRingEl = screen.querySelector('#steps-progress-ring');
            const trackListEl = screen.querySelector('#activity-track-list');
            const annotationEl = screen.querySelector('#steps-annotation-content');

            // 无论AI数据是否返回，都先渲染固定信息
            avatarEl.src = char.avatar;
            nameEl.textContent = char.realName;
            goalStepsEl.textContent = '/ 6000 步';

            if (!data) {
                // Display loading or empty state for dynamic content
                currentStepsEl.textContent = '----';
                trackListEl.innerHTML = '<li class="activity-track-item">正在生成活动轨迹...</li>';
                annotationEl.textContent = '正在生成角色批注...';
                progressRingEl.style.setProperty('--steps-percentage', 0);
                return;
            }

            // 填充AI返回的动态内容
            currentStepsEl.textContent = data.currentSteps;
            
            const percentage = (data.currentSteps / 6000) * 100;
            progressRingEl.style.setProperty('--steps-percentage', percentage);

            trackListEl.innerHTML = data.trajectory.map(item => `<li class="activity-track-item">${item}</li>`).join('');
            annotationEl.textContent = data.annotation;
        }

        function generatePeekContentPrompt(char, appType, mainChatContext) {
            const appNameMapping = {
                messages: "消息应用（模拟与他人的对话）",
                memos: "备忘录应用",
                cart: "电商平台的购物车",
                transfer: "文件传输助手（用于记录临时想法、链接等）",
                browser: "浏览器历史记录",
                drafts: "邮件或消息的草稿箱"
            };
            const appName = appNameMapping[appType] || appType;

            let prompt = `你正在模拟一个名为 ${char.realName} 的角色的手机内部信息。`;
            prompt += `该角色的核心人设是：${char.persona}。\n`;
            prompt += `最近，我（称呼为 ${char.myName}）和 ${char.realName} 的对话如下（这是你们关系和当前状态的核心参考）：\n---\n${mainChatContext}\n---\n`;
            prompt += `现在，我正在偷看Ta手机上的“${appName}”。请你基于Ta的人设和我们最近的聊天内容，生成符合该应用场景的、高度相关且富有沉浸感的内容。\n`;
            prompt += `你的输出必须是一个JSON对象，且只包含JSON内容，不要有任何额外的解释或标记。根据应用类型，JSON结构如下：\n`;

            switch (appType) {
                case 'messages':
                    prompt += `
                    {
                      "conversations": [
                        {
                          "partnerName": "与Ta对话的人的称呼",
                          "history": [
                            { "sender": "char", "content": "${char.realName}发送的消息内容" },
                            { "sender": "partner", "content": "对方发送的消息内容" }
                          ]
                        }
                      ]
                   }
                   请为 ${char.realName} 编造3-5个最近的对话。对话内容需要强烈反映Ta的人设以及和我的聊天上下文。`;
                    break;
                case 'steps':
                    prompt += `
                    {
                      "currentSteps": 8102,
                      "trajectory": [
                        "08:30 AM - 公司楼下咖啡馆",
                        "10:00 AM - 宠物用品店",
                        "12:00 PM - 附近日料店",
                        "03:00 PM - 回家路上的甜品店",
                        "04:00 PM - 楼下的便利店",
                        "06:30 PM - 健身房"
                      ],
                      "annotation": "角色对自己今天运动情况的批注"
                    }
                    请为 ${char.realName} 生成今天的步数信息。你只需要生成Ta的当前步数(currentSteps)，Ta的6条运动轨迹(trajectory)（禁止照搬示例）以及批注(annotation)。内容需要与Ta的人设和我们的聊天上下文高度相关。`;
                    break;
                case 'album':
                    prompt += `
                    {
                      "photos": [
                        { "type": "photo", "imageDescription": "对一张照片的详细文字描述，例如：一张傍晚在海边的自拍，背景是橙色的晚霞和归来的渔船。", "description": "角色对这张照片的一句话批注，例如：那天的风很舒服。" },
                        { "type": "video", "imageDescription": "对一段视频的详细文字描述，例如：一段在猫咖撸猫的视频，视频里有一只橘猫在打哈欠。", "description": "角色对这段视频的一句话批注，例如：下次还来这里！" }
                      ]
                    }
                    请为 ${char.realName} 的相册生成5-8个条目（照片或视频）。内容需要与Ta的人设和我们的聊天上下文高度相关。'imageDescription' 是对这张照片/视频的详细文字描述，它将代替真实的图片展示给用户。'description' 是 ${char.realName} 自己对这张照片/视频的一句话批注，会显示在描述下方。`;
                    break;
                case 'memos':
                    prompt += `
                    {
                      "memos": [
                        { "id": "memo_1", "title": "备忘录标题", "content": "备忘录内容，可以包含换行符\\n" }
                      ]
                    }
                    请生成3-4条备忘录，内容要与Ta的人设和我们的聊天上下文相关。`;
                    break;
                case 'cart':
                    prompt += `
                    {
                      "items": [
                        { "id": "cart_1", "title": "商品标题", "spec": "商品规格", "price": "25.00" }
                      ]
                    }
                    请生成3-4件商品，这些商品应该反映Ta的兴趣、需求或我们最近聊到的话题。`;
                    break;
                case 'browser':
                    prompt += `
                    {
                      "history": [
                        { "title": "网页标题", "url": "example.com/path", "annotation": "角色对于这条浏览记录的想法或批注" }
                      ]
                    }
                    请生成3-5条浏览记录。记录本身要符合Ta的人设和我们的聊天上下文，'annotation'字段则要站在角色自己的视角，记录Ta对这条浏览记录的想法或批注。`;
                    break;
                case 'drafts':
                    prompt += `
                    {
                      "draft": { "to": "${char.myName}", "content": "一封写给我但未发送的草稿内容，可以使用HTML的<span class='strikethrough'></span>标签来表示划掉的文字。" }
                    }
                    请生成一份Ta写给我但犹豫未决、未发送的草稿。内容要深刻、细腻，反映Ta的内心挣扎和与我的关系。`;
                    break;
               case 'transfer':
                   prompt += `
                   {
                     "entries": [
                       "要记得买牛奶。",
                       "https://example.com/interesting-article",
                       "刚刚那个想法不错，可以深入一下..."
                     ]
                   }
                   请为 ${char.realName} 生成4-7条Ta发送给自己的、简短零碎的消息。这些内容应该像是Ta的临时备忘、灵感闪现或随手保存的链接，要与Ta的人设和我们的聊天上下文相关，但比“备忘录”应用的内容更随意、更口语化。`;
                   break;
                default:
                    prompt += `{"error": "Unknown app type"}`;
                    break;
                case 'unlock':
                    prompt += `
                    {
                      "nickname": "角色的微博昵称",
                      "handle": "@角色的微博ID",
                      "bio": "角色的个性签名，可以包含换行符\\n",
                      "posts": [
                        { "timestamp": "2小时前", "content": "第一条微博正文内容，140字以内。" },
                        { "timestamp": "昨天", "content": "第二条微博正文内容。" },
                        { "timestamp": "3天前", "content": "第三条微博正文内容。" }
                      ]
                    }
                    请为 ${char.realName} 生成一个符合其人设的微博小号。你需要生成昵称、ID、个性签名，以及3-4条最近的微博。微博内容要生活化、碎片化，符合小号的风格，并与Ta的人设和我们的聊天上下文高度相关。`;
                    break;
            }
            return prompt;
        }

        async function generateAndRenderPeekContent(appType, options = {}) {
            const { forceRefresh = false } = options;

            if (generatingPeekApps.has(appType)) {
                showToast('该应用内容正在生成中，请稍候...');
                return;
            }

            // Check cache first
            if (!forceRefresh && peekContentCache[appType]) {
                const cachedData = peekContentCache[appType];
                switch (appType) {
                    case 'messages':
                        renderPeekChatList(cachedData.conversations);
                        switchScreen('peek-messages-screen');
                        break;
                    case 'album':
                        renderPeekAlbum(cachedData.photos);
                        switchScreen('peek-album-screen');
                        break;
                    case 'memos':
                        renderMemosList(cachedData.memos);
                        switchScreen('peek-memos-screen');
                        break;
                    case 'album':
                        renderPeekAlbum(cachedData.photos);
                        switchScreen('peek-album-screen');
                        break;
                   case 'transfer':
                       renderPeekTransferStation(cachedData.entries);
                       switchScreen('peek-transfer-station-screen');
                       break;
                    case 'cart':
                        renderPeekCart(cachedData.items);
                        switchScreen('peek-cart-screen');
                        break;
                    case 'browser':
                        renderPeekBrowser(cachedData.history);
                        switchScreen('peek-browser-screen');
                        break;
                    case 'drafts':
                        renderPeekDrafts(cachedData.draft);
                        switchScreen('peek-drafts-screen');
                        break;
                   case 'steps':
                      renderPeekSteps(cachedData);
                      switchScreen('peek-steps-screen');
                      break;
                   case 'unlock':
                       renderPeekUnlock(cachedData);
                       switchScreen('peek-unlock-screen');
                       break;
               }
               return; // Stop execution since we used cache
           }

            const char = db.characters.find(c => c.id === currentChatId);
            if (!char) return showToast('无法找到当前角色');

            const { url, key, model, provider } = db.apiSettings;
            if (!url || !key || !model) {
                showToast('请先在“api”应用中完成设置！');
                return switchScreen('api-settings-screen');
            }

            generatingPeekApps.add(appType); // Lock this specific app
            let targetContainer;

            // Show loading state
            switch (appType) {
                case 'messages':
                    switchScreen('peek-messages-screen');
                    targetContainer = document.getElementById('peek-chat-list-container');
                    targetContainer.innerHTML = '<p class="placeholder-text">正在生成对话列表...</p>';
                    break;
                case 'album':
                    switchScreen('peek-album-screen');
                    renderPeekAlbum([]); // 渲染空状态，会显示“正在生成...”
                    break;
                case 'memos':
                    switchScreen('peek-memos-screen');
                    renderMemosList([]); // Render empty state with loading text
                    break;
               case 'transfer':
                   switchScreen('peek-transfer-station-screen');
                   renderPeekTransferStation([]);
                   break;
                case 'cart':
                    switchScreen('peek-cart-screen');
                    renderPeekCart([]);
                    break;
                case 'browser':
                    switchScreen('peek-browser-screen');
                    renderPeekBrowser([]);
                    break;
                case 'drafts':
                    switchScreen('peek-drafts-screen');
                    renderPeekDrafts(null);
                    break;
                case 'steps':
                    switchScreen('peek-steps-screen');
                    renderPeekSteps(null); // Render empty state
                    break;
               case 'unlock':
                   switchScreen('peek-unlock-screen');
                   renderPeekUnlock(null); // Render empty/loading state
                   break;
               default:
                   showToast('无法打开');
                   generatingPeekApps.delete(appType); // Unlock if app is invalid
                   return;
           }

            try {
                const mainChatContext = char.history.slice(-10).map(m => m.content).join('\n');
                const systemPrompt = generatePeekContentPrompt(char, appType, mainChatContext);
                
                const requestBody = {
                    model: model,
                    messages: [{ role: 'user', content: systemPrompt }],
                    temperature: 0.8,
                    top_p: 0.9,
                };

                const endpoint = `${url}/v1/chat/completions`;
                const headers = { 'Content-Type': 'application/json', Authorization: `Bearer ${key}` };

                const response = await fetch(endpoint, { method: 'POST', headers: headers, body: JSON.stringify(requestBody) });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
                
                const result = await response.json();
                const contentStr = result.choices[0].message.content;
                
                const jsonMatch = contentStr.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("AI响应中未找到有效的JSON对象。");
                
                const generatedData = JSON.parse(jsonMatch[0]);

                // --- NEW: Strict data validation ---
                let isValid = false;
                switch (appType) {
                    case 'messages': isValid = generatedData && Array.isArray(generatedData.conversations); break;
                    case 'memos': isValid = generatedData && Array.isArray(generatedData.memos); break;
                    case 'album': isValid = generatedData && Array.isArray(generatedData.photos); break;
                    case 'cart': isValid = generatedData && Array.isArray(generatedData.items); break;
                    case 'transfer': isValid = generatedData && Array.isArray(generatedData.entries); break;
                    case 'browser': isValid = generatedData && Array.isArray(generatedData.history); break;
                    case 'drafts': isValid = generatedData && generatedData.draft; break;
                    case 'steps': isValid = generatedData && generatedData.currentSteps !== undefined; break;
                    case 'unlock': isValid = generatedData && generatedData.nickname && Array.isArray(generatedData.posts); break;
                    default: isValid = false;
                }

                if (!isValid) {
                    throw new Error("AI返回的数据格式不符合应用要求。");
                }
                // --- END: Strict data validation ---

                // Store in cache
                peekContentCache[appType] = generatedData;

                // Render content based on app type
                if (appType === 'messages') {
                    renderPeekChatList(generatedData.conversations);
                } else if (appType === 'memos') {
                    renderMemosList(generatedData.memos);
                } else if (appType === 'album') {
                    renderPeekAlbum(generatedData.photos);
                } else if (appType === 'transfer') {
                   renderPeekTransferStation(generatedData.entries);
                } else if (appType === 'cart') {
                    renderPeekCart(generatedData.items);
                } else if (appType === 'browser') {
                    renderPeekBrowser(generatedData.history);
                } else if (appType === 'drafts') {
                    renderPeekDrafts(generatedData.draft);
                } else if (appType === 'steps') {
                    renderPeekSteps(generatedData);
                } else if (appType === 'unlock') {
                    renderPeekUnlock(generatedData);
                }

            } catch (error) {
                console.error('生成偷看内容失败:', error);
                // Clear cache for this app on failure
                delete peekContentCache[appType];
                const errorMessage = "内容生成失败，AI返回格式错误，请手动刷新重试。";
                showToast(errorMessage);
                if (appType === 'album') {
                    document.querySelector('#peek-album-screen .album-grid').innerHTML = `<p class="placeholder-text">内容生成失败，请刷新重试</p>`;
                } else if (appType === 'unlock') {
                    document.getElementById('peek-unlock-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="peek-screen">‹</button><div class="title-container"><h1 class="title">错误</h1></div><button class="action-btn">···</button></header><main class="content"><p class="placeholder-text">${errorMessage}</p></main>`;
                } else if (targetContainer) {
                    targetContainer.innerHTML = `<p class="placeholder-text">${errorMessage}</p>`;
                }
            } finally {
                generatingPeekApps.delete(appType); // Release the lock for this specific app
            }
        }

        function renderPeekSettings() {
            const character = db.characters.find(c => c.id === currentChatId);
            if (!character) return;

            const peekSettings = character.peekScreenSettings || { wallpaper: '', customIcons: {}, unlockAvatar: '' };

            // Populate wallpaper
            document.getElementById('peek-wallpaper-url-input').value = peekSettings.wallpaper || '';

            const iconsContainer = document.getElementById('peek-app-icons-settings');
            iconsContainer.innerHTML = '';

            Object.keys(peekScreenApps).forEach(appId => {
                const app = peekScreenApps[appId];
                const currentIcon = peekSettings.customIcons?.[appId] || app.url;

                const itemEl = document.createElement('div');
                itemEl.className = 'icon-custom-item';
                itemEl.innerHTML = `
                    <img src="${currentIcon}" alt="${app.name}" class="icon-preview">
                    <div class="icon-details">
                        <p>${app.name}</p>
                        <input type="url" class="form-group" data-app-id="${appId}" placeholder="粘贴新的图标URL" value="${peekSettings.customIcons?.[appId] || ''}">
                    </div>
                    <input type="file" id="peek-icon-upload-${appId}" data-app-id="${appId}" accept="image/*" style="display:none;">
                    <label for="peek-icon-upload-${appId}" class="btn btn-small btn-neutral" style="font-size: 12px;">上传</label>
                `;
                iconsContainer.appendChild(itemEl);
            });

            // Add event listeners for all new upload buttons
            iconsContainer.querySelectorAll('input[type="file"]').forEach(uploadInput => {
                uploadInput.addEventListener('change', handlePeekIconUpload);
            });
            
            // Populate unlock avatar url
            document.getElementById('peek-unlock-avatar-url').value = peekSettings.unlockAvatar || '';
        }

        async function handlePeekIconUpload(e) {
            const file = e.target.files[0];
            const appId = e.target.dataset.appId;
            if (file && appId) {
                try {
                    const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 120, maxHeight: 120 });
                    const urlInput = document.querySelector(`#peek-app-icons-settings input[data-app-id="${appId}"]`);
                    const previewImg = urlInput.closest('.icon-custom-item').querySelector('.icon-preview');
                    if (urlInput) {
                        urlInput.value = compressedUrl;
                    }
                    if (previewImg) {
                        previewImg.src = compressedUrl;
                    }
                    showToast(`${peekScreenApps[appId].name} 图标已上传并压缩`);
                } catch (error) {
                    showToast('图标压缩失败，请重试');
                }
            }
        }

    });
</script>
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(registration => {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, err => {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }
    
</script>
</body>

</html>
